# 零、其他

## 1.工具

submit_text:

​		ctrl + f: 搜索

​		ctrl + h: 替换

​        ctrl +enter ： 让光标定位到匹配到的字符后

​		ctrl + a：全选

​		ctrl + shift + l :  将光标定位到所有选中行的末尾



去除空行：

- CTRL+H打开replace功能，勾选上左侧的regular expression，并填写
- find what栏 : \s+$ （正则表达式）
- replace with栏 : （这行留空）
- 接着点replace all即可



## 2.分区

| 分层                 | 分区                                                         | 表                                                           |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ods_log              | 根据采集的数据的日期分区                                     |                                                              |
| ods_db               | 根据采集的数据的日期分区                                     |                                                              |
| dim                  | 根据采集的维度数据的日期分区                                 |                                                              |
|                      |                                                              | dim_user_info:  将最新的数据放入9999-99-99分区，将历史数据，放入end_date所在的分区 |
| dwd_log              | 根据采集的用户行为数据的日期分区                             |                                                              |
| dwd_事务型事实表     | 根据事实发生的日期进行分区                                   | dwd_order_detail(下单的create_time),dwd_refund_order_info(退单的create_time),dwd_comment_info(评论的create_time) |
| dwd_周期快照事实表   | 根据事实采集的周期进行分区                                   | 每天采集一次，分区按照采集的日期进行分区。dwd_cart_info,dwd_favor_info |
| dwd_累积型快照事实表 | 根据事实生命周期是否结束(完成)分区。完成，分到当天的分区，未完成，分到9999-99-99分区 | dwd_payment_info: 根据callback_time是否为null区分是否完成。callback_time不为null的，放入callback_time所在日期的分区，callback_time为null的放入9999-99-99分区 |
|                      |                                                              | dwd_refund_payment: 根据callback_time是否为null区分是否完成。callback_time不为null的，放入callback_time所在日期的分区，callback_time为null的放入9999-99-99分区 |
|                      |                                                              | dwd_coupon_use:  过期和支付是完成，放入当日的分区，否则都是未完成，放入9999-99-99分区 |
|                      |                                                              | dwd_order_info:  根据订单状态和是否过期判断。过期放入当日过期日期的分区，未过期，根据订单的状态，如果是1003,1004,1006放入当日完成的分区。如果是1001,1002,1005放入dt=9999-99-99分区 |
| dws                  | 按天聚合。以某个维度为中心，统计一天中，这个围绕维度产生的各种事实。例如商品维度，统计商品一天中被下单，支付，收藏，加购，评论等各种事实。分区按照统计的维度数据的事实的日期分区。 |                                                              |
|                      |                                                              |                                                              |
|                      |                                                              |                                                              |
|                      |                                                              |                                                              |

用户行为：

业务数据：

# 一、ODS层

## 0.建模

特点：  保持数据原始，不做任何修改。采集的是什么样，导入的数据就是什么样。



采集的数据的过程：

​			①采集的频率：   1天1次

​			②采集的数据文件的格式：  

​							用户行为日志：   TEXTFILE + 压缩(lzo)

​							业务数据：             TEXTFILE + 压缩(lzo)

​			③采集的数据的内容

​								用户行为日志：  每行就是一条用户产生的行为，json字符串

​								业务数据：      20多张表，每张表单独存放在一个目录中，每个目录中的文件

​														中字段的分隔符是  \t 

​														字段的数量和类型，因表而异，不同的表采集的字段数量和类型不一样



ODS建模重点： 参照采集的数据进行建模。



```sql
create  external  table  ods_log(
	content  string
)
location  'hdfs://hadoop102:9820//warehouse/gmall/ods/ods_log'
```

external table ：外部表(要求)。 drop table时，只删mysql中的元数据，不影响HDFS表目录中的数据！

managed table : 内部表，管理表。 将元数据和数据一起删除。



location: 指定表中数据存储的位置



--------

```sql
create  external  table  ods_log(
	content  string
)
partition by (dt string)
--STORE AS TEXTFILE（默认） | SequenceFile | ORC | parquet
STORED AS -- 指定存储方式，读数据采用LzoTextInputFormat；
  INPUTFORMAT 'com.hadoop.mapred.DeprecatedLzoTextInputFormat'
  OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
  
```

读数据 -------------> 计算程序处理--------------> 写结果



InputFormat： 输入的数据的格式。

​									默认： TextInputFormat:  文本文件格式

​													SequenceFileFormat:  	SequenceFile 文件格式

​													DBInputFormat ： 数据库数据格式



为什么要为表设置InputFormat和OutputFormat：

select  :   读取表中的数据，进行分析。

​					每张表的InputFormat，都是为select语句解析使用。



insert：  将数据写入到表目录中

​					每张表的OutputFormat，都是为insert语句解析使用。





load 

---

InputFormat和OutputFormat取决于表中的数据文件格式。

TEXTFILE：

InputFormat:        	org.apache.hadoop.mapred.TextInputFormat	 

OutputFormat:       	org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat





ORC：

InputFormat:        	org.apache.hadoop.hive.ql.io.orc.OrcInputFormat	 
OutputFormat:       	org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat



PARQUET：

InputFormat:        	org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat	 
OutputFormat:       	org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat	

## 1.ods_log

### 1.1建表

```sql
drop table if exists ods_log;
CREATE EXTERNAL TABLE ods_log (`line` string)
PARTITIONED BY (`dt` string) -- 按照时间创建分区
STORED AS -- 指定存储方式，读数据采用LzoTextInputFormat；
  INPUTFORMAT 'com.hadoop.mapred.DeprecatedLzoTextInputFormat'
  OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION '/warehouse/gmall/ods/ods_log'  -- 指定数据在hdfs上的存储位置
;
```



### 1.2 导入数据

```sql
load  data inpath '/origin_data/gmall/log/topic_log/2021-05-07'
overwrite into table ods_log  partition(dt='2021-05-07')
```



建索引：

```shell
hadoop jar /opt/module/hadoop-3.1.3/share/hadoop/common/hadoop-lzo-0.4.20.jar com.hadoop.compression.lzo.DistributedLzoIndexer /warehouse/gmall/ods/ods_log/dt=2021-05-07
```



local : 从本地将文件上传到Hdfs表目录
		不加local,从hdfs的一个目录移动到表目录
		

​	lzo 支持切片，需要借助index文件切片，如果没有索引文件，只切1片(不切片)



## 2.引号

主要看最外层是什么引号，如果最外侧是单引号，此时不支持脱义，$AAA, 不做解析！

如果最外侧是双引号，此时支持脱义，$AAA, 会引用AAA变量的值！



在HQL中，字符串，一律使用单引号，不要使用双引号。



## 3.业务数据导入

业务数据，分为两类，一类是采集的全量的存量数据，另一类是每天导入的数据！



虽然分了两类，但是ODS的特点是不做任何处理！因此哪一天采集的数据，就放入哪一天的ODS的分区！



首日同步时，比每日同步多同步了2张表： base_province,base_region!



处理每一层数据时，必须明确：

​			用户行为数据：  不存在存量(历史)数据，数仓在开发时，需要统计什么行为，让app开发人员埋点收集。

​            业务数据：  在数仓开发之前，业务系统已经运行了一段，已经产生了存量数据。

​									在数据上线的第一天，将存量数据，全部导入到当天的分区中。

​										/origin_data/gmall/db/activity_info/2021-05-07 存放的是  业务系统上线 ------------到2021-05-07，

​								之后每天，只需要采集当天业务系统产生的数据：/origin_data/gmall/db/activity_info/2021-05-08 存放的就是 2021-05-08产生的数据





**解决思路**： 只需要编写一个脚本，每日同步和首日同步思路一样，都是直接load。 手动将 base_province,base_region导入到ods层。



手动导入：

```sql
load data inpath '/origin_data/gmall/db/base_province/2021-05-07' OVERWRITE into table ods_base_province;
load data inpath '/origin_data/gmall/db/base_region/2021-05-07' OVERWRITE into table ods_base_region;
```





# 二、DIM层

## 0.建模思路

承接ODS层，将ODS层所有的维度表，按照类别进行划分，同一类别的维度表进行降维处理。



降维处理：N张维度表中的字段 汇总到 1张维度表



**分类**：

​			活动类：  ods_activity_info   ods_activity_rule

​			商品类：  ods_base_category1，ods_base_category2，ods_base_category3，ods_base_trademark，

ods_sku_attr_value，ods_sku_sale_attr_value，ods_sku_info，ods_spu_info

​			字典类(dim层不建表)：  ods_base_dic

​			地区类：  ods_base_province，ods_base_region

​			优惠券类： ods_coupon_info

​			用户类：  ods_user_info

​			日期类：  手动导入



降维后：  6张



操作方式： join

​			

```sql
CREATE EXTERNAL TABLE dim_coupon_info(
    `id` STRING COMMENT '购物券编号',
    `coupon_name` STRING COMMENT '购物券名称',
    `coupon_type` STRING COMMENT '购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券',
    `condition_amount` DECIMAL(16,2) COMMENT '满额数',
    `condition_num` BIGINT COMMENT '满件数',
    `activity_id` STRING COMMENT '活动编号',
    `benefit_amount` DECIMAL(16,2) COMMENT '减金额',
    `benefit_discount` DECIMAL(16,2) COMMENT '折扣',
    `create_time` STRING COMMENT '创建时间',
    `range_type` STRING COMMENT '范围类型 1、商品 2、品类 3、品牌',
    `limit_num` BIGINT COMMENT '最多领取次数',
    `taken_count` BIGINT COMMENT '已领取次数',
    `start_time` STRING COMMENT '可以领取的开始日期',
    `end_time` STRING COMMENT '可以领取的结束日期',
    `operate_time` STRING COMMENT '修改时间',
    `expire_time` STRING COMMENT '过期时间'
) COMMENT '优惠券维度表'
PARTITIONED BY (`dt` STRING)
STORED AS PARQUET
LOCATION '/warehouse/gmall/dim/dim_coupon_info/'
TBLPROPERTIES ("parquet.compression"="lzo");
```



parquet 能不能切片：  可以

​		parquet + lzo 可以切片 

​		parquet + deflate 能不能切片？  可以切片！

​		parquet + lzo



ORC也可以切片，和使用的压缩格式无关！

​		orc + snappy

## 1.DIM层导数思路

思路：

① 找到和当前维度相关的所有的ODS层的维度表

② 根据维度表的结构判断 DIM层表中的字段可以从哪些ods层表中获取

③确定DIM层表的主体(粒度)

​			一行代表一个商品，主体是商品

④根据粒度和主体确定Join方式

​			主体表   left join   其他表



## 2.函数的使用

HQL：  可以使用Hive提供的函数

https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF



​			

## 3.dim_sku_info

### 3.0 Join

inner Join ： 内连接，取两个结果集的交集(共用的部分，连接上的部分)

left join(建议):  取左表的全部，和右表中连接上的内容

right join: 取右表的全部，和左表中连接上的内容

full join :  取左右两表的全部。关联上的部分会进行关联。

​						mysql不支持。

​		

### 3.1 建表

主体：  商品

粒度：  一行代表一个商品的所有信息



如何Join?

ods_sku_info  left join 其他表

```sql
DROP TABLE IF EXISTS dim_sku_info;
CREATE EXTERNAL TABLE dim_sku_info (
    --ods_sku_info
    `id` STRING COMMENT '商品id',
    `price` DECIMAL(16,2) COMMENT '商品价格',
    `sku_name` STRING COMMENT '商品名称',
    `sku_desc` STRING COMMENT '商品描述',
    `weight` DECIMAL(16,2) COMMENT '重量',
    `is_sale` BOOLEAN COMMENT '是否在售',
    `spu_id` STRING COMMENT 'spu编号',
    --ods_spu_info
    `spu_name` STRING COMMENT 'spu名称',
    --ods_base_category1，ods_base_category2，ods_base_category3
    `category3_id` STRING COMMENT '三级分类id',
    `category3_name` STRING COMMENT '三级分类名称',
    `category2_id` STRING COMMENT '二级分类id',
    `category2_name` STRING COMMENT '二级分类名称',
    `category1_id` STRING COMMENT '一级分类id',
    `category1_name` STRING COMMENT '一级分类名称',
     --ods_sku_info
    `tm_id` STRING COMMENT '品牌id',
    --ods_base_trademark
    `tm_name` STRING COMMENT '品牌名称',
    --ods_sku_attr_value
    --  [struct1 ,struct2,struct3,..  ]
    `sku_attr_values` ARRAY<STRUCT<attr_id:STRING,value_id:STRING,attr_name:STRING,value_name:STRING>> COMMENT '平台属性',
    --ods_sku_sale_attr_value
    `sku_sale_attr_values` ARRAY<STRUCT<sale_attr_id:STRING,sale_attr_value_id:STRING,sale_attr_name:STRING,sale_attr_value_name:STRING>> COMMENT '销售属性',
    --ods_sku_info
    `create_time` STRING COMMENT '创建时间'
) COMMENT '商品维度表'
PARTITIONED BY (`dt` STRING)
STORED AS PARQUET
LOCATION '/warehouse/gmall/dim/dim_sku_info/'
TBLPROPERTIES ("parquet.compression"="lzo");
```

### 3.2 函数介绍

| Constructor Function | Operands                          | Description                                                  |
| :------------------- | :-------------------------------- | :----------------------------------------------------------- |
| map                  | (key1, value1, key2, value2, ...) | Creates a map with the given key/value pairs.                |
| struct               | (val1, val2, val3, ...)           | 根据传入的多个值，生成struct，字段名由系统指定col1-coln      |
| named_struct         | (name1, val1, name2, val2, ...)   | Creates a struct with the given field names and values. (As of Hive [0.8.0](https://issues.apache.org/jira/browse/HIVE-1360).) |
| array                | (val1, val2, ...)                 | Creates an array with the given elements.                    |



```sql
--生成struct  struct格式：  [{"name":"jack","age":23,"gender":"F"}]  [{属性名:属性值...}]
--取值：  struct.属性名
SELECT  struct('jack',23,'F');

SELECT  named_struct('name','jack','age',23,'gender','F');


--构造数组  array格式：["1","2","3","a","4"]    [元素1,...]
--取值：  array[index]
SELECT  array(1,2,3,'a',4)

--构造map  map格式 {"name":"jack","age":"23","gender":"F"}  {k1:v1,...}
-- 取值： map[key]
select map('name','jack','age',23,'gender','F') 
```



行转列函数：

​	collect_list(列名)： 将一列的数据，封装为Array，不去重，返回Array

​	collect_set(列名) ：  将一列的数据，封装为Array，去重，返回Array

### 3.3 with--as

```
with 
临时表名1 as  (),
临时表名2 as  (),
临时表名3 as  ()
xxx语句


```

### 3.4 数据导入

```sql
--导入2021-05-07
with
sku_info as
(
  select
     *
  from ods_sku_info 
  -- 截至到5-7商城中全部的商品
  where dt='2021-05-07'

),
spu_info as
(
  select
     id ,spu_name 
  from ods_spu_info 
  -- 截至到5-7商城中全部的商品的spu信息
  where dt='2021-05-07'

),
category1 as
(
  select
     id category1_id,name category1_name
  from ods_base_category1 
  -- 截至到5-7商城中全部的商品的1级分类信息
  where dt='2021-05-07'

),
category2 as
(
  select
     id category2_id,name category2_name,category1_id
  from ods_base_category2 
  -- 截至到5-7商城中全部的商品的2级分类信息
  where dt='2021-05-07'

),
category3 as
(
  select
     id category3_id,name category3_name,category2_id
  from ods_base_category3 
  -- 截至到5-7商城中全部的商品的3级分类信息
  where dt='2021-05-07'

),
tm_info as
(
  select
     id tm_id,tm_name
  from ods_base_trademark 
  -- 截至到5-7商城中全部的商品的品牌信息
  where dt='2021-05-07'

),
sku_attr_value as
(
	
select
    sku_id ,collect_list(named_struct('attr_id',attr_id,'value_id',value_id,'attr_name',attr_name,'value_name',value_name)) sku_attr_values
  from ods_sku_attr_value 
  -- 截至到5-7商城中全部的商品的sku平台属性
  where dt='2021-05-07'
  GROUP  by sku_id 

),
sku_sale_attr_value as
(
	
select
    sku_id ,collect_list(named_struct('sale_attr_id',sale_attr_id,'sale_attr_value_id',sale_attr_value_id,'sale_attr_name',sale_attr_name,'sale_attr_value_name',sale_attr_value_name)) sku_sale_attr_values
  from ods_sku_sale_attr_value 
  -- 截至到5-7商城中全部的商品的sku平台属性
  where dt='2021-05-07'
  GROUP  by sku_id 

)
--只要向分区表写数据，不影响其他分区，都使用overwrite，可以避免数据错误重新导入数据造成的数据重复问题
insert overwrite TABLE  dim_sku_info  partition(dt='2021-05-07')
SELECT 
   --插入时要注意字段的顺序, 如果有重名的字段，需要指定表名
   	     sku_info.id,
		 price,
		 sku_name,
		 sku_desc,
		 weight,
		 is_sale,
		 sku_info.spu_id,
		 spu_name,
		 sku_info.category3_id,
		 category3_name,
		 category2.category2_id,
		 category2_name,
		 category1.category1_id,
		 category1_name,
		 sku_info.tm_id,
		 tm_name,
		 sku_attr_values,
		 sku_sale_attr_values,
		 create_time
from  sku_info 
left join spu_info on sku_info.spu_id = spu_info.id
left join  category3 on sku_info.category3_id = category3.category3_id
left join category2 on category2.category2_id = category3.category2_id
left join category1 on category1.category1_id = category2.category1_id
left join tm_info on sku_info.tm_id = tm_info.tm_id
left join sku_attr_value on sku_info.id=sku_attr_value.sku_id
left join sku_sale_attr_value on sku_info.id=sku_sale_attr_value.sku_id
```



## 4.dim_coupon_info

主体：优惠券

粒度：一行代表一种优惠券

### 4.1 建表

```sql
DROP TABLE IF EXISTS dim_coupon_info;
CREATE EXTERNAL TABLE dim_coupon_info(
    -- ods_coupon_info
    `id` STRING COMMENT '购物券编号',
    `coupon_name` STRING COMMENT '购物券名称',
    `coupon_type` STRING COMMENT '购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券',
    `condition_amount` DECIMAL(16,2) COMMENT '满额数',
    `condition_num` BIGINT COMMENT '满件数',
    `activity_id` STRING COMMENT '活动编号',
    `benefit_amount` DECIMAL(16,2) COMMENT '减金额',
    `benefit_discount` DECIMAL(16,2) COMMENT '折扣',
    `create_time` STRING COMMENT '创建时间',
    `range_type` STRING COMMENT '范围类型 1、商品 2、品类 3、品牌',
    `limit_num` BIGINT COMMENT '最多领取次数',
    `taken_count` BIGINT COMMENT '已领取次数',
    `start_time` STRING COMMENT '可以领取的开始日期',
    `end_time` STRING COMMENT '可以领取的结束日期',
    `operate_time` STRING COMMENT '修改时间',
    `expire_time` STRING COMMENT '过期时间'
) COMMENT '优惠券维度表'
PARTITIONED BY (`dt` STRING)
STORED AS PARQUET
LOCATION '/warehouse/gmall/dim/dim_coupon_info/'
TBLPROPERTIES ("parquet.compression"="lzo");
```



### 4.2 数据导入

默认需要打开动态分区的开关。

```sql
set hive.exec.dynamic.partition.mode=nonstrict;
INSERT overwrite table dim_coupon_info partition(dt)
SELECT 
	*
	from ods_coupon_info 
	where dt='2021-05-07'
```



### 4.3 动态分区和静态分区

动态分区和静态分区的作用都是向分区表插入数据，使用的场景不同。



静态分区： 分区字段的值，在insert xxx  partition(分区字段名=分区字段值)，

​					查询的所有数据，都是固定向指定的分区写入。

​					查询的列数(无需查询分区字段值) + 1 = 目标表的列数



动态分区：  需要将一批数据，写入到多个不同的分区

​						 分区字段的值，不写在insert xxx  partition(分区字段名)，

​							通过将分区字段值，作为查询字段的最后一列，指定分区。

​							查询的列数 = 目标表的列数



如果向一个固定的分区中写数据，可以使用静态分区，也可以使用动态分区！

如果向多个分区写一批数据，只能使用动态分区！





## 5.dim_activity_rule_info

一个活动可以有多个活动规则

1个 activity_id 对应 多个 N 个activity_rule_id

如果有1对N的关系，通常取最细的粒度。



粒度： 一个活动的一条规则

### 5.1 建表

```sql
DROP TABLE IF EXISTS dim_activity_rule_info;
CREATE EXTERNAL TABLE dim_activity_rule_info(
    `activity_rule_id` STRING COMMENT '活动规则ID',
    `activity_id` STRING COMMENT '活动ID',
    `activity_name` STRING  COMMENT '活动名称',
    `activity_type` STRING  COMMENT '活动类型',
    `start_time` STRING  COMMENT '开始时间',
    `end_time` STRING  COMMENT '结束时间',
    `create_time` STRING  COMMENT '创建时间',
    `condition_amount` DECIMAL(16,2) COMMENT '满减金额',
    `condition_num` BIGINT COMMENT '满减件数',
    `benefit_amount` DECIMAL(16,2) COMMENT '优惠金额',
    `benefit_discount` DECIMAL(16,2) COMMENT '优惠折扣',
    `benefit_level` STRING COMMENT '优惠级别'
) COMMENT '活动信息表'
PARTITIONED BY (`dt` STRING)
STORED AS PARQUET
LOCATION '/warehouse/gmall/dim/dim_activity_rule_info/'
TBLPROPERTIES ("parquet.compression"="lzo");
```







### 5.2 数据导入

```
insert overwrite table dim_activity_rule_info partition(dt='2021-05-07')
SELECT 
	t1.id activity_rule_id, activity_id, activity_name, t1.activity_type, start_time, 
	end_time, create_time, condition_amount, condition_num, benefit_amount,
	benefit_discount, benefit_level
	from
(select 
   * 
 from ods_activity_rule 
 where dt='2021-05-07' ) t1
 left JOIN 
 (select 
    * 
  from ods_activity_info 
  where dt='2021-05-07' ) t2
  on t1.activity_id=t2.id;
```



### 5.3 ods层读数不准

#### 5.3.1 解决方案

当查询的hive表，使用 lzo压缩，且有index文件时，为了读数精确，需要设置

```
SET hive.input.format=org.apache.hadoop.hive.ql.io.HiveInputFormat;
```



#### 5.3.2 现象

```sql
 hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat;

--1行（正确）
SELECT 
	*
from ods_activity_info
where dt='2021-05-07'

--2行
SELECT 
	count(*)
from ods_activity_info
where dt='2021-05-07'

--CombineHiveInputFormat 是hive在0.x版本推出的，目的是为了解决小文件的切片问题。
切片： 将输入路径中的所有的文件，统计总的大小，将总大小按照 切片大小切片。 索引文件也会被切片。

-- HiveInputFormat ： 早期hive自带的版本。 在切片时，会调用table的输入格式进行切片
   ods_activity_info.DeprecatedLzoTextInputFormat 切片时，会自动识别index文件，只将 .lzo文件切片
   
-- 将输入格式由CombineHiveInputFormat 改为 HiveInputFormat 有没有影响？  没有影响，不存在小文件。

```

读数错误的原因： 表目录，只能放入数据文件，放入的其他文件都会被当作数据读取。

​			ods_activity_info表目录，既有数据，还有辅助切片的索引文件，将索引误认为是数据后，造成统计不准。



InputFormat:     

​				createRecordReader ： 返回记录阅读器，将切片中的数据，以K-V形式读取。

​				getSplit() : 切片

--------



## 6.dim_base_province

只在首日同步，特殊维度表。

只需要在首日进行处理，之后不处理。

### 6.1 建表

主体：  省份

粒度： 一行是一个省份

```sql
DROP TABLE IF EXISTS dim_base_province;
CREATE EXTERNAL TABLE dim_base_province (
    `id` STRING COMMENT 'id',
    `province_name` STRING COMMENT '省市名称',
    `area_code` STRING COMMENT '地区编码',
    `iso_code` STRING COMMENT 'ISO-3166编码，供可视化使用',
    `iso_3166_2` STRING COMMENT 'IOS-3166-2编码，供可视化使用',
    `region_id` STRING COMMENT '地区id',
    `region_name` STRING COMMENT '地区名称'
) COMMENT '地区维度表'
STORED AS PARQUET
LOCATION '/warehouse/gmall/dim/dim_base_province/'
TBLPROPERTIES ("parquet.compression"="lzo");
```





### 6.2 数据导入

```sql
INSERT overwrite table dim_base_province 
SELECT 
	province.id, name province_name, area_code, iso_code, iso_3166_2, region_id, region_name
from  ods_base_province province
left join ods_base_region  region
on province.region_id =region .id 
```



## 7.dim_date_info

属于特殊维度。

在国家每年元旦发布新的一年的各种休假安排之后，将这一年的数据一次性导入。



作用：  在查询某些日期范围数据时，可以和日期表进行关联，关联后，通过日期表的字段，进行查询。



举例：   求2021年第三周的订单有哪些？

​	

```sql
--举例：   求2021年第三周的订单有哪些？
select
	*
from  ods_order_info   left   join  dim_date_info
on  date_format(ods_order_info.create_time,'yyyy-MM-dd') = dim_date_info.date_id
where year='2021' and week_id=3
```





### 7.1 建表

```sql
DROP TABLE IF EXISTS dim_date_info;
CREATE EXTERNAL TABLE dim_date_info(
    `date_id` STRING COMMENT '日',
    `week_id` STRING COMMENT '周ID',
    `week_day` STRING COMMENT '周几',
    `day` STRING COMMENT '每月的第几天',
    `month` STRING COMMENT '第几月',
    `quarter` STRING COMMENT '第几季度',
    `year` STRING COMMENT '年',
    `is_workday` STRING COMMENT '是否是工作日',
    `holiday_id` STRING COMMENT '节假日'
) COMMENT '时间维度表'
STORED AS PARQUET
LOCATION '/warehouse/gmall/dim/dim_date_info/'
TBLPROPERTIES ("parquet.compression"="lzo");
```



### 7.2 数据导入



```
load data inpath '/date_info.txt' overwrite into table tmp_dim_date_info ;

INSERT overwrite table dim_date_info select * from tmp_dim_date_info ;
```



## 8.dim_user_info

属于维度信息，

每日通过新增和变化同步。

首日：业务此系统从运行到2021-05-07产生的所有的用户信息。

**首日和每日处理的方式不同。**



用户的信息，会经常发生修改操作的。

### 8.1 拉链表

拉链表：  拉链 表

​				拉 链表

​				拉 链 表

​				拉取(查询)，链（数据的一种形态，链条状） 



维度表：  

​		①几乎不怎么改变的维度表，例如 地区，省份，日期

​		②低频变化维度表，例如活动维度表，商品维度表

​		③中(低)频变化维度表 ，例如用户维度表

​						

②③特可以称为缓慢变化的维度表！

​		你需不需要监控这种变化！如果需要监控缓慢变化维度表的变化记录，可以使用拉链表的形式记录！

​		在查询时，可以将一个维度信息的变化使用链条形式呈现！



总结： 

- ​	希望监控缓慢变化的维度表的状态，就制作拉链表！

- ​    拉链表的制作核心是为每天导入的数据，生成start_date和end_date!

- ​    拉链表因为要查询数据的 “来龙去脉”，已经导入的数据，只能修改end_date，不能删除！

  ​    总的数据量=    已经导入的DIM层的数据条数   +    当天要导入的ODS的新增和变化的数据条数

-    在查询时，一般都使用start_date和end_date进行有效的过滤

  ​	例如：查询当前最新的用户的信息，使用end_date=9999-99-99进行过滤
  
  ​	例如： 查询2021-1-1后所有用户的换号情况，start_date >= 2021-1-1
  
  ​				

​						

### 8.2 建表

主体： 用户

粒度：  用户信息在某个时间的状态



如果是一张分区表，如何选择分区字段？

​		分区字段在查询时，使用分区字段的值，匹配Hdfs表目录中指定子目录的数据，避免全表扫描。

​	    分区字段的设置，需要根据查询的需求，一般选择经常查询的字段。

```sql
DROP TABLE IF EXISTS dim_user_info;
CREATE EXTERNAL TABLE dim_user_info(
    `id` STRING COMMENT '用户id',
    `login_name` STRING COMMENT '用户名称',
    `nick_name` STRING COMMENT '用户昵称',
    `name` STRING COMMENT '用户姓名',
    `phone_num` STRING COMMENT '手机号码',
    `email` STRING COMMENT '邮箱',
    `user_level` STRING COMMENT '用户等级',
    `birthday` STRING COMMENT '生日',
    `gender` STRING COMMENT '性别',
    `create_time` STRING COMMENT '创建时间',
    `operate_time` STRING COMMENT '操作时间',
    `start_date` STRING COMMENT '开始日期',
    `end_date` STRING COMMENT '结束日期'
) COMMENT '用户表'
--按照end_date进行分区
PARTITIONED BY (`dt` STRING)
STORED AS PARQUET
LOCATION '/warehouse/gmall/dim/dim_user_info/'
TBLPROPERTIES ("parquet.compression"="lzo");
```

要求：   对导入到DIM层的用户信息进行分类，如果已经过期，放入到dt=过期日期分区，未过期，放入dt=9999-99-99



关键：  

①判断数据是否过期！  

​			解：可以通过将dim层的最新(未过期)数据  和  ods层当天导入的数据，进行inner Join（取交集），join后的DIM层表中的数据就是过期的数据

​					

②如果过期，将end_date由9999-99-99改为过期的日期！

​				解：将end_date修改为      当日ods层导入数据的日期  - 1



③保证数据数量正确

​		总的数据量=    已经导入的DIM层的数据条数   +    当天要导入的ODS的新增和变化的数据条数

​			解：   

​							当天过期的数据  ( ods当日的新增和变化    inner join    DIM层 dt=9999-99-99的数据 )

​							union all

​							当天未过期的数据  ( ods当日的新增和变化    full join    DIM层 dt=9999-99-99的数据 )

④首日导入的是截至到首日，用户的全量信息，之后每日导入的仅仅是新增和变化，将数据导入到DIM层时，区分首日和每日不同的实现过程

![未命名文件 (4)](https://i.loli.net/2021/04/01/HrysWKvZJXhazQI.png)

### 8.3 首日数据导入



```sql
INSERT  overwrite table dim_user_info partition(dt='9999-99-99')
SELECT 
   *,
   '9999-99-99' end_date
from ods_user_info 
--存放的是截至到5-7日所有的用户信息
where dt='2021-05-07'
```

### 8.4 每日数据导入



```sql
INSERT overwrite table dim_user_info  partition(dt)
SELECT 
	--获取到蓝色块最新数据
	if(ods_data.id is not null, ods_data.id , dim_data.id) id,
	if(ods_data.id is not null, ods_data.login_name , dim_data.login_name) login_name,
	if(ods_data.id is not null, ods_data.nick_name , dim_data.nick_name) nick_name,
	if(ods_data.id is not null, ods_data.name , dim_data.name) name,
	if(ods_data.id is not null, ods_data.phone_num , dim_data.phone_num) phone_num,
	if(ods_data.id is not null, ods_data.email , dim_data.email) email,
	if(ods_data.id is not null, ods_data.user_level , dim_data.user_level) user_level,
	if(ods_data.id is not null, ods_data.birthday , dim_data.birthday) birthday,
	if(ods_data.id is not null, ods_data.gender , dim_data.gender) gender,
	if(ods_data.id is not null, ods_data.create_time , dim_data.create_time) create_time,
	if(ods_data.id is not null, ods_data.operate_time , dim_data.operate_time) operate_time,
	if(ods_data.id is not null, ods_data.dt , dim_data.start_date) start_date,
	if(ods_data.id is not null, ods_data.end_date , dim_data.end_date) end_date,
	'9999-99-99' dt
from
(SELECT 
   *
from dim_user_info 
--存放的是截至到5-8日 新增和变化的用户信息
where dt='9999-99-99' ) dim_data
full join
(SELECT 
   *,
   '9999-99-99' end_date
from ods_user_info 
--存放的是截至到5-8日 新增和变化的用户信息
where dt='2021-05-08' ) ods_data
on dim_data.id = ods_data.id
-- union 去重，union all不去重  ，保证上下结果集的列数，列的位置，类型一一对应
union all
select
	dim_data.id,
	dim_data.login_name,
	dim_data.nick_name,
	dim_data.name,
	dim_data.phone_num,
	dim_data.email,
	dim_data.user_level,
	dim_data.birthday,
	dim_data.gender,
	dim_data.create_time,
	dim_data.operate_time,
	dim_data.start_date,
	cast(date_sub(ods_data.dt,1) as string) ,
	cast(date_sub(ods_data.dt,1) as string) dt
from
(SELECT 
   *
from dim_user_info 
--存放的是截至到5-8日 新增和变化的用户信息
where dt='9999-99-99' ) dim_data
join
(SELECT 
   *
from ods_user_info 
--存放的是截至到5-8日 新增和变化的用户信息
where dt='2021-05-08' ) ods_data
on dim_data.id = ods_data.id;
```



### 8.5 每日数据导入实现二

原理：  蓝色部分：   dim_data  full join  ods_data

​			红色部分：   ① dim_data  full join  ods_data

​									②依次遍历，dim_data 为 null 和 ods_data 为null 的部分，标记为null,其余关联部分，取红色部分数据

​									③ 从①中将 ②的结果 为null的过滤掉





```sql
with 
tmp as
(SELECT 
	-- 行数： a+ b+ c    将列数翻倍
	-- 蓝色部分列
	if(ods_data.id is not null, ods_data.id , dim_data.id) id,
	if(ods_data.id is not null, ods_data.login_name , dim_data.login_name) login_name,
	if(ods_data.id is not null, ods_data.nick_name , dim_data.nick_name) nick_name,
	if(ods_data.id is not null, ods_data.name , dim_data.name) name,
	if(ods_data.id is not null, ods_data.phone_num , dim_data.phone_num) phone_num,
	if(ods_data.id is not null, ods_data.email , dim_data.email) email,
	if(ods_data.id is not null, ods_data.user_level , dim_data.user_level) user_level,
	if(ods_data.id is not null, ods_data.birthday , dim_data.birthday) birthday,
	if(ods_data.id is not null, ods_data.gender , dim_data.gender) gender,
	if(ods_data.id is not null, ods_data.create_time , dim_data.create_time) create_time,
	if(ods_data.id is not null, ods_data.operate_time , dim_data.operate_time) operate_time,
	if(ods_data.id is not null, ods_data.dt , dim_data.start_date) start_date,
	if(ods_data.id is not null, ods_data.end_date , dim_data.end_date) end_date,
	
	-- 红色部分列
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.id ,  null)  red_id,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.login_name ,  null)  red_login_name,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.nick_name ,  null)  red_nick_name,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.name ,  null)  red_name,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.phone_num ,  null)  red_phone_num,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.email ,  null)  red_email,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.user_level ,  null)  red_user_level,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.birthday ,  null)  red_birthday,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.gender ,  null)  red_gender,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.create_time ,  null)  red_create_time,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.operate_time ,  null)  red_operate_time,
	if(dim_data.id is not null and  ods_data.id is not null , dim_data.start_date ,  null)  red_start_date,
	if(dim_data.id is not null and  ods_data.id is not null , cast(date_sub(ods_data.dt,1) as string) ,  null)  red_end_date

from
(SELECT 
   *
from dim_user_info 
--存放的是截至到5-8日 新增和变化的用户信息
where dt='9999-99-99' ) dim_data
full join
(SELECT 
   *,
   '9999-99-99' end_date
from ods_user_info 
--存放的是截至到5-8日 新增和变化的用户信息
where dt='2021-05-08' ) ods_data
on dim_data.id = ods_data.id  ) 
insert overwrite table dim_user_info  partition(dt)
--查询蓝色部分
SELECT 
  id,
login_name,
nick_name,
name,
phone_num,
email,
user_level,
birthday,
gender,
create_time,
operate_time,
start_date,
end_date,
'9999-99-99' dt
from tmp
union all
select
   red_id,
red_login_name,
red_nick_name,
red_name,
red_phone_num,
red_email,
red_user_level,
red_birthday,
red_gender,
red_create_time,
red_operate_time,
red_start_date,
red_end_date,
red_end_date  dt
from tmp
where red_id is not null;
```

# 三、DWD层

## 0.get_json_object

​			作用： 从一个json串中抽取 指定path下的 json str

​			核心： path怎么写？

​						$:    根json 对象

​						.:    子元素操作符

​						[]:   数组子元素操作符

​						* :   通配符   



举例： 

```json
--取47

select get_json_object(
'[{"name":"大郎","sex":"男","age":"25"},{"name":"西门庆","sex":"男","age":"47"}]','$[1].age')

--取47
select get_json_object(
'{"husbud":[{"name":"大郎","sex":"男","age":"25"},{"name":"西门庆","sex":"男","age":"47"}]}','$.husbud[1].age')
```



## 1.整体思路

①用户行为数据，没有存量数据，每天采集的都是当天产生的用户行为

②主要使用get_json_obejct从json串中获取指定的数据

③数据来源  ods_log

## 2.dwd_start_log

### 2.1 建表

```sql
CREATE EXTERNAL TABLE dwd_start_log(
    `area_code` STRING COMMENT '地区编码',
    `brand` STRING COMMENT '手机品牌',
    `channel` STRING COMMENT '渠道',
    `is_new` STRING COMMENT '是否首次启动',
    `model` STRING COMMENT '手机型号',
    `mid_id` STRING COMMENT '设备id',
    `os` STRING COMMENT '操作系统',
    `user_id` STRING COMMENT '会员id',
    `version_code` STRING COMMENT 'app版本号',
    `entry` STRING COMMENT 'icon手机图标 notice 通知 install 安装后启动',
    `loading_time` BIGINT COMMENT '启动加载时间',
    `open_ad_id` STRING COMMENT '广告页ID ',
    `open_ad_ms` BIGINT COMMENT '广告总共播放时间',
    `open_ad_skip_ms` BIGINT COMMENT '用户跳过广告时点',
    `ts` BIGINT COMMENT '时间'
) COMMENT '启动日志表'
```



### 2.2 导入数据

```sql
INSERT overwrite table dwd_start_log  partition(dt='2021-05-07')
-- 导入5-7日的启动日志  
select 
 get_json_object(line, '$.common.ar' ) area_code,
	get_json_object(line, '$.common.ba' ) brand,
	get_json_object(line, '$.common.ch' ) channel,
	get_json_object(line, '$.common.is_new' ) is_new,
	get_json_object(line, '$.common.md' ) model,
	get_json_object(line, '$.common.mid' ) mid_id,
	get_json_object(line, '$.common.os' ) os,
	get_json_object(line, '$.common.uid' ) user_id,
	get_json_object(line, '$.common.vc' ) version_code,
   get_json_object(line, '$.start.entry' ) entry,
   get_json_object(line, '$.start.loading_time' ) loading_time,
   get_json_object(line, '$.start.open_ad_id' ) open_ad_id,
   get_json_object(line, '$.start.open_ad_ms' ) open_ad_ms,
   get_json_object(line, '$.start.open_ad_skip_ms' ) open_ad_skip_ms,
   get_json_object(line, '$.ts' ) ts
 from ods_log 
 where dt='2021-05-07'
 --过滤出启动日志
 and  get_json_object(line ,'$.start') is not null;
```



## 3.dwd_page_log

### 3.1 建表

```sql
CREATE EXTERNAL TABLE dwd_page_log(
    `area_code` STRING COMMENT '地区编码',
    `brand` STRING COMMENT '手机品牌',
    `channel` STRING COMMENT '渠道',
    `is_new` STRING COMMENT '是否首次启动',
    `model` STRING COMMENT '手机型号',
    `mid_id` STRING COMMENT '设备id',
    `os` STRING COMMENT '操作系统',
    `user_id` STRING COMMENT '会员id',
    `version_code` STRING COMMENT 'app版本号',
    
    `during_time` BIGINT COMMENT '持续时间毫秒',
    `page_item` STRING COMMENT '目标id ',
    `page_item_type` STRING COMMENT '目标类型',
    `last_page_id` STRING COMMENT '上页类型',
    `page_id` STRING COMMENT '页面ID ',
    `source_type` STRING COMMENT '来源类型',
    `ts` bigint
) COMMENT '页面日志表'
```

### 3.2 导入数据

```sql
INSERT overwrite table dwd_page_log  partition(dt='2021-05-07')
-- 导入5-7日的启动日志  
select 
    get_json_object(line, '$.common.ar' ) area_code,
	get_json_object(line, '$.common.ba' ) brand,
	get_json_object(line, '$.common.ch' ) channel,
	get_json_object(line, '$.common.is_new' ) is_new,
	get_json_object(line, '$.common.md' ) model,
	get_json_object(line, '$.common.mid' ) mid_id,
	get_json_object(line, '$.common.os' ) os,
	get_json_object(line, '$.common.uid' ) user_id,
	get_json_object(line, '$.common.vc' ) version_code,
	get_json_object(line, '$.page.during_time' ) during_time,
	get_json_object(line, '$.page.item' ) page_item,
	get_json_object(line, '$.page.item_type' ) page_item_type,
	get_json_object(line, '$.page.last_page_id' ) last_page_id,
	get_json_object(line, '$.page.page_id' ) page_id,
	get_json_object(line, '$.page.source_type' ) source_type,
	get_json_object(line, '$.ts' ) 
 from ods_log 
 where dt='2021-05-07'
 --过滤出页面日志
 and  get_json_object(line ,'$.page') is not null;
```



## 4.dwd_action_log

格式：  {  actions: [{}, {},  ...  ]  }

​              {  actions: [{}]  }



自己编写udtf函数，实现类似explode的效果！

​		https://cwiki.apache.org/confluence/display/Hive/DeveloperGuide+UDTF



步骤： ①继承 GenericUDTF  类，实现initialize`, `process ，选择性实现close

​            ②initialize 被hive调用用来验证 函数入参类型是否合法， 返回值必须返回  UDTF函数 生成的每行内容不同列类型对应的 object inspector 

```
//  传入  一行 一列  ，返回  一行3列    myudtf(a|b|c*d|e|f)   =>    a,b,c
															    d,e,f
                                                   
initialize () {
  检查 udtf 允许传入的参数的类型
  	return   List(string类型的object inspector ,string类型的object inspector ,string类型的object inspector )

}

process(){
   a|b|c*d|e|f
   
   forward(a,b,c  d,e,f )

}
```

​			③当initialize 被调用后，函数传入的数据，会经过process()进行处理，之后调用forward写出

​		   ④数据全部处理完成后，调用close执行一些清理操作

 





定义函数： 上传函数的jar包到  $HIVE_HOME/auxlib 目录，重启hive

```
-- 严重的注意事项  hive内置的函数可以在任意库下使用，自定义的函数，只能在定义的库下使用，如果要跨库，必须加库名
CREATE function  explode_jsonarray  as 'com.atguigu.hive.functions.ExplodeJsonArray';

desc function gmall.explode_jsonarray
```



### 4.1 建表

```sql
CREATE EXTERNAL TABLE dwd_action_log(
    `area_code` STRING COMMENT '地区编码',
    `brand` STRING COMMENT '手机品牌',
    `channel` STRING COMMENT '渠道',
    `is_new` STRING COMMENT '是否首次启动',
    `model` STRING COMMENT '手机型号',
    `mid_id` STRING COMMENT '设备id',
    `os` STRING COMMENT '操作系统',
    `user_id` STRING COMMENT '会员id',
    `version_code` STRING COMMENT 'app版本号',
    `during_time` BIGINT COMMENT '持续时间毫秒',
    `page_item` STRING COMMENT '目标id ',
    `page_item_type` STRING COMMENT '目标类型',
    `last_page_id` STRING COMMENT '上页类型',
    `page_id` STRING COMMENT '页面id ',
    `source_type` STRING COMMENT '来源类型',
    `action_id` STRING COMMENT '动作id',
    `item` STRING COMMENT '目标id ',
    `item_type` STRING COMMENT '目标类型',
    `ts` BIGINT COMMENT '时间'
) COMMENT '动作日志表'
```



### 4.2 导入数据

```sql
INSERT overwrite table dwd_action_log  partition(dt='2021-05-07')
-- 导入5-7日的启动日志  
select 
	--udtf只能单独在select中存在，如果向和其他列一起查询，需要侧写lateral view
	get_json_object(line, '$.common.ar' ) area_code,
	get_json_object(line, '$.common.ba' ) brand,
	get_json_object(line, '$.common.ch' ) channel,
	get_json_object(line, '$.common.is_new' ) is_new,
	get_json_object(line, '$.common.md' ) model,
	get_json_object(line, '$.common.mid' ) mid_id,
	get_json_object(line, '$.common.os' ) os,
	get_json_object(line, '$.common.uid' ) user_id,
	get_json_object(line, '$.common.vc' ) version_code,
	get_json_object(line, '$.page.during_time' ) during_time,
	get_json_object(line, '$.page.item' ) page_item,
	get_json_object(line, '$.page.item_type' ) page_item_type,
	get_json_object(line, '$.page.last_page_id' ) last_page_id,
	get_json_object(line, '$.page.page_id' ) page_id,
	get_json_object(line, '$.page.source_type' ) source_type,
	get_json_object(actionJOStr, '$.action_id' ) ,
	get_json_object(actionJOStr, '$.item' ) ,
	get_json_object(actionJOStr, '$.item_type' ) ,
	get_json_object(actionJOStr, '$.ts' ) 
 from ods_log lateral view  explode_jsonarray(get_json_object(line ,'$.actions')) actionJO as  actionJOStr
 where dt='2021-05-07'
 --过滤出动作日志
 and  get_json_object(line ,'$.actions') is not null;
 


```



## 5.dwd_display_log

### 5.1 建表

```
CREATE EXTERNAL TABLE dwd_display_log(
    `area_code` STRING COMMENT '地区编码',
    `brand` STRING COMMENT '手机品牌',
    `channel` STRING COMMENT '渠道',
    `is_new` STRING COMMENT '是否首次启动',
    `model` STRING COMMENT '手机型号',
    `mid_id` STRING COMMENT '设备id',
    `os` STRING COMMENT '操作系统',
    `user_id` STRING COMMENT '会员id',
    `version_code` STRING COMMENT 'app版本号',
    `during_time` BIGINT COMMENT 'app版本号',
    `page_item` STRING COMMENT '目标id ',
    `page_item_type` STRING COMMENT '目标类型',
    `last_page_id` STRING COMMENT '上页类型',
    `page_id` STRING COMMENT '页面ID ',
    `source_type` STRING COMMENT '来源类型',
    `ts` BIGINT COMMENT 'app版本号',
    `display_type` STRING COMMENT '曝光类型',
    `item` STRING COMMENT '曝光对象id ',
    `item_type` STRING COMMENT 'app版本号',
    `order` BIGINT COMMENT '曝光顺序',
    `pos_id` BIGINT COMMENT '曝光位置'
) COMMENT '曝光日志表'
```



### 5.2 导入数据

```
INSERT overwrite table dwd_display_log  partition(dt='2021-05-07')
-- 导入5-7日的启动日志  
select 
	--udtf只能单独在select中存在，如果向和其他列一起查询，需要侧写lateral view
	get_json_object(line, '$.common.ar' ) area_code,
	get_json_object(line, '$.common.ba' ) brand,
	get_json_object(line, '$.common.ch' ) channel,
	get_json_object(line, '$.common.is_new' ) is_new,
	get_json_object(line, '$.common.md' ) model,
	get_json_object(line, '$.common.mid' ) mid_id,
	get_json_object(line, '$.common.os' ) os,
	get_json_object(line, '$.common.uid' ) user_id,
	get_json_object(line, '$.common.vc' ) version_code,
	get_json_object(line, '$.page.during_time' ) during_time,
	get_json_object(line, '$.page.item' ) page_item,
	get_json_object(line, '$.page.item_type' ) page_item_type,
	get_json_object(line, '$.page.last_page_id' ) last_page_id,
	get_json_object(line, '$.page.page_id' ) page_id,
	get_json_object(line, '$.page.source_type' ) source_type,
	get_json_object(line, '$.ts' ) ts,
	get_json_object(actionJOStr, '$.display_type' ) ,
	get_json_object(actionJOStr, '$.item' ) ,
	get_json_object(actionJOStr, '$.item_type' ) ,
	get_json_object(actionJOStr, '$.order' ) ,
	get_json_object(actionJOStr, '$.pos_id' ) 
 from ods_log lateral view  explode_jsonarray(get_json_object(line ,'$.displays')) actionJO as  actionJOStr
 where dt='2021-05-07'
 --过滤出曝光日志
 and  get_json_object(line ,'$.displays') is not null;
 


```



## 6.dwd_error_log

### 6.1 建表

```sql
CREATE EXTERNAL TABLE dwd_error_log(
    `area_code` STRING COMMENT '地区编码',
    `brand` STRING COMMENT '手机品牌',
    `channel` STRING COMMENT '渠道',
    `is_new` STRING COMMENT '是否首次启动',
    `model` STRING COMMENT '手机型号',
    `mid_id` STRING COMMENT '设备id',
    `os` STRING COMMENT '操作系统',
    `user_id` STRING COMMENT '会员id',
    `version_code` STRING COMMENT 'app版本号',
    `page_item` STRING COMMENT '目标id ',
    `page_item_type` STRING COMMENT '目标类型',
    `last_page_id` STRING COMMENT '上页类型',
    `page_id` STRING COMMENT '页面ID ',
    `source_type` STRING COMMENT '来源类型',
    `entry` STRING COMMENT ' icon手机图标  notice 通知 install 安装后启动',
    `loading_time` STRING COMMENT '启动加载时间',
    `open_ad_id` STRING COMMENT '广告页ID ',
    `open_ad_ms` STRING COMMENT '广告总共播放时间',
    `open_ad_skip_ms` STRING COMMENT '用户跳过广告时点',
    `actions` STRING COMMENT '动作',
    `displays` STRING COMMENT '曝光',
    `ts` STRING COMMENT '时间',
    `error_code` STRING COMMENT '错误码',
    `msg` STRING COMMENT '错误信息'
) COMMENT '错误日志表'
```



### 6.2 导入数据

```
INSERT overwrite table dwd_error_log  partition(dt='2021-05-07')
-- 导入5-7日的启动日志  
select 
	--udtf只能单独在select中存在，如果向和其他列一起查询，需要侧写lateral view
	get_json_object(line, '$.common.ar' ) area_code,
	get_json_object(line, '$.common.ba' ) brand,
	get_json_object(line, '$.common.ch' ) channel,
	get_json_object(line, '$.common.is_new' ) is_new,
	get_json_object(line, '$.common.md' ) model,
	get_json_object(line, '$.common.mid' ) mid_id,
	get_json_object(line, '$.common.os' ) os,
	get_json_object(line, '$.common.uid' ) user_id,
	get_json_object(line, '$.common.vc' ) version_code,
	
	get_json_object(line, '$.page.item' ) page_item,
	get_json_object(line, '$.page.item_type' ) page_item_type,
	get_json_object(line, '$.page.last_page_id' ) last_page_id,
	get_json_object(line, '$.page.page_id' ) page_id,
	get_json_object(line, '$.page.source_type' ) source_type,
	
	get_json_object(line, '$.start.entry' ) entry,
   get_json_object(line, '$.start.loading_time' ) loading_time,
   get_json_object(line, '$.start.open_ad_id' ) open_ad_id,
   get_json_object(line, '$.start.open_ad_ms' ) open_ad_ms,
   get_json_object(line, '$.start.open_ad_skip_ms' ) open_ad_skip_ms,
   get_json_object(line ,'$.actions') ,
   get_json_object(line ,'$.displays') ,
    get_json_object(line, '$.ts' ) ts,
   get_json_object(line ,'$.err.error_code') ,
   get_json_object(line ,'$.err.msg') 
  
 from ods_log
 where dt='2021-05-07'
 --过滤出错误日志
 and  get_json_object(line ,'$.err') is not null;
```



## 7.dwd_comment_info

事务型事实表中的数据一旦产生不会修改。采集到hdfs之后，导入数仓的数据也是不会修改的！

当天采集的数据，放入当天的分区。

### 7.1 建表

主体： 用户的评论

粒度： 用户对某个订单中某个商品的一条评论

要求：按照评论产生的日期，进行分区

首日和每日导入方式一致。

```sql
CREATE EXTERNAL TABLE dwd_comment_info(
    --ods_comment_info
    `id` STRING COMMENT '编号',
    `user_id` STRING COMMENT '用户ID',
    `sku_id` STRING COMMENT '商品sku',
    `spu_id` STRING COMMENT '商品spu',
    `order_id` STRING COMMENT '订单ID',
    `appraise` STRING COMMENT '评价(好评、中评、差评、默认评价)',
    `create_time` STRING COMMENT '评价时间'
) COMMENT '评价事实表'
```



### 7.2 导入数据



```
INSERT overwrite table dwd_comment_info partition(dt)
SELECT 
	id, user_id, sku_id, spu_id, order_id, appraise, create_time,
	date_format(create_time ,'yyyy-MM-dd')
from  ods_comment_info 
where dt='2021-05-07'
```



## 8.dwd_order_detail

主体：  下单详情（每笔订单可能购买多个商品，每个商品的详细情况信息）

粒度：  一个用户购买的一笔订单的一种商品

分区：  按照订单详情产生的时间进行分区

首日和每日导入方式一致。



主体表   left join   其他表



遇到NULL,参考数仓的规范。一般情况下，数值类不允许为NULL

### 8.1 建表

```sql
CREATE EXTERNAL TABLE dwd_order_detail (
    --ods_order_detail
    `id` STRING COMMENT '订单编号',
    `order_id` STRING COMMENT '订单号',
    -- ods_order_info
    `user_id` STRING COMMENT '用户id',
    `sku_id` STRING COMMENT 'sku商品id',
     -- ods_order_info
    `province_id` STRING COMMENT '省份ID',
    --ods_order_detail_activity
    `activity_id` STRING COMMENT '活动ID',
    `activity_rule_id` STRING COMMENT '活动规则ID',
    --ods_order_detail_coupon
    `coupon_id` STRING COMMENT '优惠券ID',
    `create_time` STRING COMMENT '创建时间',
    `source_type` STRING COMMENT '来源类型',
    `source_id` STRING COMMENT '来源编号',
    `sku_num` BIGINT COMMENT '商品数量',
    --  这笔单中，这种商品优惠之前的  价格  =  数量 * 单价
    `original_amount` DECIMAL(16,2) COMMENT '原始价格',
    `split_activity_amount` DECIMAL(16,2) COMMENT '活动优惠分摊',
    `split_coupon_amount` DECIMAL(16,2) COMMENT '优惠券优惠分摊',
    `split_final_amount` DECIMAL(16,2) COMMENT '最终价格分摊'
) COMMENT '订单明细事实表表'
```



### 8.2 导入数据

```sql
INSERT overwrite table dwd_order_detail partition(dt)
select
		t1.id,
		t1.order_id,
		user_id,
		sku_id,
		province_id,
		activity_id,
		activity_rule_id,
		coupon_id,
		create_time,
		source_type,
		source_id,
		sku_num,
		sku_num * order_price  original_amount,
		nvl(split_activity_amount,0.0),
		nvl(split_coupon_amount,0.0),
		split_final_amount,
		date_format(create_time ,'yyyy-MM-dd')
from
(SELECT 
	* 
from  ods_order_detail 
where dt='2021-05-07' ) t1
left join 
(select 
   user_id,id,province_id
 from ods_order_info 
 where dt='2021-05-07' ) t2
 on t1.order_id = t2.id
 left join
 (select 
     order_detail_id,activity_id,activity_rule_id
  from ods_order_detail_activity 
  where dt='2021-05-07' ) t3
  on t1.id=t3.order_detail_id
  left join
  (select 
     order_detail_id,coupon_id
   from ods_order_detail_coupon 
   where dt='2021-05-07' ) t4
   on t1.id=t4.order_detail_id;
```





## 9.dwd_order_refund_info

### 9.1 建表

主体：  退款的订单

粒度：  一个用户下单的一笔订单中一件退款商品的详情



要求： 按照退单发起的时间分区

```sql
CREATE EXTERNAL TABLE dwd_order_refund_info(
    --ods_order_refund_info
    `id` STRING COMMENT '编号',
    `user_id` STRING COMMENT '用户ID',
    `order_id` STRING COMMENT '订单ID',
    `sku_id` STRING COMMENT '商品ID',
    -- ods_order_info
    `province_id` STRING COMMENT '地区ID',
    `refund_type` STRING COMMENT '退单类型',
    `refund_num` BIGINT COMMENT '退单件数',
    `refund_amount` DECIMAL(16,2) COMMENT '退单金额',
    `refund_reason_type` STRING COMMENT '退单原因类型',
    `create_time` STRING COMMENT '退单时间'
) COMMENT '退单事实表'
```



### 9.2 导入数据

```sql
INSERT overwrite table dwd_order_refund_info partition(dt)
select
		t1.id,
		 user_id, 
		 order_id, 
		 sku_id,
		 province_id,
		 refund_type, refund_num, refund_amount, refund_reason_type,
		 create_time, 
		date_format(create_time ,'yyyy-MM-dd')
from
(SELECT 
	* 
from  ods_order_refund_info 
where dt='2021-05-07' ) t1
left join 
(select 
   id,province_id
 from ods_order_info 
 where dt='2021-05-07' ) t2
 on t1.order_id = t2.id;
```



### 9.3 事务型实时表总结

①首日和每日的导入语句是一样的。

​		事务型事实表中的数据一旦产生不会修改，因此每日导入的数据，不会影响之前的数据。不存在修改，每日导入的数据根据事实的创建时间进行分区！



②导入方式，都是 使用 主体表 left join 其他表



③分区都是按照事实的创建时间分区

## 10.dwd_cart_info

### 10.0 周期型快照事实表

①确认事实采集的周期

​		1天

②确定采集的事实的范围

​			采集全量事实   or  采集当日的增量事实

​			每天的分区中保存的是事实表的全量事实



③如何获取每日的全量快照

​		a当前选择) 简单，粗暴，适合数据量小，硬件设备好的情况

​						将事实表，每日全量同步到 ods，直接 全部导入到  dwd



​		b)  ods层只采集每日新增和变化的数据，之后利用 dwd层昨天的全量 数据  +   ods今天的新增和变化数据，将合并后的数据，写入到今天的dwd层分区。适合数据量大，不希望浪费大量同步时间的情况



④每日和首日数据导入方式也相同

### 10.1 建表

```sql
CREATE EXTERNAL TABLE dwd_cart_info(
    `id` STRING COMMENT '编号',
    `user_id` STRING COMMENT '用户ID',
    `sku_id` STRING COMMENT '商品ID',
    `source_type` STRING COMMENT '来源类型',
    `source_id` STRING COMMENT '来源编号',
    `cart_price` DECIMAL(16,2) COMMENT '加入购物车时的价格',
    `is_ordered` STRING COMMENT '是否已下单',
    `create_time` STRING COMMENT '创建时间',
    `operate_time` STRING COMMENT '修改时间',
    `order_time` STRING COMMENT '下单时间',
    `sku_num` BIGINT COMMENT '加购数量'
) COMMENT '加购事实表'
```



### 10.2 导入数据

```sql
INSERT overwrite table dwd_cart_info partition(dt)
select
id, user_id, sku_id, source_type, source_id, cart_price, is_ordered, create_time, 
operate_time, order_time, sku_num,
dt
 from ods_cart_info 
 -- 截至到2021-05-07所有的购物车数据
 where dt='2021-05-07';
```



## 11.dwd_favor_info

### 11.1建表

```sql
CREATE EXTERNAL TABLE dwd_favor_info(
    `id` STRING COMMENT '编号',
    `user_id` STRING  COMMENT '用户id',
    `sku_id` STRING  COMMENT 'skuid',
    `spu_id` STRING  COMMENT 'spuid',
    `is_cancel` STRING  COMMENT '是否取消',
    `create_time` STRING  COMMENT '收藏时间',
    `cancel_time` STRING  COMMENT '取消时间'
) COMMENT '收藏事实表'
```



### 11.2 导入数据

```sql
INSERT overwrite table dwd_favor_info partition(dt)
select
	*
 from ods_favor_info 
 -- 截至到2021-05-07所有的收藏数据
 where dt='2021-05-07'
```



## 12.dwd_coupon_use

主体： 优惠券从领取到使用的事实

粒度： 一张券是一行



优惠券领取的事实的生命周期：    领券------------> 下单用券 -------------> 支付抵消券(完成)

​                                                          领券-------------> 过期(完成)

​														  领券------------> 下单用券-------------->  过期(完成)

​														



如何分区：  按照优惠券领取后事实是否完成进行分区。

​		完成：  放入事实完成时间所在当天的分区

​		未完成：  放入dt=9999-99-99分区



核心： 如何定义事实的完成。

​		完成：  被支付，或过期

​		未完成：  只要没到过期时间，没有被支付

​		expire_time： 如何赋值

​				a)  有些公司的业务，是在用户领券时，根据领取时间 +  券的最大时长 ，确定过期时间

​				b 选择)  会有定时任务，为过期的券，添加expire_time

​							只要expire_time有值，说明已经过期，否则永不过期







### 12.1 建表

```sql
CREATE EXTERNAL TABLE dwd_coupon_use(
    -- ods_coupon_use
    `id` STRING COMMENT '编号',
    `coupon_id` STRING  COMMENT '优惠券 种类 ID',
    `user_id` STRING  COMMENT 'userid',
    `order_id` STRING  COMMENT '订单id',
    `coupon_status` STRING  COMMENT '优惠券状态',
    
    `get_time` STRING  COMMENT '领取时间',
    `using_time` STRING  COMMENT '使用时间(下单)',
    `used_time` STRING  COMMENT '使用时间(支付)',
    `expire_time` STRING COMMENT '过期时间'
) COMMENT '优惠券领用事实表'
```



### 12.2 导入数据

#### 12.2.1 判断语句

if ( 表达式 ,  表达式为true执行 ,  表达式为false执行)



```sql
case   列 
  when   值1   then   xxx
   ....
   when  值N  then   xxx
   else   xxxx
end



--示例
SELECT 
	user_id , 
	case user_id
		when 1 then  '1号'
		WHEN 2 then  '2号'
		else '其他'
		END 
from ods_coupon_use 
limit 10



case   
  when   条件判断1   then   xxx
   ....
   when  条件判断2  then   xxx
   else   xxxx
end


SELECT 
	user_id , 
	case when user_id = 1 then  '1号'
		 WHEN user_id =2 then  '2号'
		 else '其他'
		END 
from ods_coupon_use 
limit 10
```



#### 12.2.2 首日导入

首日导入： 数据是截至到5-7日所有的优惠券领取事实。

​						判断事实是否完成，如果完成，放入完成时间所在分区，未完成放入9999-99-99分区

```sql
INSERT overwrite table dwd_coupon_use partition(dt)
SELECT 
	id, coupon_id, user_id, order_id, coupon_status, 
	get_time, using_time, used_time, expire_time, 
	-- 判断当前事实是否完成，如果未完成，赋值9999-99-99
	case 
	   when   expire_time is not null  then  date_format(expire_time,'yyyy-MM-dd')
	   when   used_time is not null then date_format(used_time,'yyyy-MM-dd')
	   else   '9999-99-99'
    end   dt
from ods_coupon_use 
where dt='2021-05-07'


```



#### 12.2.3 每日导入

核心：  已经完成的领券事实，不做修改。

​				dt=9999-99-99分区未完成的领券事实，需要结合今天采集的数据，判断是否有完成的事实，如果有放入完成的分区，否则还在9999-99-99分区

![未命名文件 (5)](https://i.loli.net/2021/05/12/tKO8UsYDQ59lfVX.png)



思路：  使用  dwd 9999-99-99分区的数据   full join   ods 当天的数据，之后使用ods层的数据更新 dwd层，更新后，再根据更新后的数据来判断是否完成。



```sql
INSERT overwrite table dwd_coupon_use partition(dt)
select
	id,
	coupon_id,
	user_id,
	order_id,
	coupon_status,
	get_time,
	using_time,
	used_time,
	expire_time,
	--根据expire_time和used_time 判断应该放入哪个分区
	case 
	   when   expire_time is not null  then  date_format(expire_time,'yyyy-MM-dd')
	   when   used_time is not null then date_format(used_time,'yyyy-MM-dd')
	   else   '9999-99-99'
    end   dt
from
(SELECT 
	--优先取ods_data中的数据，如果没有，再取dwd_data中的数据
	if(ods_data.id is not null , ods_data.id  ,  dwd_data.id)  id,
	if(ods_data.id is not null , ods_data.coupon_id  ,  dwd_data.coupon_id)  coupon_id,
	if(ods_data.id is not null , ods_data.user_id  ,  dwd_data.user_id)  user_id,
	if(ods_data.id is not null , ods_data.order_id  ,  dwd_data.order_id)  order_id,
	if(ods_data.id is not null , ods_data.coupon_status  ,  dwd_data.coupon_status)  coupon_status,
	if(ods_data.id is not null , ods_data.get_time  ,  dwd_data.get_time)  get_time,
	if(ods_data.id is not null , ods_data.using_time  ,  dwd_data.using_time)  using_time,
	if(ods_data.id is not null , ods_data.used_time  ,  dwd_data.used_time)  used_time,
	if(ods_data.id is not null , ods_data.expire_time  ,  dwd_data.expire_time)  expire_time
from
(select 
   * 
 from dwd_coupon_use 
 where dt='9999-99-99' ) dwd_data
 full join
 (select 
    * 
  from ods_coupon_use 
  where dt='2021-05-08' ) ods_data
  on dwd_data.id = ods_data.id ) tmp
```



## 13.dwd_payment_info

### 13.0 ods层跨天支付问题

跨天支付问题：  第二天支付前一天下的订单。

举例：  2021-5-3日 23点 59分 59秒  下单 ， 2021-5-4日支付



/ods_order_detail / dt=2021-05-03 /  1,   2021-5-3日 23点 59分 59秒 , 乒乓球 ， 4个



/ods_order_info / dt=2021-05-03 /  1,   2021-5-3日 23点 59分 59秒 ,  北京 , 已下单

/ods_order_info / dt=2021-05-04 /  1,   2021-5-3日 23点 59分 59秒 ,  北京 ,已支付



/ods_payment_info / dt=2021-05-04 /   支付id2001 ,  1,   2021-5-4日 1点 59分 59秒 



----

取2021-05-04，所有支付的订单的省份 ：

​		/ods_payment_info / dt=2021-05-04    left join   /ods_order_info / dt=2021-05-04



取2021-05-04，所有支付的订单的商品详情 ：

​			/ods_payment_info / dt=2021-05-04    left join   /ods_order_detail / dt=(2021-05-04 - 1) or dt=2021-05-04 - 1



-----

总结：

​			取当天支付信息的订单信息，只需要  当天支付信息  left  当天的订单信息

​			取当天支付信息的商品信息 ， 需要  当天支付信息  left  昨天的订单详情信息 和 今天的订单详情



### 13.1 建表

主体：  支付信息

粒度： 一行是一笔支付信息



分区：  完成的放入当日完成的分区，未完成的放入dt=9999-99-99分区



如何定义支付目的完成：   有call_backtime 就是完成，否则call_backtime为Null 是未完成。

​		

```sql
CREATE EXTERNAL TABLE dwd_payment_info (
    --ods_payment_info
    `id` STRING COMMENT '编号',
    `order_id` STRING COMMENT '订单编号',
    `user_id` STRING COMMENT '用户编号',
    -- ods_order_info
    `province_id` STRING COMMENT '地区ID',
    `trade_no` STRING COMMENT '交易编号',
    `out_trade_no` STRING COMMENT '对外交易编号',
    `payment_type` STRING COMMENT '支付类型',
    `payment_amount` DECIMAL(16,2) COMMENT '支付金额',
    `payment_status` STRING COMMENT '支付状态',
    `create_time` STRING COMMENT '创建时间',--调用第三方支付接口的时间
    `callback_time` STRING COMMENT '完成时间'--支付完成时间，即支付成功回调时间
) COMMENT '支付事实表表'
```



### 13.2 导入数据

#### 13.2.1 首日导入

ods_payment_info/2021-05-07 采集的全量数据，根据call_back是否为null，放入到不同的分区。

```sql
INSERT overwrite table dwd_payment_info partition(dt)
SELECT 
	t1.id,
	order_id,
	user_id,
	province_id,
	trade_no,
	out_trade_no,
	payment_type,
	payment_amount,
	payment_status,
	create_time,
	callback_time,
	DATE_FORMAT(nvl(callback_time,'9999-99-99'),'yyyy-MM-dd') dt
from 
(
--查询ods层首日采集的全量数据 ，包含了2021-05-03----2021-05-07所有的支付信息(成功的，有callback_time;call_time为null，支失败的)
SELECT 
	*
from ods_payment_info 
where dt = '2021-05-07'
)t1 
LEFT JOIN 
(
 select 
	id,province_id
 from ods_order_info 
 where dt='2021-05-07'
)t2
on t1.order_id = t2.id
```





#### 13.2.2 每日导入

第一种：  发起支付请求是一个事务，在payment_info表生成 一条支付信息，callback_time 为null

​					监听支付回调又是一个事务，收到回调，更新 支付表，更新callback_time字段，支付成功有值，支付超时为null。

​		

```sql
--如果payment_info只允许更新 call_back_time，使用以下写法没问题。 可以使用nvl和if


--如果payment_info不仅仅更新call_back_time，以下写法不可以，如果某个字段被更新为NULL了  . 只能用if判断
--  id   , trade_no , callback_time
--  1001， sujecta ,    NULL    dwd_data
--  full join 合并后
--  1001,  NULL   ,    2021-11   ods_data

-- 结果：   1001,  NULL ,   2021-11

INSERT
	overwrite table dwd_payment_info partition(dt)
SELECT
	-- 拿今天最新的数据更新 callback_time
	nvl(ods_data.id, dwd_data.id) id,
	nvl(ods_data.order_id, dwd_data.order_id) order_id,
	nvl(ods_data.user_id, dwd_data.user_id) user_id,
	nvl(ods_data.province_id, dwd_data.province_id) province_id,
	nvl(ods_data.trade_no, dwd_data.trade_no) trade_no,
	nvl(ods_data.out_trade_no, dwd_data.out_trade_no) out_trade_no,
	nvl(ods_data.payment_type, dwd_data.payment_type) payment_type,
	nvl(ods_data.payment_amount, dwd_data.payment_amount) payment_amount,
	nvl(ods_data.payment_status, dwd_data.payment_status) payment_status,
	nvl(ods_data.create_time, dwd_data.create_time) create_time,
	nvl(ods_data.callback_time, dwd_data.callback_time) callback_time,
	DATE_FORMAT(nvl(nvl(ods_data.callback_time, dwd_data.callback_time), '9999-99-99'), 'yyyy-MM-dd') dt
from
	(
	-- 已经完成的分区不考虑，只更新未完成的数据
	SELECT
		*
	from
		dwd_payment_info
	where
		dt = '9999-99-99' ) dwd_data
full join
	-- 查询当天需要导入的最新的数据    payment_info表中新增和变化的数据
(
	SELECT
		tmp1.id, order_id, user_id, province_id, trade_no, out_trade_no, payment_type, payment_amount, payment_status, create_time, callback_time
	from
		(
		SELECT
			*
		from
			ods_payment_info
		where
			dt = '2021-05-08' ) tmp1
		-- 为当天新增和变化的 payment 信息，添加 province_id
	LEFT JOIN (
		select
			id, province_id
		from
			ods_order_info 
			where dt = '2021-05-08')tmp2 on
		tmp1.order_id = tmp2.id ) ods_data on
	dwd_data.order_id = ods_data.order_id
```





第二种：   发起支付请求 和  监听支付回调 是一个事务，此时payment_info 是事务型事实表。一旦插入数据不允许更新。 只会在支付回调结束后,再向表插入数据。 不需要制作累积型快照事实表，不需要累积，参考dwd_order_detail 表。



## 14.dwd_refund_payment

### 14.1 建表

主体：  退款支付信息

粒度： 一行是一笔退款支付信息



分区：  完成的放入当日完成的分区，未完成的放入dt=9999-99-99分区



如何定义退款支付目的完成：   有call_backtime 就是完成，否则call_backtime为Null 是未完成。

​		

```sql
CREATE EXTERNAL TABLE dwd_refund_payment (
    `id` STRING COMMENT '编号',
    `user_id` STRING COMMENT '用户ID',
    `order_id` STRING COMMENT '订单编号',
    `sku_id` STRING COMMENT 'SKU编号',
    `province_id` STRING COMMENT '地区ID',
    `trade_no` STRING COMMENT '交易编号',
    `out_trade_no` STRING COMMENT '对外交易编号',
    `payment_type` STRING COMMENT '支付类型',
    `refund_amount` DECIMAL(16,2) COMMENT '退款金额',
    `refund_status` STRING COMMENT '退款状态',
    --商家同意退款时，退款操作的时间
    `create_time` STRING COMMENT '创建时间',--调用第三方支付接口的时间
    `callback_time` STRING COMMENT '回调时间'--支付接口回调时间，即支付成功时间
) COMMENT '退款事实表'
```



### 14.2 导入数据

#### 14.2.1 首日导入

```sql
INSERT overwrite table dwd_refund_payment partition(dt)
select
    orp.id,
    ooi.user_id,
    orp.order_id,
    orp.sku_id,
    ooi.province_id,
    orp.trade_no,
    orp.out_trade_no,
    orp.payment_type,
    orp.refund_amount,
    orp.refund_status,
    orp.create_time,
    orp.callback_time,
    date_format(nvl(orp.callback_time, '9999-99-99' ), 'yyyy-MM-dd')
from (
     select
         *
     from ods_refund_payment
    where dt = '2021-05-07'
         ) orp
left join (
    select
        id,
        user_id,
        province_id
    from ods_order_info
    where dt = '2021-05-07'
    ) ooi on orp.order_id = ooi.id;
```



#### 14.2.2 每日导入

```
with
    old as (
        select
            *
        from dwd_refund_payment
        where dt = '9999-99-99'
    ),
    new1 as (
        select
            *
        from ods_refund_payment
        where dt = '2021-05-08'
    ),
    ooi as (
        select
            id,
            user_id,
            province_id
        from ods_order_info
        where dt = '2021-05-08'
    )
insert overwrite table dwd_refund_payment partition(dt)
select
	nvl(new.id, old.id),
    nvl(new.user_id, old.user_id),
    nvl(new.order_id, old.order_id),
    nvl(new.sku_id, old.sku_id),
    nvl(new.province_id, old.province_id),
    nvl(new.trade_no, old.trade_no),
    nvl(new.out_trade_no, old.out_trade_no),
    nvl(new.payment_type, old.payment_type),
    nvl(new.refund_amount, old.refund_amount),
    nvl(new.refund_status, old.refund_status),
    nvl(new.create_time, old.create_time),
    nvl(new.callback_time, old.callback_time),
    nvl(date_format(nvl(new.callback_time, old.callback_time), 'yyyy-MM-dd'), '9999-99-99')
from  old full join
(select 
	 new1.id,
	 out_trade_no,
	 order_id,
	 sku_id,
	 payment_type,
	 trade_no,
	 refund_amount,
	 subject,
	 refund_status,
	 create_time,
	 callback_time,
	user_id ,province_id 
from  new1 left join ooi on new1.order_id = ooi.id ) new
on new.id = old.id;
```



## 15.dwd_order_info

主体：订单

粒度： 一笔订单是一行



分区：  完成的放入完成时间所在的分区，未完成放入9999-99-99



如何定义完成： 通过订单的状态

未完成：

- 1001： 未支付 ,不能过期
- 1002： 已支付
- 1005： 退款中



完成：

- 1003： 已取消

- 1004： 已完成 

- 1006： 退款完成

- 订单过期。未支付，未手动取消，只能判断出一笔订单一定过期！

  ​		一定过期：  未支付，未手动取消， expire_time  <=  当前日期0:00:00
  
  ​		
  
  ​		如果订单是在采集日期之前过期，一定可以将其视为完成，放入dt=当日的分区。
  
  ​		如果订单无法判断在采集之前之前是否过期，那么这个订单即便过期，依然放入dt=9999-99-99分区，原因在于后续不采集这条数据变化的状态，无法判断，后续是否过期。



expire_time如何生成：   订单一旦创建，立刻生成expire_time ， expirte 不为null

----

举例： 用户在 2021-05-03 下单且支付 ， 2021-05-08日 确认收货 ，  2021-05-09日发起退款，  2021-05-11退款成功。

/ods_order_status/2021-05-03 /  1001, order_status=1001

/ods_order_status/2021-05-03 /  1001, order_status=1002

/ods_order_status/2021-05-08 /  1001, order_status=1004

/ods_order_status/2021-05-09 /  1001, order_status=1005

/ods_order_status/2021-05-11 /  1001, order_status=1006

-----------



/dwd_order_info /  dt=9999-99-99       1001,  order_status=1002

转移

/dwd_order_info /  dt=2021-05-08    1001,  order_status=1004

转移

/dwd_order_info / dt=9999-99-99    1001,  order_status=1005

转移

/dwd_order_info / dt=2021-05-11    1001,  order_status=1006



结论： 和之前的累积型快照事实表不同, 之前非 dt=9999-99-99分区的数据，一定不会再发生变化！

​			order_info不仅需要修改 dt=9999-99-99 ，还需要修改之前已经完成的分区！



如何判断哪些之前完成的分区需要修改？

​		查询发起退款的订单，完成时间所在的分区 

​		  

### 15.0 业务逻辑过期时间问题

一定过期：  未支付，未手动取消， expire_time  <=  当前日期0:00:00 

​		

举例：  /ods_order_info /  dt=2021-05-13     

| id   | status         | create_time         | operate_time        | expire_time         |
| ---- | -------------- | ------------------- | ------------------- | ------------------- |
| 1001 | 1001（已下单） | 2021-05-13 23:50:50 | 2021-05-13 23:50:50 | 2021-05-14 00:20:50 |

​           /dwd_order_info /  dt=9999-99-99     



假设订单，到最后没有支付，过期了！

mysql:

| id   | status         | create_time         | operate_time        | expire_time         |
| ---- | -------------- | ------------------- | ------------------- | ------------------- |
| 1001 | 1001（已下单） | 2021-05-13 23:50:50 | 2021-05-13 23:50:50 | 2021-05-14 00:20:50 |

 同步新增和变化







### 15.1 建表

```sql
CREATE EXTERNAL TABLE dwd_order_info(
    --ods_order_info
    `id` STRING COMMENT '编号',
    `order_status` STRING COMMENT '订单状态',
    `user_id` STRING COMMENT '用户ID',
    `province_id` STRING COMMENT '地区ID',
    `payment_way` STRING COMMENT '支付方式',
    `delivery_address` STRING COMMENT '邮寄地址',
    `out_trade_no` STRING COMMENT '对外交易编号',
    `tracking_no` STRING COMMENT '物流单号',
    --ods_order_status_log
    `create_time` STRING COMMENT '创建时间(未支付状态)',
    `payment_time` STRING COMMENT '支付时间(已支付状态)',
    `cancel_time` STRING COMMENT '取消时间(已取消状态)',
    `finish_time` STRING COMMENT '完成时间(已完成状态)',
    `refund_time` STRING COMMENT '退款时间(退款中状态)',
    `refund_finish_time` STRING COMMENT '退款完成时间(退款完成状态)',
    `expire_time` STRING COMMENT '过期时间',
    `feight_fee` DECIMAL(16,2) COMMENT '运费',
    `feight_fee_reduce` DECIMAL(16,2) COMMENT '运费减免',
    `activity_reduce_amount` DECIMAL(16,2) COMMENT '活动减免',
    `coupon_reduce_amount` DECIMAL(16,2) COMMENT '优惠券减免',
    `original_amount` DECIMAL(16,2) COMMENT '订单原始价格',
    `final_amount` DECIMAL(16,2) COMMENT '订单最终价格'
) COMMENT '订单事实表'
```



### 15.2 导入数据

#### 15.2.1 首日导入

```sql
INSERT  overwrite table dwd_order_info  partition(dt)
SELECT 
	*,
	--判断订单是否完成
	case 
		when  cancel_time is null and payment_time is null and expire_time <= date_add('2021-05-07',1) then  date_format(expire_time,'yyyy-MM-dd')
		when  order_status = '1003' then   date_format(cancel_time,'yyyy-MM-dd')
		when   order_status = '1004'  then  date_format(finish_time,'yyyy-MM-dd')
		when   order_status = '1006'  then  date_format(refund_finish_time,'yyyy-MM-dd')
		else   '9999-99-99'
	end dt
from
( SELECT 
	id,
	order_status,
	user_id,
	province_id,
	payment_way,
	delivery_address,
	out_trade_no,
	tracking_no,
	create_time ,
	--map中key不存在，返回null
	times_map['1002'] payment_time,
	times_map['1003'] cancel_time,
	times_map['1004'] finish_time,
	times_map['1005'] refund_time,
	times_map['1006'] refund_finish_time,
	expire_time,
	feight_fee,
	feight_fee_reduce,
	activity_reduce_amount,
	coupon_reduce_amount,
	original_amount,
	final_amount
from
--dwd粒度：  一笔订单是1条
(select 
   * 
 from ods_order_info 
 where dt='2021-05-07' ) order_info
 LEFT  join
 (select 
 	--将 array<string> -- concat_ws --string --------str_to_map  转换  map
    order_id,str_to_map(concat_ws(',',COLLECT_list(concat(order_status ,':',operate_time ) ))) times_map
    --先改变粒度，将粒度变为1笔订单的所有状态是一条
  from ods_order_status_log 
  --一笔订单的一个状态是一条
  where dt='2021-05-07'
  GROUP by order_id ) order_status 
  on order_info.id = order_status.order_id ) tmp
```

#### 15.2.2 每日导入

思路：  dwd(dt=9999-99-99  or  dt= 查询发起退款的订单，完成时间所在的分区  )   full  join   ods    ,更新字段， 覆盖写入。



```sql
with 
ods_data as
( SELECT 
	id,
	order_status,
	user_id,
	province_id,
	payment_way,
	delivery_address,
	out_trade_no,
	tracking_no,
	create_time ,
	--map中key不存在，返回null
	times_map['1002'] payment_time,
	times_map['1003'] cancel_time,
	times_map['1004'] finish_time,
	times_map['1005'] refund_time,
	times_map['1006'] refund_finish_time,
	expire_time,
	feight_fee,
	feight_fee_reduce,
	activity_reduce_amount,
	coupon_reduce_amount,
	original_amount,
	final_amount
from
--dwd粒度：  一笔订单是1条
(select 
   * 
 from ods_order_info 
 where dt='2021-05-08' ) order_info
 LEFT  join
 (select 
 	--将 array<string> -- concat_ws --string --------str_to_map  转换  map
    order_id,str_to_map(concat_ws(',',COLLECT_list(concat(order_status ,':',operate_time ) ))) times_map
    --先改变粒度，将粒度变为1笔订单的所有状态是一条
  from ods_order_status_log 
  --一笔订单的一个状态是一条
  where dt='2021-05-08'
  GROUP by order_id ) order_status 
  on order_info.id = order_status.order_id ),
dwd_data as (
  
  	select
  		*
  	from  dwd_order_info 
  	where  dt in 
  	(
  	  -- 查询今日发起退款的订单，完成时间所在的分区
  	  
  	  --查询这些订单的 完成时间
  	  SELECT 
  	  		DISTINCT date_format(operate_time,'yyyy-MM-dd') 
  	  from ods_order_status_log
  	  -- 规定一笔订单15之内必须完成
  	  where dt  >= date_sub('2021-05-08',14) 
  	  and order_status = '1004' 
  	  and order_id in
  	   (select
  	   		order_id
  	   from ods_order_status_log 
  	   where dt='2021-05-08' and order_status = '1005' )
  	
  	)
  	or dt='9999-99-99'
 
  )
  INSERT  overwrite table dwd_order_info  partition(dt)
 select 
  		*,
  		--判断订单是否完成
	case 
		when  cancel_time is null and payment_time is null and expire_time <= date_add('2021-05-08',1)  then  date_format(expire_time,'yyyy-MM-dd')
		when  order_status = '1003' then   date_format(cancel_time,'yyyy-MM-dd')
		when   order_status = '1004'  then  date_format(finish_time,'yyyy-MM-dd')
		when   order_status = '1006'  then  date_format(refund_finish_time,'yyyy-MM-dd')
		else   '9999-99-99'
	end dt
  from
  (select
  		--使用ods_data 更新  dwd_data
  		if(ods_data.id is not null , ods_data.id , dwd_data.id ) id,
		if(ods_data.id is not null , ods_data.order_status , dwd_data.order_status ) order_status,
		if(ods_data.id is not null , ods_data.user_id , dwd_data.user_id ) user_id,
		if(ods_data.id is not null , ods_data.province_id , dwd_data.province_id ) province_id,
		if(ods_data.id is not null , ods_data.payment_way , dwd_data.payment_way ) payment_way,
		if(ods_data.id is not null , ods_data.delivery_address , dwd_data.delivery_address ) delivery_address,
		if(ods_data.id is not null , ods_data.out_trade_no , dwd_data.out_trade_no ) out_trade_no,
		if(ods_data.id is not null , ods_data.tracking_no , dwd_data.tracking_no ) tracking_no,
		if(ods_data.id is not null , ods_data.create_time , dwd_data.create_time ) create_time,
		if(ods_data.id is not null , ods_data.payment_time , dwd_data.payment_time ) payment_time,
		if(ods_data.id is not null , ods_data.cancel_time , dwd_data.cancel_time ) cancel_time,
		if(ods_data.id is not null , ods_data.finish_time , dwd_data.finish_time ) finish_time,
		if(ods_data.id is not null , ods_data.refund_time , dwd_data.refund_time ) refund_time,
		if(ods_data.id is not null , ods_data.refund_finish_time , dwd_data.refund_finish_time ) refund_finish_time,
		if(ods_data.id is not null , ods_data.expire_time , dwd_data.expire_time ) expire_time,
		if(ods_data.id is not null , ods_data.feight_fee , dwd_data.feight_fee ) feight_fee,
		if(ods_data.id is not null , ods_data.feight_fee_reduce , dwd_data.feight_fee_reduce ) feight_fee_reduce,
		if(ods_data.id is not null , ods_data.activity_reduce_amount , dwd_data.activity_reduce_amount ) activity_reduce_amount,
		if(ods_data.id is not null , ods_data.coupon_reduce_amount , dwd_data.coupon_reduce_amount ) coupon_reduce_amount,
		if(ods_data.id is not null , ods_data.original_amount , dwd_data.original_amount ) original_amount,
		if(ods_data.id is not null , ods_data.final_amount , dwd_data.final_amount ) final_amount
  		
  from dwd_data full join ods_data
  on dwd_data.id = ods_data.id ) tmp 
```



# 四、DWS层

## 1.整体思路

### 1.1 建模

DWS 和DWT 都可以称为数据服务层。

​		数据服务层是为ADS层的需求提供数据之前，在DWS层将数据进行轻度聚合，聚合之后，只需要稍稍处理，就可以满足ADS层数据的需要。



DWS和DWT 和 ADS层的需求紧密相关！



--------

举例：  ADS层有这样一些需求：

求：   每日访问的设备数量

​			每日访问的新设备数量

​			每日下单的设备数量

​			截至到当前累积的下单的设备数量

​			每日商品销售前10排名

​			截至到当前商品销售前10排名

​				每日商品收藏前10排名

​         截至到当前商品收藏前10排名



----

DWS是按照天，将指定维度的数据进行轻度聚合！

DWT是累积，对指定维度的数据进行聚合！



--------

如何建模？

​		①将ADS层的需求，按照维度进行分类

​					设备 ，  商品 

​		②基于分类的维度，在DWS和DWT层进行建表，以分类的维度作为表中的实体，确定表的粒度。

​			根据需求设置字段

| 表名                    | 主体 | 粒度           | 主键   | 字段                                                         |      |
| ----------------------- | ---- | -------------- | ------ | ------------------------------------------------------------ | ---- |
| dws_设备_actiondaycount | 设备 | 一个设备是一行 | mid_id | login_count（访问次数），order_count(下单次数)，is_new(是否是新设备) |      |
| dws_商品actiondaycount  | 商品 | 一个商品是一行 | sku_id | pay_count(支付次数), favor_count(收藏次数)                   |      |
| dwt_设备_actiondaycount | 设备 | 一个设备是一行 | mid_id | total_order_count(累积下单次数)                              |      |
| dwt_商品actiondaycount  | 商品 | 一个商品是一行 | sku_id | total_pay_count(总支付次数)，total_favor_count(总收藏次数)   |      |

​				③确定表的其他特征

​						都是外部表

​						使用parquet+lzo压缩存储

​						都是分区表

​				④如何确定分区

​						dws:  根据统计的数据的日期分区

​						dwt:     

​									a)无需分区，可以，容错率低

​								    b) 分区，为了保留至少一天的一个副本，以便将来由于数据质量问题需要回滚时，操作简单

​														带来额外的冗余存储，因为不建议保留太多的副本，在新的数据产生时，将过期的副本分区删除

​				



​					

​	                

## 2.dws_visitor_action_daycount

访客：  访问商城应用程序的设备(手机，电脑浏览器，平板)

主体： 设备

粒度： 一个设备是一行



分区：  将每天聚合的数据放入每天的数据，根据数据的日期分区！



思路：  每天聚合，需要从目标表查询指定的数据，按照表的主体进行聚合

​					group by  mid_id

### 2.1 建表

访问：   a)   第一次打开设备，访问的第一个页面，算1次访问  (采取)

​				b)  每启动一次app，算一次访问

```sql
CREATE EXTERNAL TABLE dws_visitor_action_daycount
(
    --dwd_page_log
    `mid_id` STRING COMMENT '设备id',
    `brand` STRING COMMENT '设备品牌',
    `model` STRING COMMENT '设备型号',
    `is_new` STRING COMMENT '是否首次访问',
    `channel` ARRAY<STRING> COMMENT '渠道',
    `os` ARRAY<STRING> COMMENT '操作系统',
    `area_code` ARRAY<STRING> COMMENT '地区ID',
    `version_code` ARRAY<STRING> COMMENT '应用版本',
    `visit_count` BIGINT COMMENT '访问次数',
    --dwd_page_log
    `page_stats` ARRAY<STRUCT<page_id:STRING,page_count:BIGINT,during_time:BIGINT>> COMMENT '页面访问统计'
) COMMENT '每日设备行为表'
```



### 2.2 导入数据

```sql
INSERT  overwrite table dws_visitor_action_daycount partition(dt='2021-05-07')
	SELECT 
		t1.mid_id, brand, model, is_new, channel, os, area_code,
		version_code, visit_count, page_stats

    from
    (SELECT 
    	mid_id ,  
    	concat_ws('|',collect_set(brand)) brand,
    	concat_ws('|',collect_set(model)) model,
    	-- is_new 是否首次访问,是否是安装后的第一次访问    只有有0，就是0 ，否则就是1
    	if(sum(if(is_new='0',1,0)) >= 1 , '0','1') is_new ,
    	collect_set(channel) channel,
    	collect_set(os) os,
    	collect_set(area_code) area_code,
    	collect_set(version_code) version_code,
    	-- 第一次访问页面的次数，如果从一个页面跳到另一个页面，不算
    	sum(if(last_page_id  is null ,1,0)) visit_count
    	-- 一个设备访问一次页面的行为记录
    from dwd_page_log 
    where dt='2021-05-07'
    GROUP  by mid_id  )  t1
    left join
    (select 
    	mid_id,COLLECT_list(page_struct) page_stats
    from
    (select
       mid_id ,named_struct('page_id',page_id ,'page_count', count(*) ,'during_time',sum(during_time ))  page_struct
    from dwd_page_log 
    where dt='2021-05-07'
    GROUP  by mid_id ,page_id ) tmp
    GROUP  by mid_id  ) t2
    on t1.mid_id = t2.mid_id
```





## 3.dws_user_action_daycount

user：  在商城上注册的用户

主体： user

粒度： 一个user是一行



范围： 当日产生了行为的用户



取：  取当日登录的用户信息   left  join   其他行为的用户信息

### 3.1 建表

```sql
CREATE EXTERNAL TABLE dws_user_action_daycount
(
    `user_id` STRING COMMENT '用户id',
    -- dwd_page_log  where user_id is not null
    `login_count` BIGINT COMMENT '登录次数',
    --dwd_action_log  action_id= cart_add, favor_add
    `cart_count` BIGINT COMMENT '加入购物车次数',
    `favor_count` BIGINT COMMENT '收藏次数',
    -- dwd_order_detail
    `order_count` BIGINT COMMENT '下单次数',
    `order_activity_count` BIGINT COMMENT '订单参与活动次数',
    `order_activity_reduce_amount` DECIMAL(16,2) COMMENT '订单减免金额(活动)',
    `order_coupon_count` BIGINT COMMENT '订单用券次数',
    `order_coupon_reduce_amount` DECIMAL(16,2) COMMENT '订单减免金额(优惠券)',
    `order_original_amount` DECIMAL(16,2)  COMMENT '订单单原始金额',
    `order_final_amount` DECIMAL(16,2) COMMENT '订单总金额',
    -- dwd_payment_info
    `payment_count` BIGINT COMMENT '支付次数',
    `payment_amount` DECIMAL(16,2) COMMENT '支付金额',
   --dwd_refund_order_info
    `refund_order_count` BIGINT COMMENT '退单次数',
    `refund_order_num` BIGINT COMMENT '退单件数',
    `refund_order_amount` DECIMAL(16,2) COMMENT '退单金额',
    --dwd_refund_payment   关联  dwd_refund_order_info 取件数
    `refund_payment_count` BIGINT COMMENT '退款次数',
    `refund_payment_num` BIGINT COMMENT '退款件数',
    `refund_payment_amount` DECIMAL(16,2) COMMENT '退款金额',
    --dwd_coupon_use
    `coupon_get_count` BIGINT COMMENT '优惠券领取次数',
    `coupon_using_count` BIGINT COMMENT '优惠券使用(下单)次数',
    `coupon_used_count` BIGINT COMMENT '优惠券使用(支付)次数',
    -- dwd_comment_info
    `appraise_good_count` BIGINT COMMENT '好评数',
    `appraise_mid_count` BIGINT COMMENT '中评数',
    `appraise_bad_count` BIGINT COMMENT '差评数',
    `appraise_default_count` BIGINT COMMENT '默认评价数',
    -- dwd_order_detail
    `order_detail_stats` array<struct<sku_id:string,sku_num:bigint,order_count:bigint,activity_reduce_amount:decimal(16,2),coupon_reduce_amount:decimal(16,2),original_amount:decimal(16,2),final_amount:decimal(16,2)>> COMMENT '下单明细统计'
) COMMENT '每日用户行为'
```



### 3.2 导入数据

#### 3.2.1 首日导入

```sql
INSERT overwrite table dws_user_action_daycount partition(dt)
select 
    user_id ,
    sum(login_count),
	sum(cart_count),
	sum(favor_count),
	sum(order_count),
	sum(order_activity_count),
	sum(order_activity_reduce_amount),
	sum(order_coupon_count),
	sum(order_coupon_reduce_amount),
	sum(order_original_amount),
	sum(order_final_amount),
	sum(payment_count),
	sum(payment_amount),
	sum(refund_order_count),
	sum(refund_order_num),
	sum(refund_order_amount),
	sum(refund_payment_count),
	sum(refund_payment_num),
	sum(refund_payment_amount),
	sum(coupon_get_count),
	sum(coupon_using_count),
	sum(coupon_used_count),
	sum(appraise_good_count),
	sum(appraise_mid_count),
	sum(appraise_bad_count),
	sum(appraise_default_count),
	min(if(order_detail_stats[0].sku_id = '-1',null, order_detail_stats)) order_detail_stats,
	dt
from
(
select 
	user_id ,dt,
		0 login_count,
		0 cart_count,
		0 favor_count,
	0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
			0 payment_count,
			0 payment_amount,
			0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
			0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
	collect_list(sku_struct) order_detail_stats
from
(select
  user_id , dt,
  named_struct('sku_id',sku_id,'sku_num',sum(sku_num),'order_count',count(*),
  -- sum求和后的返回值 是 decimal(26,2)
  'activity_reduce_amount',cast(sum(split_activity_amount) as decimal(16,2))
  ,'coupon_reduce_amount',cast(sum(split_coupon_amount) as decimal(16,2)),
  'original_amount', cast(sum(original_amount) as decimal(16,2)),
  'final_amount',cast (sum(split_final_amount) as decimal(16,2)) ) sku_struct
 
from  dwd_order_detail 
--统计每个用户每天下单每个商品的信息
group by user_id , sku_id ,dt ) t1
group by user_id ,dt
UNION  all 
SELECT 
	 user_id,dt,
	 0 login_count,
		0 cart_count,
		0 favor_count,
		0 order_count,
		0 order_activity_count,
		0 order_activity_reduce_amount,
		0 order_coupon_count,
		0 order_coupon_reduce_amount,
		0 order_original_amount,
		0 order_final_amount,
		0 payment_count,
		0 payment_amount,
		0 refund_order_count,
		0 refund_order_num,
		0 refund_order_amount,
		0 refund_payment_count,
		0 refund_payment_num,
		0 refund_payment_amount,
	 sum(coupon_get_count) coupon_get_count ,
	 sum(coupon_using_count) coupon_using_count,
	 sum(coupon_used_count) coupon_used_count,
	 0 appraise_good_count,
		0 appraise_mid_count,
		0 appraise_bad_count,
		0 appraise_default_count,
		array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
from
    (SELECT 
    	--求每日领券的数据
    	user_id,
    	date_format(get_time ,'yyyy-MM-dd') dt,
    	count(*) coupon_get_count,
    	 0 coupon_using_count,
		  0 coupon_used_count
		 
    from dwd_coupon_use 
    group by user_id , date_format(get_time ,'yyyy-MM-dd')
    UNION all
     SELECT 
    	--求每日领券的数据
    	user_id,
    	date_format(using_time ,'yyyy-MM-dd') dt,
    	0 coupon_get_count,
    	count(*) coupon_using_count,
    	 0 coupon_used_count
		 
    	
    from dwd_coupon_use 
    where using_time  is not null
    group by user_id, date_format(using_time ,'yyyy-MM-dd') 
    UNION all
     SELECT 
    	--求每日领券的数据
    	user_id,
    	date_format(used_time ,'yyyy-MM-dd') dt,
    	 0 coupon_get_count,
    	 0 coupon_using_count,
    	count(*) coupon_used_count
    	
    	
    from dwd_coupon_use 
    where used_time  is not null
    group by user_id, date_format(used_time ,'yyyy-MM-dd') 
     ) tmp 
  GROUP  by  user_id,dt
union all
select
	user_id,  '2021-05-07'  dt,
	count(*) login_count,
	0 cart_count,
		0 favor_count,
		0 order_count,
		0 order_activity_count,
		0 order_activity_reduce_amount,
		0 order_coupon_count,
		0 order_coupon_reduce_amount,
		0 order_original_amount,
		0 order_final_amount,
		0 payment_count,
		0 payment_amount,
		0 refund_order_count,
		0 refund_order_num,
		0 refund_order_amount,
		0 refund_payment_count,
		0 refund_payment_num,
		0 refund_payment_amount,
		0 coupon_get_count,
		0 coupon_using_count,
		0 coupon_used_count,
		0 appraise_good_count,
		0 appraise_mid_count,
		0 appraise_bad_count,
		0 appraise_default_count,
		array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats

from dwd_page_log 
where dt='2021-05-07' and user_id is not NULL 
--过滤出登录访问首个页面的记录
		and  last_page_id is null
GROUP  by user_id 
UNION  ALL 
select
	 user_id ,dt,
	     0 login_count,
			0 cart_count,
			0 favor_count,
	 count(DISTINCT order_id) order_count,
	 -- 一笔订单可以购买多个商品，每个商品可以参加不同的活动，一笔订单可以参与多个活动
	 sum(if(activity_rule_id is null,0,1)) order_activity_count,
	 sum(if(activity_rule_id is null,0,split_activity_amount)) order_activity_reduce_amount,
	 sum(if(coupon_id is null,0,1)) order_coupon_count,
	  sum(if(coupon_id is null,0,split_coupon_amount)) order_coupon_reduce_amount,
	  sum(original_amount) order_original_amount,
	  sum(split_final_amount) order_final_amount,
	  	0 payment_count,
			0 payment_amount,
			0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
			0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
			array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
	
from dwd_order_detail
--一个用户下单的一个商品是一行
group by user_id ,dt
UNION  ALL 
SELECT 
	user_id ,dt,
	0 login_count,
			0 cart_count,
			0 favor_count,
			0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
	count(*) payment_count,
	sum(payment_amount ) payment_amount,
	0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
			0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
			array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
from dwd_payment_info 
where dt <= '2021-05-07'
GROUP by user_id ,dt
UNION  ALL 
select
	user_id ,dt,
		0 login_count,
			0 cart_count,
			0 favor_count,
			0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
			0 payment_count,
			0 payment_amount,
	count(*) refund_order_count,
	sum(refund_num) refund_order_num,
	sum(refund_amount) refund_order_amount,
	 0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
			array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
	
from dwd_order_refund_info 
group by user_id ,dt
UNION  ALL 
select 
	rp.user_id ,dt,
	0 login_count,
			0 cart_count,
			0 favor_count,
			0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
			0 payment_count,
			0 payment_amount,
			0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
	count(*) refund_payment_count,
	sum(refund_num) refund_payment_num,
	sum(refund_amount) refund_payment_amount,
	0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
			array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
from
(
--取所有退款完成的退款信息
select
	order_id,user_id ,sku_id,
	refund_amount,dt
from dwd_refund_payment 
where dt <= '2021-05-07') rp
left join 
(select order_id , user_id ,sku_id ,refund_num from  dwd_order_refund_info) ri
on rp.order_id =ri.order_id   and rp.sku_id=ri.sku_id
GROUP by rp.user_id ,dt
UNION  ALL 
select
	user_id,'2021-05-07',
	0 login_count,
	sum(if(action_id='cart_add',1,0)) cart_count,
	sum(if(action_id='favor_add',1,0)) favor_count,
	0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
			0 payment_count,
			0 payment_amount,
			0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
			0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
			array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
from dwd_action_log 
--取首日的收藏和加购的用户行为
where dt='2021-05-07' and action_id in ('cart_add','favor_add')
		and user_id is not null
GROUP by user_id 
UNION  ALL 
select
	user_id ,dt,
			0 login_count,
			0 cart_count,
			0 favor_count,
			0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
			0 payment_count,
			0 payment_amount,
			0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
			0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
	sum(if(appraise ='1201',1, 0)) appraise_good_count,
	sum(if(appraise ='1202',1, 0)) appraise_mid_count,
	sum(if(appraise ='1203',1, 0)) appraise_bad_count,
	sum(if(appraise ='1204',1, 0)) appraise_default_count,
	array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
from dwd_comment_info 
group by user_id ,dt ) tmp
GROUP by user_id ,dt
```



#### 3.2.2 每日导入

```sql
INSERT overwrite table dws_user_action_daycount partition(dt='2021-05-08')
select 
    user_id ,
    sum(login_count),
	sum(cart_count),
	sum(favor_count),
	sum(order_count),
	sum(order_activity_count),
	sum(order_activity_reduce_amount),
	sum(order_coupon_count),
	sum(order_coupon_reduce_amount),
	sum(order_original_amount),
	sum(order_final_amount),
	sum(payment_count),
	sum(payment_amount),
	sum(refund_order_count),
	sum(refund_order_num),
	sum(refund_order_amount),
	sum(refund_payment_count),
	sum(refund_payment_num),
	sum(refund_payment_amount),
	sum(coupon_get_count),
	sum(coupon_using_count),
	sum(coupon_used_count),
	sum(appraise_good_count),
	sum(appraise_mid_count),
	sum(appraise_bad_count),
	sum(appraise_default_count),
	min(if(order_detail_stats[0].sku_id = '-1',null, order_detail_stats)) order_detail_stats
from
(
select 
	user_id ,
		0 login_count,
		0 cart_count,
		0 favor_count,
	0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
			0 payment_count,
			0 payment_amount,
			0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
			0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
	collect_list(sku_struct) order_detail_stats
from
(select
  user_id ,
  named_struct('sku_id',sku_id,'sku_num',sum(sku_num),'order_count',count(*),
  -- sum求和后的返回值 是 decimal(26,2)
  'activity_reduce_amount',cast(sum(split_activity_amount) as decimal(16,2))
  ,'coupon_reduce_amount',cast(sum(split_coupon_amount) as decimal(16,2)),
  'original_amount', cast(sum(original_amount) as decimal(16,2)),
  'final_amount',cast (sum(split_final_amount) as decimal(16,2)) ) sku_struct
 
from  dwd_order_detail 
where dt='2021-05-08'
--统计每个用户每天下单每个商品的信息
group by user_id , sku_id  ) t1
group by user_id 
UNION  all 
SELECT 
	 user_id,
	 0 login_count,
		0 cart_count,
		0 favor_count,
		0 order_count,
		0 order_activity_count,
		0 order_activity_reduce_amount,
		0 order_coupon_count,
		0 order_coupon_reduce_amount,
		0 order_original_amount,
		0 order_final_amount,
		0 payment_count,
		0 payment_amount,
		0 refund_order_count,
		0 refund_order_num,
		0 refund_order_amount,
		0 refund_payment_count,
		0 refund_payment_num,
		0 refund_payment_amount,
	 sum(if(date_format(get_time,'yyyy-MM-dd')='2021-05-08' , 1, 0)) coupon_get_count ,
	 sum(if(date_format(using_time,'yyyy-MM-dd')='2021-05-08' , 1, 0)) coupon_using_count ,
	 sum(if(date_format(used_time,'yyyy-MM-dd')='2021-05-08' , 1, 0)) coupon_used_count ,
	 0 appraise_good_count,
		0 appraise_mid_count,
		0 appraise_bad_count,
		0 appraise_default_count,
		array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
from  dwd_coupon_use
--取今天采集的领券行为
where dt='2021-05-08' or dt='9999-99-99'
   
  GROUP  by  user_id,dt
union all
select
	user_id,  
	count(*) login_count,
	0 cart_count,
		0 favor_count,
		0 order_count,
		0 order_activity_count,
		0 order_activity_reduce_amount,
		0 order_coupon_count,
		0 order_coupon_reduce_amount,
		0 order_original_amount,
		0 order_final_amount,
		0 payment_count,
		0 payment_amount,
		0 refund_order_count,
		0 refund_order_num,
		0 refund_order_amount,
		0 refund_payment_count,
		0 refund_payment_num,
		0 refund_payment_amount,
		0 coupon_get_count,
		0 coupon_using_count,
		0 coupon_used_count,
		0 appraise_good_count,
		0 appraise_mid_count,
		0 appraise_bad_count,
		0 appraise_default_count,
		array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats

from dwd_page_log 
where dt='2021-05-08' and user_id is not NULL 
--过滤出登录访问首个页面的记录
		and  last_page_id is null
GROUP  by user_id 
UNION  ALL 
select
	 user_id ,
	     0 login_count,
			0 cart_count,
			0 favor_count,
	 count(DISTINCT order_id) order_count,
	 -- 一笔订单可以购买多个商品，每个商品可以参加不同的活动，一笔订单可以参与多个活动
	 sum(if(activity_rule_id is null,0,1)) order_activity_count,
	 sum(if(activity_rule_id is null,0,split_activity_amount)) order_activity_reduce_amount,
	 sum(if(coupon_id is null,0,1)) order_coupon_count,
	  sum(if(coupon_id is null,0,split_coupon_amount)) order_coupon_reduce_amount,
	  sum(original_amount) order_original_amount,
	  sum(split_final_amount) order_final_amount,
	  	0 payment_count,
			0 payment_amount,
			0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
			0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
			array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
	
from dwd_order_detail
where dt = '2021-05-08'
--一个用户下单的一个商品是一行
group by user_id 
UNION  ALL 
SELECT 
	user_id ,
	0 login_count,
			0 cart_count,
			0 favor_count,
			0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
	count(*) payment_count,
	sum(payment_amount ) payment_amount,
	0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
			0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
			array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
from dwd_payment_info 
where dt = '2021-05-08'
GROUP by user_id 
UNION  ALL 
select
	user_id ,
		0 login_count,
			0 cart_count,
			0 favor_count,
			0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
			0 payment_count,
			0 payment_amount,
	count(*) refund_order_count,
	sum(refund_num) refund_order_num,
	sum(refund_amount) refund_order_amount,
	 0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
			array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
	
from dwd_order_refund_info 
where dt = '2021-05-08'
group by user_id 
UNION  ALL 
select 
	rp.user_id ,
	0 login_count,
			0 cart_count,
			0 favor_count,
			0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
			0 payment_count,
			0 payment_amount,
			0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
	count(*) refund_payment_count,
	sum(refund_num) refund_payment_num,
	sum(refund_amount) refund_payment_amount,
	0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
			array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
from
(
--取所有退款完成的退款信息
select
	order_id,user_id ,sku_id,
	refund_amount
from dwd_refund_payment 
where dt = '2021-05-08') rp
left join 
-- 不确定今天退款的商品是什么时候申请退单的，根据业务的限制来取
(select order_id , user_id ,sku_id ,refund_num 
from  dwd_order_refund_info
where dt > date_sub('2021-05-08',15)) ri
on rp.order_id =ri.order_id   and rp.sku_id=ri.sku_id
GROUP by rp.user_id 
UNION  ALL 
select
	user_id,
	0 login_count,
	sum(if(action_id='cart_add',1,0)) cart_count,
	sum(if(action_id='favor_add',1,0)) favor_count,
	0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
			0 payment_count,
			0 payment_amount,
			0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
			0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
			0 appraise_good_count,
			0 appraise_mid_count,
			0 appraise_bad_count,
			0 appraise_default_count,
			array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
from dwd_action_log 
--取首日的收藏和加购的用户行为
where dt='2021-05-08' and action_id in ('cart_add','favor_add')
		and user_id is not null
GROUP by user_id 
UNION  ALL 
select
	user_id ,
			0 login_count,
			0 cart_count,
			0 favor_count,
			0 order_count,
			0 order_activity_count,
			0 order_activity_reduce_amount,
			0 order_coupon_count,
			0 order_coupon_reduce_amount,
			0 order_original_amount,
			0 order_final_amount,
			0 payment_count,
			0 payment_amount,
			0 refund_order_count,
			0 refund_order_num,
			0 refund_order_amount,
			0 refund_payment_count,
			0 refund_payment_num,
			0 refund_payment_amount,
			0 coupon_get_count,
			0 coupon_using_count,
			0 coupon_used_count,
	sum(if(appraise ='1201',1, 0)) appraise_good_count,
	sum(if(appraise ='1202',1, 0)) appraise_mid_count,
	sum(if(appraise ='1203',1, 0)) appraise_bad_count,
	sum(if(appraise ='1204',1, 0)) appraise_default_count,
	array(named_struct('sku_id', '-1','sku_num', cast( 0 as bigint ),'order_count', cast( 0 as bigint ),'activity_reduce_amount', cast (0.0 as decimal(16,2)), 'coupon_reduce_amount', cast (0.0 as decimal(16,2)), 'original_amount', cast (0.0 as decimal(16,2)), 'final_amount', cast (0.0 as decimal(16,2)))) order_detail_stats
from dwd_comment_info 
where dt='2021-05-08'
group by user_id ) tmp
GROUP by user_id
```





## 4.dws_sku_action_daycount

主体：商品

粒度：一个商品是一行



范围： 今天产生了行为的商品



下单： sku1，sku2,sku3

支付：  sku1,sku2

评论： sku4



今天产生了行为的商品: sku1,sku2,sku3,sku4

-----------------------------------







### 4.1 建表

```sql
CREATE EXTERNAL TABLE dws_sku_action_daycount
(
    `sku_id` STRING COMMENT 'sku_id',
    -- dwd_order_detail
    `order_count` BIGINT COMMENT '被下单次数',
    `order_num` BIGINT COMMENT '被下单件数',
    `order_activity_count` BIGINT COMMENT '参与活动被下单次数',
    `order_coupon_count` BIGINT COMMENT '使用优惠券被下单次数',
    `order_activity_reduce_amount` DECIMAL(16,2) COMMENT '优惠金额(活动)',
    `order_coupon_reduce_amount` DECIMAL(16,2) COMMENT '优惠金额(优惠券)',
    `order_original_amount` DECIMAL(16,2) COMMENT '被下单原价金额',
    `order_final_amount` DECIMAL(16,2) COMMENT '被下单最终金额',
    
     -- 确保订单一定被支付了，再统计
    --dwd_order_detail  join  dwd_payment_info 关联 ，按照支付的日期进行统计   dwd跨天支付（不同于ods层跨天支付）
    `payment_count` BIGINT COMMENT '被支付次数',
    `payment_num` BIGINT COMMENT '被支付件数',
    `payment_amount` DECIMAL(16,2) COMMENT '被支付金额',
    
    -- dwd_refund_order_info
    `refund_order_count` BIGINT  COMMENT '被退单次数',
    `refund_order_num` BIGINT COMMENT '被退单件数',
    `refund_order_amount` DECIMAL(16,2) COMMENT '被退单金额',
    
     --dwd_refund_payment  refund_payment_num 需要关联 dwd_refund_order_info确定
    `refund_payment_count` BIGINT  COMMENT '被退款次数',
    `refund_payment_num` BIGINT COMMENT '被退款件数',
    `refund_payment_amount` DECIMAL(16,2) COMMENT '被退款金额',
    -- dwd_action_log
    `cart_count` BIGINT COMMENT '被加入购物车次数',
    `favor_count` BIGINT COMMENT '被收藏次数',
    
    -- dwd_comment_log
    `appraise_good_count` BIGINT COMMENT '好评数',
    `appraise_mid_count` BIGINT COMMENT '中评数',
    `appraise_bad_count` BIGINT COMMENT '差评数',
    `appraise_default_count` BIGINT COMMENT '默认评价数'
) COMMENT '每日商品行为'
```





### 4.2 导入数据

#### 4.2.1 首日导入

```sql
INSERT overwrite table dws_sku_action_daycount partition(dt)
select 
		sku_id ,
		sum(order_count),
	sum(order_num),
	sum(order_activity_count),
	sum(order_coupon_count),
	sum(order_activity_reduce_amount),
	sum(order_coupon_reduce_amount),
	sum(order_original_amount),
	sum(order_final_amount),
	sum(payment_count),
	sum(payment_num),
	sum(payment_amount),
	sum(refund_order_count),
	sum(refund_order_num),
	sum(refund_order_amount),
	sum(refund_payment_count),
	sum(refund_payment_num),
	sum(refund_payment_amount),
	sum(cart_count),
	sum(favor_count),
	sum(appraise_good_count),
	sum(appraise_mid_count),
	sum(appraise_bad_count),
	sum(appraise_default_count),
	dt
from
(select
	 sku_id ,dt,
	 count(*) order_count,
	 sum(sku_num ) order_num,
	 sum(if(activity_rule_id is null,0,1)) order_activity_count,
	 sum(if(coupon_id is null,0,1)) order_coupon_count,
	 sum(if(activity_rule_id is null,0,split_activity_amount)) order_activity_reduce_amount,
	  sum(if(coupon_id is null,0,split_coupon_amount)) order_coupon_reduce_amount,
	  sum(original_amount) order_original_amount,
	  sum(split_final_amount) order_final_amount,
	  0 payment_count,
				0 payment_num,
				0 payment_amount,
				0 refund_order_count,
				0 refund_order_num,
				0 refund_order_amount,
				0 refund_payment_count,
				0 refund_payment_num,
				0 refund_payment_amount,
				0 cart_count,
				0 favor_count,
				0 appraise_good_count,
				0 appraise_mid_count,
				0 appraise_bad_count,
				0 appraise_default_count
from dwd_order_detail 
group by sku_id ,dt
UNION  ALL 
select
	sku_id,dt,
	0 order_count,
				0 order_num,
				0 order_activity_count,
				0 order_coupon_count,
				0 order_activity_reduce_amount,
				0 order_coupon_reduce_amount,
				0 order_original_amount,
				0 order_final_amount,
	count(*) payment_count,
	sum(sku_num) payment_num,
	sum(split_final_amount) payment_amount,
	0 refund_order_count,
				0 refund_order_num,
				0 refund_order_amount,
				0 refund_payment_count,
				0 refund_payment_num,
				0 refund_payment_amount,
				0 cart_count,
				0 favor_count,
				0 appraise_good_count,
				0 appraise_mid_count,
				0 appraise_bad_count,
				0 appraise_default_count
from 
-- 所有支付的订单
(select
   	sku_id ,order_id ,sku_num ,split_final_amount
from dwd_order_detail ) od
join  
(select order_id,dt  from  dwd_payment_info where dt <='2021-05-07'  ) pi
on od.order_id = pi.order_id
GROUP by sku_id,dt
UNION  ALL 
select
	sku_id ,dt,
		0 order_count,
				0 order_num,
				0 order_activity_count,
				0 order_coupon_count,
				0 order_activity_reduce_amount,
				0 order_coupon_reduce_amount,
				0 order_original_amount,
				0 order_final_amount,
				0 payment_count,
				0 payment_num,
				0 payment_amount,
	count(*) refund_order_count,
	sum(refund_num) refund_order_num,
	sum(refund_amount) refund_order_amount,
	0 refund_payment_count,
				0 refund_payment_num,
				0 refund_payment_amount,
				0 cart_count,
				0 favor_count,
				0 appraise_good_count,
				0 appraise_mid_count,
				0 appraise_bad_count,
				0 appraise_default_count
from dwd_order_refund_info 
group by sku_id ,dt
UNION  ALL 
select 
	rp.sku_id ,dt,
	0 order_count,
				0 order_num,
				0 order_activity_count,
				0 order_coupon_count,
				0 order_activity_reduce_amount,
				0 order_coupon_reduce_amount,
				0 order_original_amount,
				0 order_final_amount,
				0 payment_count,
				0 payment_num,
				0 payment_amount,
				0 refund_order_count,
				0 refund_order_num,
				0 refund_order_amount,
	--被退款的单数
	--count(DISTINCT order_id )
	count(*) refund_payment_count,
	sum(refund_num) refund_payment_num,
	sum(refund_amount) refund_payment_amount,
	0 cart_count,
				0 favor_count,
				0 appraise_good_count,
				0 appraise_mid_count,
				0 appraise_bad_count,
				0 appraise_default_count
from
(
--取所有退款完成的退款信息
select
	order_id,sku_id ,
	refund_amount,dt
from dwd_refund_payment 
where dt <= '2021-05-07') rp
left join 
(select order_id , sku_id  ,refund_num from  dwd_order_refund_info) ri
on rp.order_id =ri.order_id  and rp.sku_id=ri.sku_id
GROUP by rp.sku_id ,dt
UNION  ALL 
select
	item,'2021-05-07',
	0 order_count,
				0 order_num,
				0 order_activity_count,
				0 order_coupon_count,
				0 order_activity_reduce_amount,
				0 order_coupon_reduce_amount,
				0 order_original_amount,
				0 order_final_amount,
				0 payment_count,
				0 payment_num,
				0 payment_amount,
				0 refund_order_count,
				0 refund_order_num,
				0 refund_order_amount,
				0 refund_payment_count,
				0 refund_payment_num,
				0 refund_payment_amount,
	sum(if(action_id='cart_add',1,0)) cart_count,
	sum(if(action_id='favor_add',1,0)) favor_count,
	0 appraise_good_count,
				0 appraise_mid_count,
				0 appraise_bad_count,
				0 appraise_default_count
from dwd_action_log 
--取首日的收藏和加购的用户行为
where dt='2021-05-07' and action_id in ('cart_add','favor_add')
GROUP by item 
UNION  ALL 
select
	sku_id ,dt,
				0 order_count,
				0 order_num,
				0 order_activity_count,
				0 order_coupon_count,
				0 order_activity_reduce_amount,
				0 order_coupon_reduce_amount,
				0 order_original_amount,
				0 order_final_amount,
				0 payment_count,
				0 payment_num,
				0 payment_amount,
				0 refund_order_count,
				0 refund_order_num,
				0 refund_order_amount,
				0 refund_payment_count,
				0 refund_payment_num,
				0 refund_payment_amount,
				0 cart_count,
				0 favor_count,
	sum(if(appraise ='1201',1, 0)) appraise_good_count,
	sum(if(appraise ='1202',1, 0)) appraise_mid_count,
	sum(if(appraise ='1203',1, 0)) appraise_bad_count,
	sum(if(appraise ='1204',1, 0)) appraise_default_count
from dwd_comment_info 
group by sku_id ,dt ) tmp
GROUP by sku_id ,dt



```



#### 4.2.2 每日导入

```sql
INSERT overwrite table dws_sku_action_daycount partition(dt='2021-05-08')
select 
		sku_id ,
		sum(order_count),
	sum(order_num),
	sum(order_activity_count),
	sum(order_coupon_count),
	sum(order_activity_reduce_amount),
	sum(order_coupon_reduce_amount),
	sum(order_original_amount),
	sum(order_final_amount),
	sum(payment_count),
	sum(payment_num),
	sum(payment_amount),
	sum(refund_order_count),
	sum(refund_order_num),
	sum(refund_order_amount),
	sum(refund_payment_count),
	sum(refund_payment_num),
	sum(refund_payment_amount),
	sum(cart_count),
	sum(favor_count),
	sum(appraise_good_count),
	sum(appraise_mid_count),
	sum(appraise_bad_count),
	sum(appraise_default_count)
from
(select
	 sku_id ,
	 count(*) order_count,
	 sum(sku_num ) order_num,
	 sum(if(activity_rule_id is null,0,1)) order_activity_count,
	 sum(if(coupon_id is null,0,1)) order_coupon_count,
	 sum(if(activity_rule_id is null,0,split_activity_amount)) order_activity_reduce_amount,
	  sum(if(coupon_id is null,0,split_coupon_amount)) order_coupon_reduce_amount,
	  sum(original_amount) order_original_amount,
	  sum(split_final_amount) order_final_amount,
	  0 payment_count,
				0 payment_num,
				0 payment_amount,
				0 refund_order_count,
				0 refund_order_num,
				0 refund_order_amount,
				0 refund_payment_count,
				0 refund_payment_num,
				0 refund_payment_amount,
				0 cart_count,
				0 favor_count,
				0 appraise_good_count,
				0 appraise_mid_count,
				0 appraise_bad_count,
				0 appraise_default_count
from dwd_order_detail 
where dt='2021-05-08'
group by sku_id ,dt
UNION  ALL 
select
	sku_id,
	0 order_count,
				0 order_num,
				0 order_activity_count,
				0 order_coupon_count,
				0 order_activity_reduce_amount,
				0 order_coupon_reduce_amount,
				0 order_original_amount,
				0 order_final_amount,
	count(*) payment_count,
	sum(sku_num) payment_num,
	sum(split_final_amount) payment_amount,
	0 refund_order_count,
				0 refund_order_num,
				0 refund_order_amount,
				0 refund_payment_count,
				0 refund_payment_num,
				0 refund_payment_amount,
				0 cart_count,
				0 favor_count,
				0 appraise_good_count,
				0 appraise_mid_count,
				0 appraise_bad_count,
				0 appraise_default_count
from 
-- 所有支付的订单
(select
   	sku_id ,order_id ,sku_num ,split_final_amount
from dwd_order_detail
where dt='2021-05-08' or  dt=date_sub('2021-05-08',1)) od
join  
(select order_id from  dwd_payment_info where dt ='2021-05-08'  ) pi
on od.order_id = pi.order_id
GROUP by sku_id
UNION  ALL 
select
	sku_id ,
		0 order_count,
				0 order_num,
				0 order_activity_count,
				0 order_coupon_count,
				0 order_activity_reduce_amount,
				0 order_coupon_reduce_amount,
				0 order_original_amount,
				0 order_final_amount,
				0 payment_count,
				0 payment_num,
				0 payment_amount,
	count(*) refund_order_count,
	sum(refund_num) refund_order_num,
	sum(refund_amount) refund_order_amount,
	0 refund_payment_count,
				0 refund_payment_num,
				0 refund_payment_amount,
				0 cart_count,
				0 favor_count,
				0 appraise_good_count,
				0 appraise_mid_count,
				0 appraise_bad_count,
				0 appraise_default_count
from dwd_order_refund_info 
where dt='2021-05-08'
group by sku_id 
UNION  ALL 
select 
	rp.sku_id ,
	0 order_count,
				0 order_num,
				0 order_activity_count,
				0 order_coupon_count,
				0 order_activity_reduce_amount,
				0 order_coupon_reduce_amount,
				0 order_original_amount,
				0 order_final_amount,
				0 payment_count,
				0 payment_num,
				0 payment_amount,
				0 refund_order_count,
				0 refund_order_num,
				0 refund_order_amount,
	--被退款的单数
	--count(DISTINCT order_id )
	count(*) refund_payment_count,
	sum(refund_num) refund_payment_num,
	sum(refund_amount) refund_payment_amount,
	0 cart_count,
				0 favor_count,
				0 appraise_good_count,
				0 appraise_mid_count,
				0 appraise_bad_count,
				0 appraise_default_count
from
(
--取所有退款完成的退款信息
select
	order_id,sku_id ,
	refund_amount,dt
from dwd_refund_payment 
where dt = '2021-05-08') rp
left join 
-- 8号退款的订单，什么时候申请退单的？  8号退款的订单申请的退单日期不确定，但是必须符合商城的退款政策，有约束的日期
(select order_id , sku_id  ,refund_num 
from  dwd_order_refund_info
where dt > date_sub('2021-05-08',15)) ri
on rp.order_id =ri.order_id  and rp.sku_id=ri.sku_id
GROUP by rp.sku_id 
UNION  ALL 
select
	item,
	0 order_count,
				0 order_num,
				0 order_activity_count,
				0 order_coupon_count,
				0 order_activity_reduce_amount,
				0 order_coupon_reduce_amount,
				0 order_original_amount,
				0 order_final_amount,
				0 payment_count,
				0 payment_num,
				0 payment_amount,
				0 refund_order_count,
				0 refund_order_num,
				0 refund_order_amount,
				0 refund_payment_count,
				0 refund_payment_num,
				0 refund_payment_amount,
	sum(if(action_id='cart_add',1,0)) cart_count,
	sum(if(action_id='favor_add',1,0)) favor_count,
	0 appraise_good_count,
				0 appraise_mid_count,
				0 appraise_bad_count,
				0 appraise_default_count
from dwd_action_log 
--取首日的收藏和加购的用户行为
where dt='2021-05-08' and action_id in ('cart_add','favor_add')
GROUP by item 
UNION  ALL 
select
	sku_id ,
				0 order_count,
				0 order_num,
				0 order_activity_count,
				0 order_coupon_count,
				0 order_activity_reduce_amount,
				0 order_coupon_reduce_amount,
				0 order_original_amount,
				0 order_final_amount,
				0 payment_count,
				0 payment_num,
				0 payment_amount,
				0 refund_order_count,
				0 refund_order_num,
				0 refund_order_amount,
				0 refund_payment_count,
				0 refund_payment_num,
				0 refund_payment_amount,
				0 cart_count,
				0 favor_count,
	sum(if(appraise ='1201',1, 0)) appraise_good_count,
	sum(if(appraise ='1202',1, 0)) appraise_mid_count,
	sum(if(appraise ='1203',1, 0)) appraise_bad_count,
	sum(if(appraise ='1204',1, 0)) appraise_default_count
from dwd_comment_info 
where dt='2021-05-08'
group by sku_id  ) tmp
GROUP by sku_id 



```





## 5.dws_coupon_info_daycount

主体： 优惠券

粒度：  一种券 是一行



范围：  只统计目前未过期的券

### 5.1 建表

```sql
CREATE EXTERNAL TABLE dws_coupon_info_daycount(
    `coupon_id` STRING COMMENT '优惠券ID',
    -- dwd_coupon_use
    `get_count` BIGINT COMMENT '领取次数',
    `order_count` BIGINT COMMENT '使用(下单)次数', 
    
    -- dwd_order_detail
    `order_reduce_amount` DECIMAL(16,2) COMMENT '使用某券的订单优惠金额',
    `order_original_amount` DECIMAL(16,2) COMMENT '使用某券的订单原价金额',
    `order_final_amount` DECIMAL(16,2) COMMENT '使用某券的订单总价金额',
     -- dwd_coupon_use
    `payment_count` BIGINT COMMENT '使用(支付)次数',
    
     -- dwd_order_detail  取 支付的订单 
    `payment_reduce_amount` DECIMAL(16,2) COMMENT '使用某券的支付优惠金额',
    `payment_amount` DECIMAL(16,2) COMMENT '使用某券支付的总金额',
     -- dwd_coupon_use
    `expire_count` BIGINT COMMENT '过期次数'
) COMMENT '每日活动统计'
```



### 5.2 导入数据

#### 5.2.1 首日导入

```sql
insert overwrite table dws_coupon_info_daycount partition(dt)
SELECT 
		t5.id,
		  nvl(get_count,0) ,
		  nvl(order_count,0) ,
		  nvl(order_reduce_amount,0.0) ,
		  nvl(order_original_amount,0.0) ,
		  nvl(order_final_amount,0.0) ,
		  nvl(payment_count,0) ,
		  nvl(payment_reduce_amount,0.0) ,
		  nvl(payment_amount,0.0) ,
		  nvl(expire_count,0) ,
        t5.dt
from
(SELECT 
	id,expire_time ,start_time ,dt
from 
-- 取当日有效的所有的优惠券
(SELECT 
	id,expire_time ,start_time 
from  dim_coupon_info
--取今天采集的最新的优惠券维度信息
where dt='2021-05-07'  ) t4
join 
(select 
   date_id dt 
from dim_date_info 
where date_id BETWEEN  '2021-05-03' and '2021-05-07') t3
--取所有有效的券可能发生行为的日期
where  nvl(start_time,'0000-00-00') <= dt
-- 为expire_time is null 用不过期的券，赋予极大值
and  nvl(expire_time, '9999-99-99') >= dt  ) t5
left join
(
 SELECT 
 	coupon_id,t2.dt,
 	sum(split_coupon_amount) payment_reduce_amount,
 	sum(split_final_amount) payment_amount
 from
 (SELECT 
 	coupon_id,order_id,split_coupon_amount,split_final_amount
 
 --取所有支付的订单，和订单支付的日期
 from  dwd_order_detail
 where coupon_id is not null) t1
 join  
 (select  
 	order_id ,dt
 from dwd_payment_info 
 --只取支付成功的
 where dt <= '2021-05-07' ) t2
 -- --取所有支付的订单
 on t1.order_id=t2.order_id 
 GROUP  by coupon_id,t2.dt  ) t6
 on t5.id = t6.coupon_id and t5.dt=t6.dt
 left join
(SELECT 
	coupon_id,dt,
	sum(split_coupon_amount) order_reduce_amount,
	sum(original_amount) order_original_amount,
	sum(split_final_amount) order_final_amount

from dwd_order_detail 
where  coupon_id is not NULL 
group by coupon_id,dt ) t7
on t5.id = t7.coupon_id and t5.dt=t7.dt
left join 
(--首日导入，取出所有的用券记录
SELECT 
	 coupon_id,dt,
	 sum(get_count) get_count ,
	 sum(order_count) order_count,
	 sum(payment_count) payment_count,
	 sum(expire_count) expire_count
from
    (SELECT 
    	--求每日领券的数据
    	coupon_id,
    	date_format(get_time ,'yyyy-MM-dd') dt,
    	count(*) get_count,
    	 0 order_count,
		  0 payment_count,
		  0 expire_count
    from dwd_coupon_use 
    group by coupon_id, date_format(get_time ,'yyyy-MM-dd')
    UNION all
     SELECT 
    	--求每日领券的数据
    	coupon_id,
    	date_format(using_time ,'yyyy-MM-dd') dt,
    	0 get_count,
    	count(*) order_count,
    	 0 payment_count,
		  0 expire_count
    	
    from dwd_coupon_use 
    where using_time  is not null
    group by coupon_id, date_format(using_time ,'yyyy-MM-dd') 
    UNION all
     SELECT 
    	--求每日领券的数据
    	coupon_id,
    	date_format(used_time ,'yyyy-MM-dd') dt,
    	 0 get_count,
    	 0 order_count,
    	count(*) payment_count,
    	 0 expire_count
    	
    from dwd_coupon_use 
    where used_time  is not null
    group by coupon_id, date_format(used_time ,'yyyy-MM-dd') 
    UNION  all
     SELECT 
    	--求每日领券的数据
    	coupon_id,
    	date_format(expire_time ,'yyyy-MM-dd') dt,
    	 0 get_count,
		  0 order_count,
		  0 payment_count,
    	count(*) expire_count
    from dwd_coupon_use 
    -- 过滤出已经过期的券
    where expire_time  is not null
    group by coupon_id, date_format(expire_time ,'yyyy-MM-dd') ) tmp 
     GROUP  by  coupon_id,dt
) t8
    on t5.id = t8.coupon_id and t5.dt=t8.dt
   
```



#### 5.2.2 每日导入

```sql
insert overwrite table dws_coupon_info_daycount partition(dt='2021-05-08')
SELECT 
		t5.id,
		  nvl(get_count,0) ,
		  nvl(order_count,0) ,
		  nvl(order_reduce_amount,0.0) ,
		  nvl(order_original_amount,0.0) ,
		  nvl(order_final_amount,0.0) ,
		  nvl(payment_count,0) ,
		  nvl(payment_reduce_amount,0.0) ,
		  nvl(payment_amount,0.0) ,
		  nvl(expire_count,0) 
from
(-- 取有效期在5-8日的所有优惠券
SELECT 
	id
from  dim_coupon_info
--取今天采集的最新的优惠券维度信息
where dt='2021-05-08' 
and  nvl(expire_time, '9999-99-99') >= '2021-05-08'   ) t5
left join
(
 SELECT 
 	coupon_id,
 	sum(split_coupon_amount) payment_reduce_amount,
 	sum(split_final_amount) payment_amount
 from
 (SELECT 
 	coupon_id,order_id,split_coupon_amount,split_final_amount
 
 --取所有支付的订单，和订单支付的日期
 from  dwd_order_detail
 -- 涉及到跨天支付
 where (dt='2021-05-08' or  dt=date_sub('2021-05-08',1)) 
 and coupon_id is not null) t1
 join  
 (select  
 	order_id 
 from dwd_payment_info 
 --只取支付成功的
 where dt = '2021-05-08' ) t2
 -- --取所有支付的订单
 on t1.order_id=t2.order_id 
 GROUP  by coupon_id ) t6
 on t5.id = t6.coupon_id 
 left join
(SELECT 
	coupon_id,
	sum(split_coupon_amount) order_reduce_amount,
	sum(original_amount) order_original_amount,
	sum(split_final_amount) order_final_amount

from dwd_order_detail 
where  coupon_id is not NULL  and dt='2021-05-08'
group by coupon_id ) t7
on t5.id = t7.coupon_id 
left join 
(--首日导入，取出所有的用券记录
SELECT 
	 coupon_id,
	 sum(if(date_format(get_time ,'yyyy-MM-dd')= '2021-05-08',1,0)) get_count ,
	 sum(if(date_format(using_time,'yyyy-MM-dd')= '2021-05-08',1,0)) order_count ,
	 sum(if(date_format(used_time ,'yyyy-MM-dd')= '2021-05-08',1,0)) payment_count ,
	 sum(if(date_format(expire_time ,'yyyy-MM-dd')= '2021-05-08',1,0)) expire_count 
from dwd_coupon_use 
--取5-8日完成的领券行为 和 5-8日未完成的领券行为
where dt='2021-05-08' or 
	(dt='9999-99-99'  
	--取5-8日领券后未完成的领券行为 
	and  
	(date_format(get_time ,'yyyy-MM-dd')= '2021-05-08' or    date_format(using_time ,'yyyy-MM-dd')= '2021-05-08' ))
	GROUP  by  coupon_id

  


) t8
    on t5.id = t8.coupon_id 
   
```



## 6.dws_activity_info_daycount

主体： 活动

粒度：  一个活动的一个规则是一行



范围：  活动需要在有效期

### 6.1 建表

```sql
CREATE EXTERNAL TABLE dws_activity_info_daycount(
    -- dim_activity_info 取当日所有有效的活动，求这些活动的行为
    `activity_rule_id` STRING COMMENT '活动规则ID',
    `activity_id` STRING COMMENT '活动ID',
    -- dwd_order_detail       下单次数   下单个数
    `order_count` BIGINT COMMENT '参与某活动某规则下单次数',--注意：针对的是某个活动的某个具体规则
    `order_reduce_amount` DECIMAL(16,2) COMMENT '参与某活动某规则下单减免金额',
    `order_original_amount` DECIMAL(16,2) COMMENT '参与某活动某规则下单原始金额',--只统计参与活动的订单明细,未参与活动的订单明细不统计。
    `order_final_amount` DECIMAL(16,2) COMMENT '参与某活动某规则下单最终金额',
    
    -- 取支付的订单   dwd_order_detail  join   dwd_payment_info
    `payment_count` BIGINT COMMENT '参与某活动某规则支付次数',
    `payment_reduce_amount` DECIMAL(16,2) COMMENT '参与某活动某规则支付减免金额',
    `payment_amount` DECIMAL(16,2) COMMENT '参与某活动某规则支付金额'
) COMMENT '每日活动统计'
```



### 6.2 导入数据

#### 6.2.1 首次导入

根据 activity_rule_id，activity_id ,dt进行分组

```sql
with
--1 下单
w_orders as
(
-- 造的数据中，有过期的活动
-- 今天的下单中，有订单参加了过期的活动，关联后，将过期的活动排除
    select
        activity_rule_id,
        activity_id,
        dt,
        count(*) order_count,
        sum(split_activity_amount) order_reduce_amount,
        sum(original_amount) order_original_amount,
        sum(split_final_amount) order_final_amount        
    from dwd_order_detail 
    -- dt 订单下单的时间，事实发生的时间
    where dt <= '2021-05-07' and  activity_rule_id  is not null
    group by activity_rule_id,activity_id,dt
),
w_payment as
(
    select
    	-- 以支付日期分组
        dpi.dt,
        activity_rule_id,
        activity_id,
        -- 支付以订单为单位进行支付，一笔订单付一次
        count(*) payment_count,
        sum(split_activity_amount) payment_reduce_amount,
        sum(split_final_amount) payment_amount
    from
    (
        select
            activity_rule_id,
            activity_id,
            order_id,
            split_activity_amount,
            split_final_amount
        from dwd_order_detail
        -- 取参加活动的全部数据
        where activity_id is not null and dt <= '2021-05-07'
    )dod
    join
    (
        select
            order_id,dt
        from dwd_payment_info
        -- 只取支付成功的才有意义  dt是支付完成的日期
        where dt <= '2021-05-07' 
    )dpi
    on dod.order_id=dpi.order_id
    group by dod.activity_rule_id,dod.activity_id,dpi.dt
)
-- 查询的是所有产生了行为的活动
insert overwrite table dws_activity_info_daycount partition(dt)
select 
	t2.activity_rule_id,
	t2.activity_id,
   nvl(order_count,0) ,
   nvl(order_reduce_amount ,0.0) ,
   nvl(order_original_amount,0.0) ,
   nvl(order_final_amount,0.0) ,
   nvl(payment_count,0) ,
   nvl(payment_reduce_amount,0.0) ,
   nvl(payment_amount,0.0) ,
   t2.dt
from
-- 所有有效期内的活动
(select
   activity_rule_id,activity_id,date_id dt
from
(select 
    activity_rule_id,activity_id,start_time ,end_time 
from  dim_activity_rule_info 
where  dt='2021-05-07'  )  t1
join  dim_date_info 
where  date_id  BETWEEN  '2021-05-03' and '2021-05-07'
--and  start_time <= date_id  and  end_time >= date_id 
)  t2
left join
(select
    activity_rule_id,
    activity_id,
    sum(order_count)  order_count,
    sum(order_reduce_amount) order_reduce_amount,
    sum(order_original_amount)  order_original_amount,
    sum(order_final_amount)  order_final_amount,
    sum(payment_count) payment_count,
    sum(payment_reduce_amount) payment_reduce_amount,
    sum(payment_amount) payment_amount,
    dt
from
(
    select
        dt,
        activity_rule_id,
        activity_id,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        0 payment_count,
        0 payment_reduce_amount,
        0 payment_amount
    from w_orders
    union all
    select
        dt,
        activity_rule_id,
        activity_id,
        0 order_count,
        0 order_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount
    from w_payment
)t1
group by dt,activity_rule_id,activity_id ) t3
on t2.activity_rule_id=t3.activity_rule_id and t2.activity_id=t3.activity_id and t2.dt=t3.dt
```





#### 6.2.2 每日导入

只求当天的行为统计

```sql
with
--1 下单
w_orders as
(
-- 造的数据中，有过期的活动
-- 今天的下单中，有订单参加了过期的活动，关联后，将过期的活动排除
    select
        activity_rule_id,
        activity_id,
        count(*) order_count,
        sum(split_activity_amount) order_reduce_amount,
        sum(original_amount) order_original_amount,
        sum(split_final_amount) order_final_amount        
    from dwd_order_detail 
    -- dt 订单下单的时间，事实发生的时间
    where dt = '2021-05-08' and  activity_rule_id  is not null
    group by activity_rule_id,activity_id
),
w_payment as
(
    select
    	-- 以支付日期分组
        activity_rule_id,
        activity_id,
        -- 支付以订单为单位进行支付，一笔订单付一次
        count(*) payment_count,
        sum(split_activity_amount) payment_reduce_amount,
        sum(split_final_amount) payment_amount
    from
    -- 取5-8所有支付的订单详情  
    (
        select
            activity_rule_id,
            activity_id,
            order_id,
            split_activity_amount,
            split_final_amount
        from dwd_order_detail
        -- 取参加活动的全部数据
        where  (dt = '2021-05-08' or dt=date_sub('2021-05-08',1) )
        and 
        activity_id is not null 
    )dod
    join
    (
        select
            order_id
        from dwd_payment_info
        -- 只取支付成功的才有意义  dt是支付完成的日期
        where dt = '2021-05-08' 
    )dpi
    on dod.order_id=dpi.order_id
    group by dod.activity_rule_id,dod.activity_id
)
-- 查询的是所有产生了行为的活动
insert overwrite table dws_activity_info_daycount partition(dt='2021-05-08')
select 
	t2.activity_rule_id,
	t2.activity_id,
   nvl(order_count,0) ,
   nvl(order_reduce_amount ,0.0) ,
   nvl(order_original_amount,0.0) ,
   nvl(order_final_amount,0.0) ,
   nvl(payment_count,0) ,
   nvl(payment_reduce_amount,0.0) ,
   nvl(payment_amount,0.0) 
from
-- 所有有效期内的活动
(
select 
    activity_rule_id,activity_id
from  dim_activity_rule_info 
-- 取当日有效的活动
where  dt='2021-05-07' 
--and  end_time >=  '2021-05-08' 
)  t2
left join
(select
    activity_rule_id,
    activity_id,
    sum(order_count)  order_count,
    sum(order_reduce_amount) order_reduce_amount,
    sum(order_original_amount)  order_original_amount,
    sum(order_final_amount)  order_final_amount,
    sum(payment_count) payment_count,
    sum(payment_reduce_amount) payment_reduce_amount,
    sum(payment_amount) payment_amount
from
(
    select
        activity_rule_id,
        activity_id,
        order_count,
        order_reduce_amount,
        order_original_amount,
        order_final_amount,
        0 payment_count,
        0 payment_reduce_amount,
        0 payment_amount
    from w_orders
    union all
    select
        activity_rule_id,
        activity_id,
        0 order_count,
        0 order_reduce_amount,
        0 order_original_amount,
        0 order_final_amount,
        payment_count,
        payment_reduce_amount,
        payment_amount
    from w_payment
)t1
group by activity_rule_id,activity_id ) t3
on t2.activity_rule_id=t3.activity_rule_id and t2.activity_id=t3.activity_id 
```



## 7.dws_area_stats_daycount

所有地区的统计信息，即便每天某些地区没有统计行为的数据，也要统计，计0



Join 的目的，在多个结果集中拼接字段。不需要拼接字段，避免Join！



joih的次数多，可以使用 

​									select

​										 province_id,dt,sum(a),sum(b)

​										from

​									  (  A  补全 所有要Join的字段

​												union all

​											B 补全所有要 Join的字段

​									          ...) tmp

​										group by  province_id,dt

### 7.1 建表

```sql
CREATE EXTERNAL TABLE dws_area_stats_daycount(
    `province_id` STRING COMMENT '地区编号',
    -- dwd_page_log
    `visit_count` BIGINT COMMENT '访客访问次数',
    `login_count` BIGINT COMMENT '用户访问次数',
    `visitor_count` BIGINT COMMENT '访客人数',
    `user_count` BIGINT COMMENT '用户人数',
    
    -- dwd_order_info
    `order_count` BIGINT COMMENT '下单次数',
    `order_original_amount` DECIMAL(16,2) COMMENT '下单原始金额',
    `order_final_amount` DECIMAL(16,2) COMMENT '下单最终金额',
    
    -- dwd_payment_info
    `payment_count` BIGINT COMMENT '支付次数',
    `payment_amount` DECIMAL(16,2) COMMENT '支付金额',
    -- dwd_order_refund_info
    `refund_order_count` BIGINT COMMENT '退单次数',
    `refund_order_amount` DECIMAL(16,2) COMMENT '退单金额',
    --dwd_refund_payment
    `refund_payment_count` BIGINT COMMENT '退款次数',
    `refund_payment_amount` DECIMAL(16,2) COMMENT '退款金额'
) COMMENT '每日地区统计表'
```





### 7.2 导入数据

#### 7.2.1 首日导入

所有产生了访问，下单，支付，退单，退款行为的省份的数据

```sql
insert overwrite table dws_area_stats_daycount partition(dt)
-- 所有产生了访问，下单，支付，退单，退款行为的省份的数据
select
	province_id,
	sum(visit_count),
sum(login_count),
sum(visitor_count),
sum(user_count),
sum(order_count),
sum(order_original_amount),
sum(order_final_amount),
sum(payment_count),
sum(payment_amount),
sum(refund_order_count),
sum(refund_order_amount),
sum(refund_payment_count),
sum(refund_payment_amount),
dt
from 
(select 
  		 id province_id,
  		'2021-05-07'  dt,
    	sum(IF (last_page_id is null,1 ,0)) visit_count,
    	sum(IF (last_page_id is null and user_id is not null,1 ,0)) login_count,
    	size(COLLECT_set(mid_id)) visitor_count,
    	size(COLLECT_set(user_id )) user_count,
        0 order_count,
		0 order_original_amount,
		0 order_final_amount,
		0 payment_count,
		0 payment_amount,
		0 refund_order_count,
		0 refund_order_amount,
		0 refund_payment_count,
		0 refund_payment_amount
  from dwd_page_log left join dim_base_province 
  on dwd_page_log.area_code  = dim_base_province.area_code 
  where dt='2021-05-07' 
  GROUP by  id
UNION ALL 
select 
   	province_id, 
   	date_format(create_time,'yyyy-MM-dd') dt,
   	0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
   	count(*) order_count,sum(original_amount) order_original_amount,
   	sum(final_amount) order_final_amount,
   	0 payment_count,
0 payment_amount,
0 refund_order_count,
0 refund_order_amount,
0 refund_payment_count,
0 refund_payment_amount
 from dwd_order_info 
 -- dt是订单完成的时间, 取所有的订单
 where dt<='2021-05-07' or dt='9999-99-99' 
 GROUP  by province_id , date_format(create_time,'yyyy-MM-dd') 
 UNION ALL 
 select 
    	province_id,
    	dt,
    	0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
0 order_count,
0 order_original_amount,
0 order_final_amount,
    	count(*) payment_count,sum(payment_amount) payment_amount,
    	0 refund_order_count,
0 refund_order_amount,
0 refund_payment_count,
0 refund_payment_amount
  from dwd_payment_info 
  where dt <='2021-05-07' 
  GROUP  by province_id , dt
  UNION ALL 
select 
    province_id,dt,
    0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
0 order_count,
0 order_original_amount,
0 order_final_amount,
0 payment_count,
0 payment_amount,
    count(*) refund_order_count,sum(refund_amount) refund_order_amount,
    0 refund_payment_count,
0 refund_payment_amount
  from dwd_order_refund_info 
  where dt <='2021-05-07' 
  GROUP by province_id,dt 
  UNION ALL 
select 
     province_id,dt,
     0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
0 order_count,
0 order_original_amount,
0 order_final_amount,
0 payment_count,
0 payment_amount,
0 refund_order_count,
0 refund_order_amount,
count(*) refund_payment_count,  sum(refund_amount) refund_payment_amount
   from dwd_refund_payment 
   where dt <='2021-05-07'
   GROUP  by province_id,dt ) tmp
   GROUP  by province_id,dt
```





求所有省份的行为数据：

```sql
insert overwrite table dws_area_stats_daycount partition(dt)
select 
	t2.id,
	nvl(visit_count, 0) visit_count,
	nvl(login_count, 0) login_count,
	nvl(visitor_count, 0) visitor_count,
	nvl(user_count, 0) user_count,
	nvl(order_count, 0) order_count,
	nvl(order_original_amount, 0.0) order_original_amount,
	nvl(order_final_amount, 0.0) order_final_amount,
	nvl(payment_count, 0) payment_count,
	nvl(payment_amount, 0.0) payment_amount,
	nvl(refund_order_count, 0) refund_order_count,
	nvl(refund_order_amount, 0.0) refund_order_amount,
	nvl(refund_payment_count, 0) refund_payment_count,
	nvl(refund_payment_amount, 0.0) refund_payment_amount,
	t2.dt
from
(select 
	id,date_id dt
from dim_base_province join
(select date_id 
from  dim_date_info
where  date_id BETWEEN '2021-05-03' and '2021-05-07') date_data ) t2
left join
(select
	province_id,
sum(visit_count) visit_count,
sum(login_count) login_count,
sum(visitor_count) visitor_count,
sum(user_count) user_count,
sum(order_count) order_count,
sum(order_original_amount) order_original_amount,
sum(order_final_amount) order_final_amount,
sum(payment_count) payment_count,
sum(payment_amount) payment_amount,
sum(refund_order_count) refund_order_count,
sum(refund_order_amount) refund_order_amount,
sum(refund_payment_count) refund_payment_count,
sum(refund_payment_amount) refund_payment_amount,
dt
from 
(select 
  		 id province_id,
  		'2021-05-07'  dt,
    	sum(IF (last_page_id is null,1 ,0)) visit_count,
    	sum(IF (last_page_id is null and user_id is not null,1 ,0)) login_count,
    	size(COLLECT_set(mid_id)) visitor_count,
    	size(COLLECT_set(user_id )) user_count,
        0 order_count,
		0 order_original_amount,
		0 order_final_amount,
		0 payment_count,
		0 payment_amount,
		0 refund_order_count,
		0 refund_order_amount,
		0 refund_payment_count,
		0 refund_payment_amount
  from dwd_page_log left join dim_base_province 
  on dwd_page_log.area_code  = dim_base_province.area_code 
  where dt='2021-05-07' 
  GROUP by  id
UNION ALL 
select 
   	province_id, 
   	date_format(create_time,'yyyy-MM-dd') dt,
   	0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
   	count(*) order_count,sum(original_amount) order_original_amount,
   	sum(final_amount) order_final_amount,
   	0 payment_count,
0 payment_amount,
0 refund_order_count,
0 refund_order_amount,
0 refund_payment_count,
0 refund_payment_amount
 from dwd_order_info 
 -- dt是订单完成的时间, 取所有的订单
 where dt<='2021-05-07' or dt='9999-99-99' 
 GROUP  by province_id , date_format(create_time,'yyyy-MM-dd') 
 UNION ALL 
 select 
    	province_id,
    	dt,
    	0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
0 order_count,
0 order_original_amount,
0 order_final_amount,
    	count(*) payment_count,sum(payment_amount) payment_amount,
    	0 refund_order_count,
0 refund_order_amount,
0 refund_payment_count,
0 refund_payment_amount
  from dwd_payment_info 
  where dt <='2021-05-07' 
  GROUP  by province_id , dt
  UNION ALL 
select 
    province_id,dt,
    0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
0 order_count,
0 order_original_amount,
0 order_final_amount,
0 payment_count,
0 payment_amount,
    count(*) refund_order_count,sum(refund_amount) refund_order_amount,
    0 refund_payment_count,
0 refund_payment_amount
  from dwd_order_refund_info 
  where dt <='2021-05-07' 
  GROUP by province_id,dt 
  UNION ALL 
select 
     province_id,dt,
     0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
0 order_count,
0 order_original_amount,
0 order_final_amount,
0 payment_count,
0 payment_amount,
0 refund_order_count,
0 refund_order_amount,
count(*) refund_payment_count,  sum(refund_amount) refund_payment_amount
   from dwd_refund_payment 
   where dt <='2021-05-07'
   GROUP  by province_id,dt ) tmp
   GROUP  by province_id,dt  )  t1
   on t1.province_id = t2.id and t1.dt=t2.dt
```



#### 7.2.2 每日导入

```sql
insert overwrite table dws_area_stats_daycount partition(dt='2021-05-08')
select 
	t2.id,
	nvl(visit_count, 0) visit_count,
	nvl(login_count, 0) login_count,
	nvl(visitor_count, 0) visitor_count,
	nvl(user_count, 0) user_count,
	nvl(order_count, 0) order_count,
	nvl(order_original_amount, 0.0) order_original_amount,
	nvl(order_final_amount, 0.0) order_final_amount,
	nvl(payment_count, 0) payment_count,
	nvl(payment_amount, 0.0) payment_amount,
	nvl(refund_order_count, 0) refund_order_count,
	nvl(refund_order_amount, 0.0) refund_order_amount,
	nvl(refund_payment_count, 0) refund_payment_count,
	nvl(refund_payment_amount, 0.0) refund_payment_amount
from  dim_base_province t2
left join
(select
	province_id,
sum(visit_count) visit_count,
sum(login_count) login_count,
sum(visitor_count) visitor_count,
sum(user_count) user_count,
sum(order_count) order_count,
sum(order_original_amount) order_original_amount,
sum(order_final_amount) order_final_amount,
sum(payment_count) payment_count,
sum(payment_amount) payment_amount,
sum(refund_order_count) refund_order_count,
sum(refund_order_amount) refund_order_amount,
sum(refund_payment_count) refund_payment_count,
sum(refund_payment_amount) refund_payment_amount,
dt
from 
(select 
  		 id province_id,
  		'2021-05-08'  dt,
    	sum(IF (last_page_id is null,1 ,0)) visit_count,
    	sum(IF (last_page_id is null and user_id is not null,1 ,0)) login_count,
    	size(COLLECT_set(mid_id)) visitor_count,
    	size(COLLECT_set(user_id )) user_count,
        0 order_count,
		0 order_original_amount,
		0 order_final_amount,
		0 payment_count,
		0 payment_amount,
		0 refund_order_count,
		0 refund_order_amount,
		0 refund_payment_count,
		0 refund_payment_amount
  from dwd_page_log left join dim_base_province 
  on dwd_page_log.area_code  = dim_base_province.area_code 
  where dt='2021-05-08' 
  GROUP by  id
UNION ALL 
select 
   	province_id, 
   	date_format(create_time,'yyyy-MM-dd') dt,
   	0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
   	count(*) order_count,sum(original_amount) order_original_amount,
   	sum(final_amount) order_final_amount,
   	0 payment_count,
0 payment_amount,
0 refund_order_count,
0 refund_order_amount,
0 refund_payment_count,
0 refund_payment_amount
 from dwd_order_info 
 -- dt是订单完成的时间, 取所有的订单
 where (dt ='2021-05-08' or dt='9999-99-99' )
 	and date_format(create_time,'yyyy-MM-dd')= '2021-05-08'
 GROUP  by province_id , date_format(create_time,'yyyy-MM-dd') 
 UNION ALL 
 select 
    	province_id,
    	dt,
    	0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
0 order_count,
0 order_original_amount,
0 order_final_amount,
    	count(*) payment_count,sum(payment_amount) payment_amount,
    	0 refund_order_count,
0 refund_order_amount,
0 refund_payment_count,
0 refund_payment_amount
  from dwd_payment_info 
  where dt ='2021-05-08' 
  GROUP  by province_id , dt
  UNION ALL 
select 
    province_id,dt,
    0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
0 order_count,
0 order_original_amount,
0 order_final_amount,
0 payment_count,
0 payment_amount,
    count(*) refund_order_count,sum(refund_amount) refund_order_amount,
    0 refund_payment_count,
0 refund_payment_amount
  from dwd_order_refund_info 
  where dt ='2021-05-08' 
  GROUP by province_id,dt 
  UNION ALL 
select 
     province_id,dt,
     0 visit_count,
0 login_count,
0 visitor_count,
0 user_count,
0 order_count,
0 order_original_amount,
0 order_final_amount,
0 payment_count,
0 payment_amount,
0 refund_order_count,
0 refund_order_amount,
count(*) refund_payment_count,  sum(refund_amount) refund_payment_amount
   from dwd_refund_payment 
   where dt ='2021-05-08'
   GROUP  by province_id,dt ) tmp
   GROUP  by province_id,dt  )  t1
   on t1.province_id = t2.id ;
```



# 五、DWT层

## 1.整体思路

dwt在dws的基础上累积聚合。



熟悉dws是如何每天聚合？

​		①    访客维度 ：   只统计每天产生行为(访问页面)的访客(设备)

​				用户维度 ： 只统计每天产生行为(下单，访问，支付，加购，收藏等)的用户

​				商品维度 ：  只统计每天产生行为(下单，访问，支付，加购，收藏等)的商品

​				地区维度 ：  取每日全量地区的所有行为

​				优惠券维度 ：   取当日有效的所有优惠券(产生行为 和 为产生行为)

​				活动维度：  取当日有效的所有活动(产生行为 和 为产生行为)

​		②  dwt如何分区

​						dwt有些公司不分区，就是一张全量表。每日累积。

​						

​						当前： 保留前一天的分区数据作为副本，每新导入一天的数据，就删除过期的副本。

​		③如何导入数据

​				a) 粒度：    dws 和dwt粒度是一样的!

​									  dws_visitor_action_daycount: 一个设备是一行

​										dwt_visitor_topic: 一个设备是一行

​               b)  区分数据的来源：

​								用户行为：  访客

​															每日导入

​								业务数据：  地区，优惠券，活动，商品，用户

​														分首日导入和每日导入

​							首日处理：  将dws层首日及之前已经聚合的所有分区的数据，再进行累积聚合，之后导入即可。

​							每日处理：  将dws层指定维度当日已经聚合的数据 和 dwt层最新的累积的全量数据进行聚合。

​																			dwt_data  fulll join dws_data

​														数值类型字段的累加:  nvl(dwt_data.a , 0) + nvl(dws_data,0)

​														非数值类型的字段：   优先取dws层最新的数据，更新dwt，如果dws为NULL，取dwt.

## 2.dwt_visitor_topic

主体： 访客 （设备）

粒度： 一个访客是一行



来龙：   dws层每日聚合的访客信息



去脉：  dwt层累积 截至到当天全部的访客信息

### 2.1 建表

```sql
CREATE EXTERNAL TABLE dwt_visitor_topic
(
    -- dws_visitor_action_daycount
    `mid_id` STRING COMMENT '设备id',
    `brand` STRING COMMENT '手机品牌',
    `model` STRING COMMENT '手机型号',
    `channel` ARRAY<STRING> COMMENT '渠道',
    `os` ARRAY<STRING> COMMENT '操作系统',
    `area_code` ARRAY<STRING> COMMENT '地区ID',
    `version_code` ARRAY<STRING> COMMENT '应用版本',
    
    -- 带条件的指标   ，先用sum(if(字段A 是否 符合条件，字段A ， NULL | 0 ))
    
    -- 无法求出准备的访客的首次访问时间
    `visit_date_first` STRING  COMMENT '首次访问时间',
    `visit_date_last` STRING  COMMENT '末次访问时间',
    `visit_last_1d_count` BIGINT COMMENT '最近1日访问次数',
    `visit_last_1d_day_count` BIGINT COMMENT '最近1日访问天数',
    `visit_last_7d_count` BIGINT COMMENT '最近7日访问次数',
    `visit_last_7d_day_count` BIGINT COMMENT '最近7日访问天数',
    `visit_last_30d_count` BIGINT COMMENT '最近30日访问次数',
    `visit_last_30d_day_count` BIGINT COMMENT '最近30日访问天数',
    `visit_count` BIGINT COMMENT '累积访问次数',--用户行为日志历史数据无法获取，故该字段实为从数仓搭建日至今的累积值
    `visit_day_count` BIGINT COMMENT '累积访问天数'--用户行为日志历史数据无法获取，故该字段实为从数仓搭建日至今的累积值
) COMMENT '设备主题宽表'
```



### 2.2 导入数据

```sql
     INSERT overwrite table dwt_visitor_topic partition(dt='2021-05-07')
    SELECT 
       nvl(dws_data.mid_id,dwt_data.mid_id) mid_id,
       --  dws: 小米|iphone   dwt: huawei|小米       聚合后 :   huawei|小米|iphone 
       concat_ws('|',map_keys(str_to_map(concat_ws(',',split(concat_ws('|',dws_data.brand,dwt_data.brand),'\\|'))))) brand,
       concat_ws('|',map_keys(str_to_map(concat_ws(',',split(concat_ws('|',dws_data.model,dwt_data.model),'\\|'))))) model,
       map_keys(str_to_map(concat_ws(',',split(concat_ws('|',dws_data.channel,dwt_data.channel),'\\|')))) channel,
       map_keys(str_to_map(concat_ws(',',split(concat_ws('|',dws_data.os,dwt_data.os),'\\|')))) os,
       map_keys(str_to_map(concat_ws(',',split(concat_ws('|',dws_data.area_code,dwt_data.area_code),'\\|')))) area_code,
       map_keys(str_to_map(concat_ws(',',split(concat_ws('|',dws_data.version_code,dwt_data.version_code),'\\|')))) version_code,
       nvl(dwt_data.visit_date_first , '2021-05-07') visit_date_first,
       if(dws_data.mid_id is null ,dwt_data.visit_date_last , '2021-05-07') visit_date_last,
       nvl(dws_data.visit_count,0) visit_last_1d_count,
       if(dws_data.mid_id is not null , 1, 0) visit_last_1d_day_count,
       --  取 dwt.visit_last_7d_count +  dws当天 visit_count-  dws7天前的visit_count
       nvl(dwt_data.visit_last_7d_count,0)  + nvl(dws_data.visit_count,0) - nvl(dws_7daysago_data.visit_count,0) visit_last_7d_count,
       nvl(dwt_data.visit_last_7d_day_count,0) + if(dws_data.visit_count > 0 , 1 , 0) - if(dws_7daysago_data.visit_count > 0 , 1,0) visit_last_7d_day_count,
       nvl(dwt_data.visit_last_30d_count,0)  + nvl(dws_data.visit_count,0) - nvl(dws_30daysago_data.visit_count,0)  visit_last_30d_count,
       nvl(dwt_data.visit_last_30d_day_count,0) + if(dws_data.visit_count > 0 , 1 , 0) - if(dws_30daysago_data.visit_count > 0 , 1,0)  visit_last_30d_day_count,
       --  dwt层这个设备累积的访问次数 +  dws这个设备当天的访问次数
       nvl(dwt_data.visit_count,0) + nvl(dws_data.visit_count,0) visit_count,
      nvl(dwt_data.visit_day_count,0) + if(dws_data.mid_id is not null ,1,0)  visit_day_count
    from
    --每日导入
    (SELECT 
      *
    from dwt_visitor_topic 
    --取dwt层最新的数据
    where dt=date_sub('2021-05-07',1) ) dwt_data
    full join
    (SELECT 
    
    	*
    --每日导入，只取当天统计的用户行为
    from dws_visitor_action_daycount 
    where dt='2021-05-07' ) dws_data
    on dwt_data.mid_id = dws_data.mid_id
    left join
    (SELECT 
    
    	*
    --每日导入，只取当天统计的用户行为
    from dws_visitor_action_daycount 
    where dt=date_sub('2021-05-07',7) ) dws_7daysago_data
    on dwt_data.mid_id = dws_7daysago_data.mid_id
     left join
    (SELECT 
    
    	*
    --每日导入，只取当天统计的用户行为
    from dws_visitor_action_daycount 
    where dt=date_sub('2021-05-07',30) ) dws_30daysago_data
    on dwt_data.mid_id = dws_30daysago_data.mid_id;
   
   
   

```



## 3.dwt_user_topic

### 3.1 建表

```sql
CREATE EXTERNAL TABLE dwt_user_topic
(
    `user_id` STRING  COMMENT '用户id',
    `login_date_first` STRING COMMENT '首次活跃日期',
    `login_date_last` STRING COMMENT '末次活跃日期',
    `login_date_1d_count` STRING COMMENT '最近1日登录次数',
    `login_last_1d_day_count` BIGINT COMMENT '最近1日登录天数',
    `login_last_7d_count` BIGINT COMMENT '最近7日登录次数',
    `login_last_7d_day_count` BIGINT COMMENT '最近7日登录天数',
    `login_last_30d_count` BIGINT COMMENT '最近30日登录次数',
    `login_last_30d_day_count` BIGINT COMMENT '最近30日登录天数',
    `login_count` BIGINT COMMENT '累积登录次数',
    `login_day_count` BIGINT COMMENT '累积登录天数',
    `order_date_first` STRING COMMENT '首次下单时间',
    `order_date_last` STRING COMMENT '末次下单时间',
    `order_last_1d_count` BIGINT COMMENT '最近1日下单次数',
    `order_activity_last_1d_count` BIGINT COMMENT '最近1日订单参与活动次数',
    `order_activity_reduce_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日订单减免金额(活动)',
    `order_coupon_last_1d_count` BIGINT COMMENT '最近1日下单用券次数',
    `order_coupon_reduce_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日订单减免金额(优惠券)',
    `order_last_1d_original_amount` DECIMAL(16,2) COMMENT '最近1日原始下单金额',
    `order_last_1d_final_amount` DECIMAL(16,2) COMMENT '最近1日最终下单金额',
    `order_last_7d_count` BIGINT COMMENT '最近7日下单次数',
    `order_activity_last_7d_count` BIGINT COMMENT '最近7日订单参与活动次数',
    `order_activity_reduce_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日订单减免金额(活动)',
    `order_coupon_last_7d_count` BIGINT COMMENT '最近7日下单用券次数',
    `order_coupon_reduce_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日订单减免金额(优惠券)',
    `order_last_7d_original_amount` DECIMAL(16,2) COMMENT '最近7日原始下单金额',
    `order_last_7d_final_amount` DECIMAL(16,2) COMMENT '最近7日最终下单金额',
    `order_last_30d_count` BIGINT COMMENT '最近30日下单次数',
    `order_activity_last_30d_count` BIGINT COMMENT '最近30日订单参与活动次数',
    `order_activity_reduce_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日订单减免金额(活动)',
    `order_coupon_last_30d_count` BIGINT COMMENT '最近30日下单用券次数',
    `order_coupon_reduce_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日订单减免金额(优惠券)',
    `order_last_30d_original_amount` DECIMAL(16,2) COMMENT '最近30日原始下单金额',
    `order_last_30d_final_amount` DECIMAL(16,2) COMMENT '最近30日最终下单金额',
    `order_count` BIGINT COMMENT '累积下单次数',
    `order_activity_count` BIGINT COMMENT '累积订单参与活动次数',
    `order_activity_reduce_amount` DECIMAL(16,2) COMMENT '累积订单减免金额(活动)',
    `order_coupon_count` BIGINT COMMENT '累积下单用券次数',
    `order_coupon_reduce_amount` DECIMAL(16,2) COMMENT '累积订单减免金额(优惠券)',
    `order_original_amount` DECIMAL(16,2) COMMENT '累积原始下单金额',
    `order_final_amount` DECIMAL(16,2) COMMENT '累积最终下单金额',
    `payment_date_first` STRING COMMENT '首次支付时间',
    `payment_date_last` STRING COMMENT '末次支付时间',
    `payment_last_1d_count` BIGINT COMMENT '最近1日支付次数',
    `payment_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日支付金额',
    `payment_last_7d_count` BIGINT COMMENT '最近7日支付次数',
    `payment_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日支付金额',
    `payment_last_30d_count` BIGINT COMMENT '最近30日支付次数',
    `payment_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日支付金额',
    `payment_count` BIGINT COMMENT '累积支付次数',
    `payment_amount` DECIMAL(16,2) COMMENT '累积支付金额',
    `refund_order_last_1d_count` BIGINT COMMENT '最近1日退单次数',
    `refund_order_last_1d_num` BIGINT COMMENT '最近1日退单件数',
    `refund_order_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日退单金额',
    `refund_order_last_7d_count` BIGINT COMMENT '最近7日退单次数',
    `refund_order_last_7d_num` BIGINT COMMENT '最近7日退单件数',
    `refund_order_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日退单金额',
    `refund_order_last_30d_count` BIGINT COMMENT '最近30日退单次数',
    `refund_order_last_30d_num` BIGINT COMMENT '最近30日退单件数',
    `refund_order_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日退单金额',
    `refund_order_count` BIGINT COMMENT '累积退单次数',
    `refund_order_num` BIGINT COMMENT '累积退单件数',
    `refund_order_amount` DECIMAL(16,2) COMMENT '累积退单金额',
    `refund_payment_last_1d_count` BIGINT COMMENT '最近1日退款次数',
    `refund_payment_last_1d_num` BIGINT COMMENT '最近1日退款件数',
    `refund_payment_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日退款金额',
    `refund_payment_last_7d_count` BIGINT COMMENT '最近7日退款次数',
    `refund_payment_last_7d_num` BIGINT COMMENT '最近7日退款件数',
    `refund_payment_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日退款金额',
    `refund_payment_last_30d_count` BIGINT COMMENT '最近30日退款次数',
    `refund_payment_last_30d_num` BIGINT COMMENT '最近30日退款件数',
    `refund_payment_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日退款金额',
    `refund_payment_count` BIGINT COMMENT '累积退款次数',
    `refund_payment_num` BIGINT COMMENT '累积退款件数',
    `refund_payment_amount` DECIMAL(16,2) COMMENT '累积退款金额',
    `cart_last_1d_count` BIGINT COMMENT '最近1日加入购物车次数',
    `cart_last_7d_count` BIGINT COMMENT '最近7日加入购物车次数',
    `cart_last_30d_count` BIGINT COMMENT '最近30日加入购物车次数',
    `cart_count` BIGINT COMMENT '累积加入购物车次数',
    `favor_last_1d_count` BIGINT COMMENT '最近1日收藏次数',
    `favor_last_7d_count` BIGINT COMMENT '最近7日收藏次数',
    `favor_last_30d_count` BIGINT COMMENT '最近30日收藏次数',
    `favor_count` BIGINT COMMENT '累积收藏次数',
    `coupon_last_1d_get_count` BIGINT COMMENT '最近1日领券次数',
    `coupon_last_1d_using_count` BIGINT COMMENT '最近1日用券(下单)次数',
    `coupon_last_1d_used_count` BIGINT COMMENT '最近1日用券(支付)次数',
    `coupon_last_7d_get_count` BIGINT COMMENT '最近7日领券次数',
    `coupon_last_7d_using_count` BIGINT COMMENT '最近7日用券(下单)次数',
    `coupon_last_7d_used_count` BIGINT COMMENT '最近7日用券(支付)次数',
    `coupon_last_30d_get_count` BIGINT COMMENT '最近30日领券次数',
    `coupon_last_30d_using_count` BIGINT COMMENT '最近30日用券(下单)次数',
    `coupon_last_30d_used_count` BIGINT COMMENT '最近30日用券(支付)次数',
    `coupon_get_count` BIGINT COMMENT '累积领券次数',
    `coupon_using_count` BIGINT COMMENT '累积用券(下单)次数',
    `coupon_used_count` BIGINT COMMENT '累积用券(支付)次数',
    `appraise_last_1d_good_count` BIGINT COMMENT '最近1日好评次数',
    `appraise_last_1d_mid_count` BIGINT COMMENT '最近1日好评次数',
    `appraise_last_1d_bad_count` BIGINT COMMENT '最近1日好评次数',
    `appraise_last_1d_default_count` BIGINT COMMENT '最近1日好评次数',
    `appraise_last_7d_good_count` BIGINT COMMENT '最近7日好评次数',
    `appraise_last_7d_mid_count` BIGINT COMMENT '最近7日好评次数',
    `appraise_last_7d_bad_count` BIGINT COMMENT '最近7日好评次数',
    `appraise_last_7d_default_count` BIGINT COMMENT '最近7日好评次数',
    `appraise_last_30d_good_count` BIGINT COMMENT '最近30日好评次数',
    `appraise_last_30d_mid_count` BIGINT COMMENT '最近30日好评次数',
    `appraise_last_30d_bad_count` BIGINT COMMENT '最近30日好评次数',
    `appraise_last_30d_default_count` BIGINT COMMENT '最近30日好评次数',
    `appraise_good_count` BIGINT COMMENT '累积好评次数',
    `appraise_mid_count` BIGINT COMMENT '累积好评次数',
    `appraise_bad_count` BIGINT COMMENT '累积好评次数',
    `appraise_default_count` BIGINT COMMENT '累积好评次数'
)COMMENT '会员主题宽表'
```



### 3.2 导入数据

#### 3.2.1 首日导入

首日：  将dws层首日及之前已经聚合的所有分区的数据，再进行累积聚合，之后导入即可



向dwt导入数据时，dwt需要存放的是商城注册的所有的会员的信息。

dws统计的只是每日发生行为的会员的信息，因此存在用户注册后，如果不产生登录行为，dws层无法统计到此类用户的信息，所以，向dwt层导入数据时，必须将dim_user_info中所有未产生行为的用户的信息也一并导入。

```sql
insert overwrite table dwt_user_topic partition(dt='2021-05-07')
SELECT 
   user_info.id,
   login_date_first,
login_date_last,
nvl(login_date_1d_count,0), 
nvl(login_last_1d_day_count,0), 
nvl(login_date_7d_count,0), 
nvl(login_last_7d_day_count,0), 
nvl(login_date_30d_count,0), 
nvl(login_last_30d_day_count,0), 
nvl(login_count,0), 
nvl(login_day_count,0), 
order_date_first,
order_date_last, 
nvl(order_last_1d_count,0), 
nvl(order_activity_last_1d_count,0), 
nvl(order_activity_reduce_last_1d_amount,0.0), 
nvl(order_coupon_last_1d_count,0), 
nvl(order_coupon_reduce_last_1d_amount,0.0), 
nvl(order_last_1d_original_amount,0.0), 
nvl(order_last_1d_final_amount,0.0), 
nvl(order_last_7d_count,0), 
nvl(order_activity_last_7d_count,0), 
nvl(order_activity_reduce_last_7d_amount,0.0), 
nvl(order_coupon_last_7d_count,0), 
nvl(order_coupon_reduce_last_7d_amount,0.0), 
nvl(order_last_7d_original_amount,0.0), 
nvl(order_last_7d_final_amount,0.0), 
nvl(order_last_30d_count,0), 
nvl(order_activity_last_30d_count,0), 
nvl(order_activity_reduce_last_30d_amount,0.0), 
nvl(order_coupon_last_30d_count,0), 
nvl(order_coupon_reduce_last_30d_amount,0.0), 
nvl(order_last_30d_original_amount,0.0), 
nvl(order_last_30d_final_amount,0.0), 
nvl(order_count,0), 
nvl(order_activity_count,0), 
nvl(order_activity_reduce_amount,0.0), 
nvl(order_coupon_count,0), 
nvl(order_coupon_reduce_amount,0.0), 
nvl(order_original_amount,0.0), 
nvl(order_final_amount,0.0), 
payment_date_first,
payment_date_last, 
nvl(payment_last_1d_count,0), 
nvl(payment_last_1d_amount,0.0), 
nvl(payment_last_7d_count,0), 
nvl(payment_last_7d_amount,0.0), 
nvl(payment_last_30d_count,0), 
nvl(payment_last_30d_amount,0.0), 
nvl(payment_count,0), 
nvl(payment_amount,0.0), 
nvl(refund_order_last_1d_count,0), 
nvl(refund_order_last_1d_num,0), 
nvl(refund_order_last_1d_amount,0.0), 
nvl(refund_order_last_7d_count,0), 
nvl(refund_order_last_7d_num,0), 
nvl(refund_order_last_7d_amount,0.0), 
nvl(refund_order_last_30d_count,0), 
nvl(refund_order_last_30d_num,0), 
nvl(refund_order_last_30d_amount,0.0), 
nvl(refund_order_count,0), 
nvl(refund_order_num,0), 
nvl(refund_order_amount,0.0), 
nvl(refund_payment_last_1d_count,0), 
nvl(refund_payment_last_1d_num,0), 
nvl(refund_payment_last_1d_amount,0.0), 
nvl(refund_payment_last_7d_count,0), 
nvl(refund_payment_last_7d_num,0), 
nvl(refund_payment_last_7d_amount,0.0), 
nvl(refund_payment_last_30d_count,0), 
nvl(refund_payment_last_30d_num,0), 
nvl(refund_payment_last_30d_amount,0.0), 
nvl(refund_payment_count,0), 
nvl(refund_payment_num,0), 
nvl(refund_payment_amount,0.0), 
nvl(cart_last_1d_count,0), 
nvl(cart_last_7d_count,0), 
nvl(cart_last_30d_count,0), 
nvl(cart_count,0), 
nvl(favor_last_1d_count,0), 
nvl(favor_last_7d_count,0), 
nvl(favor_last_30d_count,0), 
nvl(favor_count,0), 
nvl(coupon_last_1d_get_count,0), 
nvl(coupon_last_1d_using_count,0), 
nvl(coupon_last_1d_used_count,0), 
nvl(coupon_last_7d_get_count,0), 
nvl(coupon_last_7d_using_count,0), 
nvl(coupon_last_7d_used_count,0), 
nvl(coupon_last_30d_get_count,0), 
nvl(coupon_last_30d_using_count,0), 
nvl(coupon_last_30d_used_count,0), 
nvl(coupon_get_count,0), 
nvl(coupon_using_count,0), 
nvl(coupon_used_count,0), 
nvl(appraise_last_1d_good_count,0), 
nvl(appraise_last_1d_mid_count,0), 
nvl(appraise_last_1d_bad_count,0), 
nvl(appraise_last_1d_default_count,0), 
nvl(appraise_last_7d_good_count,0), 
nvl(appraise_last_7d_mid_count,0), 
nvl(appraise_last_7d_bad_count,0), 
nvl(appraise_last_7d_default_count,0), 
nvl(appraise_last_30d_good_count,0), 
nvl(appraise_last_30d_mid_count,0), 
nvl(appraise_last_30d_bad_count,0), 
nvl(appraise_last_30d_default_count,0), 
nvl(appraise_good_count,0), 
nvl(appraise_mid_count,0), 
nvl(appraise_bad_count,0), 
nvl(appraise_default_count,0)
from	
(SELECT 
  id
-- 从dim_user_info 取截至到首日商城所有的用户
from  dim_user_info 
where dt = '9999-99-99' ) user_info
left JOIN 
(SELECT 
	user_id,
	-- 各种天数
	count(*) login_day_count,
	sum(if(dt >=date_sub('2021-05-07',29) , 1 , 0)) login_last_30d_day_count,
	sum(if(dt >=date_sub('2021-05-07',6) , 1 , 0)) login_last_7d_day_count,
	sum(if(dt = '2021-05-07' , 1 , 0)) login_last_1d_day_count,
	-- 首次末次
    min(dt) login_date_first,
	max(dt) login_date_last,
	-- 判断当日order_count > 0 ,如果符合条件，dt才有参选的条件
	min(if(order_count > 0 ,dt , null)) order_date_first,
	max(if(order_count > 0 ,dt , null)) order_date_last,
	min(if(payment_count > 0 ,dt , null)) payment_date_first,
	max(if(payment_count > 0 ,dt , null)) payment_date_last,
	-- 累积的 
	sum(login_count ) login_count,
	sum(order_count ) order_count,
	sum(order_activity_count ) order_activity_count,
	sum(order_activity_reduce_amount ) order_activity_reduce_amount,
	sum(order_coupon_count ) order_coupon_count,
	sum(order_coupon_reduce_amount ) order_coupon_reduce_amount,
	sum(order_original_amount ) order_original_amount,
	sum(order_final_amount ) order_final_amount,
	sum(payment_count ) payment_count,
	sum(payment_amount ) payment_amount,
	sum(refund_order_count ) refund_order_count,
	sum(refund_order_num ) refund_order_num,
	sum(refund_order_amount ) refund_order_amount,
	sum(refund_payment_count ) refund_payment_count,
	sum(refund_payment_num ) refund_payment_num,
	sum(refund_payment_amount ) refund_payment_amount,
	sum(cart_count ) cart_count,
	sum(favor_count ) favor_count,
	sum(coupon_get_count ) coupon_get_count,
	sum(coupon_using_count ) coupon_using_count,
	sum(coupon_used_count ) coupon_used_count,
	sum(appraise_good_count ) appraise_good_count,
	sum(appraise_mid_count ) appraise_mid_count,
	sum(appraise_bad_count ) appraise_bad_count,
	sum(appraise_default_count ) appraise_default_count,
	-- 最近1天的各种值
	sum(if(dt = '2021-05-07' , login_count , 0)) login_date_1d_count,
	sum(if(dt = '2021-05-07' , order_count , 0)) order_last_1d_count,
	sum(if(dt = '2021-05-07' , order_activity_count , 0)) order_activity_last_1d_count,
	sum(if(dt = '2021-05-07' , order_activity_reduce_amount , 0)) order_activity_reduce_last_1d_amount,
	sum(if(dt = '2021-05-07' , order_coupon_count , 0)) order_coupon_last_1d_count,
	sum(if(dt = '2021-05-07' , order_coupon_reduce_amount , 0)) order_coupon_reduce_last_1d_amount,
	sum(if(dt = '2021-05-07' , order_original_amount , 0)) order_last_1d_original_amount,
	sum(if(dt = '2021-05-07' , order_final_amount , 0)) order_last_1d_final_amount,
	sum(if(dt = '2021-05-07' , payment_count , 0)) payment_last_1d_count,
	sum(if(dt = '2021-05-07' , payment_amount , 0)) payment_last_1d_amount,
	sum(if(dt = '2021-05-07' , refund_order_count , 0)) refund_order_last_1d_count,
	sum(if(dt = '2021-05-07' , refund_order_num , 0)) refund_order_last_1d_num,
	sum(if(dt = '2021-05-07' , refund_order_amount , 0)) refund_order_last_1d_amount,
	sum(if(dt = '2021-05-07' , refund_payment_count , 0)) refund_payment_last_1d_count,
	sum(if(dt = '2021-05-07' , refund_payment_num , 0)) refund_payment_last_1d_num,
	sum(if(dt = '2021-05-07' , refund_payment_amount , 0)) refund_payment_last_1d_amount,
	sum(if(dt = '2021-05-07' , cart_count , 0)) cart_last_1d_count,
	sum(if(dt = '2021-05-07' , favor_count , 0)) favor_last_1d_count,
	sum(if(dt = '2021-05-07' , coupon_get_count , 0)) coupon_last_1d_get_count,
	sum(if(dt = '2021-05-07' , coupon_using_count , 0)) coupon_last_1d_using_count,
	sum(if(dt = '2021-05-07' , coupon_used_count , 0)) coupon_last_1d_used_count,
	sum(if(dt = '2021-05-07' , appraise_good_count , 0)) appraise_last_1d_good_count,
	sum(if(dt = '2021-05-07' , appraise_mid_count , 0)) appraise_last_1d_mid_count,
	sum(if(dt = '2021-05-07' , appraise_bad_count , 0)) appraise_last_1d_bad_count,
	sum(if(dt = '2021-05-07' , appraise_default_count , 0)) appraise_last_1d_default_count,
	-- 最近7天的各种值  判断dt是否在最近7天的范围内
	sum(if(dt >=date_sub('2021-05-07',6) , login_count , 0)) login_date_7d_count,
	sum(if(dt >=date_sub('2021-05-07',6) , order_count , 0)) order_last_7d_count,
	sum(if(dt >=date_sub('2021-05-07',6) , order_activity_count , 0)) order_activity_last_7d_count,
	sum(if(dt >=date_sub('2021-05-07',6) , order_activity_reduce_amount , 0)) order_activity_reduce_last_7d_amount,
	sum(if(dt >=date_sub('2021-05-07',6) , order_coupon_count , 0)) order_coupon_last_7d_count,
	sum(if(dt >=date_sub('2021-05-07',6) , order_coupon_reduce_amount , 0)) order_coupon_reduce_last_7d_amount,
	sum(if(dt >=date_sub('2021-05-07',6) , order_original_amount , 0)) order_last_7d_original_amount,
	sum(if(dt >=date_sub('2021-05-07',6) , order_final_amount , 0)) order_last_7d_final_amount,
	sum(if(dt >=date_sub('2021-05-07',6) , payment_count , 0)) payment_last_7d_count,
	sum(if(dt >=date_sub('2021-05-07',6) , payment_amount , 0)) payment_last_7d_amount,
	sum(if(dt >=date_sub('2021-05-07',6) , refund_order_count , 0)) refund_order_last_7d_count,
	sum(if(dt >=date_sub('2021-05-07',6) , refund_order_num , 0)) refund_order_last_7d_num,
	sum(if(dt >=date_sub('2021-05-07',6) , refund_order_amount , 0)) refund_order_last_7d_amount,
	sum(if(dt >=date_sub('2021-05-07',6) , refund_payment_count , 0)) refund_payment_last_7d_count,
	sum(if(dt >=date_sub('2021-05-07',6) , refund_payment_num , 0)) refund_payment_last_7d_num,
	sum(if(dt >=date_sub('2021-05-07',6) , refund_payment_amount , 0)) refund_payment_last_7d_amount,
	sum(if(dt >=date_sub('2021-05-07',6) , cart_count , 0)) cart_last_7d_count,
	sum(if(dt >=date_sub('2021-05-07',6) , favor_count , 0)) favor_last_7d_count,
	sum(if(dt >=date_sub('2021-05-07',6) , coupon_get_count , 0)) coupon_last_7d_get_count,
	sum(if(dt >=date_sub('2021-05-07',6) , coupon_using_count , 0)) coupon_last_7d_using_count,
	sum(if(dt >=date_sub('2021-05-07',6) , coupon_used_count , 0)) coupon_last_7d_used_count,
	sum(if(dt >=date_sub('2021-05-07',6) , appraise_good_count , 0)) appraise_last_7d_good_count,
	sum(if(dt >=date_sub('2021-05-07',6) , appraise_mid_count , 0)) appraise_last_7d_mid_count,
	sum(if(dt >=date_sub('2021-05-07',6) , appraise_bad_count , 0)) appraise_last_7d_bad_count,
	sum(if(dt >=date_sub('2021-05-07',6) , appraise_default_count , 0)) appraise_last_7d_default_count,
	-- 最近7天的各种值  判断dt是否在最近30天的范围内
	sum(if(dt >=date_sub('2021-05-07',29) , login_count , 0)) login_date_30d_count,
	sum(if(dt >=date_sub('2021-05-07',29) , order_count , 0)) order_last_30d_count,
	sum(if(dt >=date_sub('2021-05-07',29) , order_activity_count , 0)) order_activity_last_30d_count,
	sum(if(dt >=date_sub('2021-05-07',29) , order_activity_reduce_amount , 0)) order_activity_reduce_last_30d_amount,
	sum(if(dt >=date_sub('2021-05-07',29) , order_coupon_count , 0)) order_coupon_last_30d_count,
	sum(if(dt >=date_sub('2021-05-07',29) , order_coupon_reduce_amount , 0)) order_coupon_reduce_last_30d_amount,
	sum(if(dt >=date_sub('2021-05-07',29) , order_original_amount , 0)) order_last_30d_original_amount,
	sum(if(dt >=date_sub('2021-05-07',29) , order_final_amount , 0)) order_last_30d_final_amount,
	sum(if(dt >=date_sub('2021-05-07',29) , payment_count , 0)) payment_last_30d_count,
	sum(if(dt >=date_sub('2021-05-07',29) , payment_amount , 0)) payment_last_30d_amount,
	sum(if(dt >=date_sub('2021-05-07',29) , refund_order_count , 0)) refund_order_last_30d_count,
	sum(if(dt >=date_sub('2021-05-07',29) , refund_order_num , 0)) refund_order_last_30d_num,
	sum(if(dt >=date_sub('2021-05-07',29) , refund_order_amount , 0)) refund_order_last_30d_amount,
	sum(if(dt >=date_sub('2021-05-07',29) , refund_payment_count , 0)) refund_payment_last_30d_count,
	sum(if(dt >=date_sub('2021-05-07',29) , refund_payment_num , 0)) refund_payment_last_30d_num,
	sum(if(dt >=date_sub('2021-05-07',29) , refund_payment_amount , 0)) refund_payment_last_30d_amount,
	sum(if(dt >=date_sub('2021-05-07',29) , cart_count , 0)) cart_last_30d_count,
	sum(if(dt >=date_sub('2021-05-07',29) , favor_count , 0)) favor_last_30d_count,
	sum(if(dt >=date_sub('2021-05-07',29) , coupon_get_count , 0)) coupon_last_30d_get_count,
	sum(if(dt >=date_sub('2021-05-07',29) , coupon_using_count , 0)) coupon_last_30d_using_count,
	sum(if(dt >=date_sub('2021-05-07',29) , coupon_used_count , 0)) coupon_last_30d_used_count,
	sum(if(dt >=date_sub('2021-05-07',29) , appraise_good_count , 0)) appraise_last_30d_good_count,
	sum(if(dt >=date_sub('2021-05-07',29) , appraise_mid_count , 0)) appraise_last_30d_mid_count,
	sum(if(dt >=date_sub('2021-05-07',29) , appraise_bad_count , 0)) appraise_last_30d_bad_count,
	sum(if(dt >=date_sub('2021-05-07',29) , appraise_default_count , 0)) appraise_last_30d_default_count
	-- dws记录的是每天产生了行为的用户,至少产生登录行为
from dws_user_action_daycount 
group by user_id  ) t1
on user_info.id = t1.user_id;
```



#### 3.2.2 每日导入

```sql
INSERT overwrite table dwt_user_topic partition(dt='2021-05-08')
SELECT user_id, login_date_first, login_date_last, login_date_1d_count, login_last_1d_day_count,
login_last_7d_count, login_last_7d_day_count, login_last_30d_count, 
login_last_30d_day_count, login_count, login_day_count, order_date_first,
order_date_last, order_last_1d_count, order_activity_last_1d_count, 
order_activity_reduce_last_1d_amount, order_coupon_last_1d_count, order_coupon_reduce_last_1d_amount,
order_last_1d_original_amount, order_last_1d_final_amount, order_last_7d_count, order_activity_last_7d_count,
order_activity_reduce_last_7d_amount, order_coupon_last_7d_count, order_coupon_reduce_last_7d_amount,
order_last_7d_original_amount, order_last_7d_final_amount, order_last_30d_count, order_activity_last_30d_count,
order_activity_reduce_last_30d_amount, order_coupon_last_30d_count, order_coupon_reduce_last_30d_amount,
order_last_30d_original_amount, order_last_30d_final_amount, order_count, order_activity_count,
order_activity_reduce_amount, order_coupon_count, order_coupon_reduce_amount, order_original_amount, 
order_final_amount, payment_date_first, payment_date_last, payment_last_1d_count, payment_last_1d_amount,
payment_last_7d_count, payment_last_7d_amount, payment_last_30d_count, payment_last_30d_amount,
payment_count, payment_amount, refund_order_last_1d_count, refund_order_last_1d_num, refund_order_last_1d_amount,
refund_order_last_7d_count, refund_order_last_7d_num, refund_order_last_7d_amount, 
refund_order_last_30d_count, refund_order_last_30d_num, refund_order_last_30d_amount,
refund_order_count, refund_order_num, refund_order_amount, refund_payment_last_1d_count,
refund_payment_last_1d_num, refund_payment_last_1d_amount, refund_payment_last_7d_count,
refund_payment_last_7d_num, refund_payment_last_7d_amount, refund_payment_last_30d_count,
refund_payment_last_30d_num, refund_payment_last_30d_amount, refund_payment_count,
refund_payment_num, refund_payment_amount, cart_last_1d_count, cart_last_7d_count, 
cart_last_30d_count, cart_count, favor_last_1d_count, favor_last_7d_count, favor_last_30d_count,
favor_count, coupon_last_1d_get_count, coupon_last_1d_using_count, 
coupon_last_1d_used_count, coupon_last_7d_get_count, coupon_last_7d_using_count, coupon_last_7d_used_count, 
coupon_last_30d_get_count, coupon_last_30d_using_count, coupon_last_30d_used_count, coupon_get_count,
coupon_using_count, coupon_used_count, appraise_last_1d_good_count, appraise_last_1d_mid_count,
appraise_last_1d_bad_count, appraise_last_1d_default_count, appraise_last_7d_good_count,
appraise_last_7d_mid_count, appraise_last_7d_bad_count, appraise_last_7d_default_count,
appraise_last_30d_good_count, appraise_last_30d_mid_count, appraise_last_30d_bad_count, 
appraise_last_30d_default_count, appraise_good_count,
appraise_mid_count, appraise_bad_count, appraise_default_count
from
(SELECT 
	nvl(dwt_data.user_id,dws_data.user_id) user_id ,
	-- 各种天数
	nvl(dwt_data.login_day_count,0) + if(dws_data.login_count > 0 ,1,0) login_day_count,
	nvl(dwt_data.login_last_30d_day_count,0 ) + if(dws_data.login_count > 0 ,1,0) - if(dws_data_30daysago.login_count > 0 ,1,0)  login_last_30d_day_count,
	nvl(dwt_data.login_last_7d_day_count,0 ) + if(dws_data.login_count > 0 ,1,0) - if(dws_data_7daysago.login_count > 0 ,1,0) login_last_7d_day_count,
	if(dws_data.login_count > 0 ,1,0) login_last_1d_day_count,
	-- 优先取dwt_data中的login_date_first，如果为null，再判断今日是否登录，登录取今日，否则为null
	if(dwt_data.login_date_first is not null , dwt_data.login_date_first , 
     if(dws_data.login_count > 0 , '2021-05-08' , null) )  login_date_first,
    if(dws_data.user_id is null,dwt_data.login_date_last , if(dws_data.login_count > 0 , '2021-05-08', null))  login_date_last,
     -- 首次下单日期需要先判断这个用户在dwt层 login_date_last是否为null，不为null说明之前下过单，login_date_last不变
     -- 如果为null，说之前从没有下过单，再判断dws_data.order_count > 0 ,如果满足，说明今日下单，今日即是首次下单的日期，如果不满足，继续为null
	nvl(dwt_data.order_date_first,if(dws_data.order_count > 0 ,'2021-05-08',null) ) order_date_first,
	-- 以今天的order_count为判断依据，如果order_count > 0 ,取今日为order_date_last，否则都取dwt_data.order_date_last
	if(dws_data.order_count > 0 , '2021-05-08', dwt_data.order_date_last) order_date_last,
	nvl(dwt_data.payment_date_first,if(dws_data.payment_count > 0 ,'2021-05-08',null) ) payment_date_first,
	if(dws_data.payment_count > 0 , '2021-05-08', dwt_data.payment_date_last)  payment_date_last,
    -- 累积   和 首日处理方式不同    nvl(dwt_data.a ,0) + nvl(dws_data.a,0)
    nvl(dwt_data.login_count,0) + nvl(dws_data.login_count, 0) login_count,
	nvl(dwt_data.order_count,0) + nvl(dws_data.order_count, 0) order_count,
	nvl(dwt_data.order_activity_count,0) + nvl(dws_data.order_activity_count, 0) order_activity_count,
	nvl(dwt_data.order_activity_reduce_amount,0) + nvl(dws_data.order_activity_reduce_amount, 0) order_activity_reduce_amount,
	nvl(dwt_data.order_coupon_count,0) + nvl(dws_data.order_coupon_count, 0) order_coupon_count,
	nvl(dwt_data.order_coupon_reduce_amount,0) + nvl(dws_data.order_coupon_reduce_amount, 0) order_coupon_reduce_amount,
	nvl(dwt_data.order_original_amount,0) + nvl(dws_data.order_original_amount, 0) order_original_amount,
	nvl(dwt_data.order_final_amount,0) + nvl(dws_data.order_final_amount, 0) order_final_amount,
	nvl(dwt_data.payment_count,0) + nvl(dws_data.payment_count, 0) payment_count,
	nvl(dwt_data.payment_amount,0) + nvl(dws_data.payment_amount, 0) payment_amount,
	nvl(dwt_data.refund_order_count,0) + nvl(dws_data.refund_order_count, 0) refund_order_count,
	nvl(dwt_data.refund_order_num,0) + nvl(dws_data.refund_order_num, 0) refund_order_num,
	nvl(dwt_data.refund_order_amount,0) + nvl(dws_data.refund_order_amount, 0) refund_order_amount,
	nvl(dwt_data.refund_payment_count,0) + nvl(dws_data.refund_payment_count, 0) refund_payment_count,
	nvl(dwt_data.refund_payment_num,0) + nvl(dws_data.refund_payment_num, 0) refund_payment_num,
	nvl(dwt_data.refund_payment_amount,0) + nvl(dws_data.refund_payment_amount, 0) refund_payment_amount,
	nvl(dwt_data.cart_count,0) + nvl(dws_data.cart_count, 0) cart_count,
	nvl(dwt_data.favor_count,0) + nvl(dws_data.favor_count, 0) favor_count,
	nvl(dwt_data.coupon_get_count,0) + nvl(dws_data.coupon_get_count, 0) coupon_get_count,
	nvl(dwt_data.coupon_using_count,0) + nvl(dws_data.coupon_using_count, 0) coupon_using_count,
	nvl(dwt_data.coupon_used_count,0) + nvl(dws_data.coupon_used_count, 0) coupon_used_count,
	nvl(dwt_data.appraise_good_count,0) + nvl(dws_data.appraise_good_count, 0) appraise_good_count,
	nvl(dwt_data.appraise_mid_count,0) + nvl(dws_data.appraise_mid_count, 0) appraise_mid_count,
	nvl(dwt_data.appraise_bad_count,0) + nvl(dws_data.appraise_bad_count, 0) appraise_bad_count,
	nvl(dwt_data.appraise_default_count,0) + nvl(dws_data.appraise_default_count, 0) appraise_default_count,
	--最近1天   取dws_data当天的数据，如果为null补0
	nvl(dws_data.login_count , 0 ) login_date_1d_count,
	nvl(dws_data.order_count , 0 ) order_last_1d_count,
	nvl(dws_data.order_activity_count , 0 ) order_activity_last_1d_count,
	nvl(dws_data.order_activity_reduce_amount , 0 ) order_activity_reduce_last_1d_amount,
	nvl(dws_data.order_coupon_count , 0 ) order_coupon_last_1d_count,
	nvl(dws_data.order_coupon_reduce_amount , 0 ) order_coupon_reduce_last_1d_amount,
	nvl(dws_data.order_original_amount , 0 ) order_last_1d_original_amount,
	nvl(dws_data.order_final_amount , 0 ) order_last_1d_final_amount,
	nvl(dws_data.payment_count , 0 ) payment_last_1d_count,
	nvl(dws_data.payment_amount , 0 ) payment_last_1d_amount,
	nvl(dws_data.refund_order_count , 0 ) refund_order_last_1d_count,
	nvl(dws_data.refund_order_num , 0 ) refund_order_last_1d_num,
	nvl(dws_data.refund_order_amount , 0 ) refund_order_last_1d_amount,
	nvl(dws_data.refund_payment_count , 0 ) refund_payment_last_1d_count,
	nvl(dws_data.refund_payment_num , 0 ) refund_payment_last_1d_num,
	nvl(dws_data.refund_payment_amount , 0 ) refund_payment_last_1d_amount,
	nvl(dws_data.cart_count , 0 ) cart_last_1d_count,
	nvl(dws_data.favor_count , 0 ) favor_last_1d_count,
	nvl(dws_data.coupon_get_count , 0 ) coupon_last_1d_get_count,
	nvl(dws_data.coupon_using_count , 0 ) coupon_last_1d_using_count,
	nvl(dws_data.coupon_used_count , 0 ) coupon_last_1d_used_count,
	nvl(dws_data.appraise_good_count , 0 ) appraise_last_1d_good_count,
	nvl(dws_data.appraise_mid_count , 0 ) appraise_last_1d_mid_count,
	nvl(dws_data.appraise_bad_count , 0 ) appraise_last_1d_bad_count,
	nvl(dws_data.appraise_default_count , 0 ) appraise_last_1d_default_count,
	--最近7天      dwt_data.最近7天  +  dws_data当天 - dws_data7天前
	nvl(dwt_data.login_last_7d_count,0 ) + nvl(dws_data.login_count,0) - nvl(dws_data_7daysago.login_count,0) login_last_7d_count,
	nvl(dwt_data.order_last_7d_count,0 ) + nvl(dws_data.order_count,0) - nvl(dws_data_7daysago.order_count,0) order_last_7d_count,
	nvl(dwt_data.order_activity_last_7d_count,0 ) + nvl(dws_data.order_activity_count,0) - nvl(dws_data_7daysago.order_activity_count,0) order_activity_last_7d_count,
	nvl(dwt_data.order_activity_reduce_last_7d_amount,0 ) + nvl(dws_data.order_activity_reduce_amount,0) - nvl(dws_data_7daysago.order_activity_reduce_amount,0) order_activity_reduce_last_7d_amount,
	nvl(dwt_data.order_coupon_last_7d_count,0 ) + nvl(dws_data.order_coupon_count,0) - nvl(dws_data_7daysago.order_coupon_count,0) order_coupon_last_7d_count,
	nvl(dwt_data.order_coupon_reduce_last_7d_amount,0 ) + nvl(dws_data.order_coupon_reduce_amount,0) - nvl(dws_data_7daysago.order_coupon_reduce_amount,0) order_coupon_reduce_last_7d_amount,
	nvl(dwt_data.order_last_7d_original_amount,0 ) + nvl(dws_data.order_original_amount,0) - nvl(dws_data_7daysago.order_original_amount,0) order_last_7d_original_amount,
	nvl(dwt_data.order_last_7d_final_amount,0 ) + nvl(dws_data.order_final_amount,0) - nvl(dws_data_7daysago.order_final_amount,0) order_last_7d_final_amount,
	nvl(dwt_data.payment_last_7d_count,0 ) + nvl(dws_data.payment_count,0) - nvl(dws_data_7daysago.payment_count,0) payment_last_7d_count,
	nvl(dwt_data.payment_last_7d_amount,0 ) + nvl(dws_data.payment_amount,0) - nvl(dws_data_7daysago.payment_amount,0) payment_last_7d_amount,
	nvl(dwt_data.refund_order_last_7d_count,0 ) + nvl(dws_data.refund_order_count,0) - nvl(dws_data_7daysago.refund_order_count,0) refund_order_last_7d_count,
	nvl(dwt_data.refund_order_last_7d_num,0 ) + nvl(dws_data.refund_order_num,0) - nvl(dws_data_7daysago.refund_order_num,0) refund_order_last_7d_num,
	nvl(dwt_data.refund_order_last_7d_amount,0 ) + nvl(dws_data.refund_order_amount,0) - nvl(dws_data_7daysago.refund_order_amount,0) refund_order_last_7d_amount,
	nvl(dwt_data.refund_payment_last_7d_count,0 ) + nvl(dws_data.refund_payment_count,0) - nvl(dws_data_7daysago.refund_payment_count,0) refund_payment_last_7d_count,
	nvl(dwt_data.refund_payment_last_7d_num,0 ) + nvl(dws_data.refund_payment_num,0) - nvl(dws_data_7daysago.refund_payment_num,0) refund_payment_last_7d_num,
	nvl(dwt_data.refund_payment_last_7d_amount,0 ) + nvl(dws_data.refund_payment_amount,0) - nvl(dws_data_7daysago.refund_payment_amount,0) refund_payment_last_7d_amount,
	nvl(dwt_data.cart_last_7d_count,0 ) + nvl(dws_data.cart_count,0) - nvl(dws_data_7daysago.cart_count,0) cart_last_7d_count,
	nvl(dwt_data.favor_last_7d_count,0 ) + nvl(dws_data.favor_count,0) - nvl(dws_data_7daysago.favor_count,0) favor_last_7d_count,
	nvl(dwt_data.coupon_last_7d_get_count,0 ) + nvl(dws_data.coupon_get_count,0) - nvl(dws_data_7daysago.coupon_get_count,0) coupon_last_7d_get_count,
	nvl(dwt_data.coupon_last_7d_using_count,0 ) + nvl(dws_data.coupon_using_count,0) - nvl(dws_data_7daysago.coupon_using_count,0) coupon_last_7d_using_count,
	nvl(dwt_data.coupon_last_7d_used_count,0 ) + nvl(dws_data.coupon_used_count,0) - nvl(dws_data_7daysago.coupon_used_count,0) coupon_last_7d_used_count,
	nvl(dwt_data.appraise_last_7d_good_count,0 ) + nvl(dws_data.appraise_good_count,0) - nvl(dws_data_7daysago.appraise_good_count,0) appraise_last_7d_good_count,
	nvl(dwt_data.appraise_last_7d_mid_count,0 ) + nvl(dws_data.appraise_mid_count,0) - nvl(dws_data_7daysago.appraise_mid_count,0) appraise_last_7d_mid_count,
	nvl(dwt_data.appraise_last_7d_bad_count,0 ) + nvl(dws_data.appraise_bad_count,0) - nvl(dws_data_7daysago.appraise_bad_count,0) appraise_last_7d_bad_count,
	nvl(dwt_data.appraise_last_7d_default_count,0 ) + nvl(dws_data.appraise_default_count,0) - nvl(dws_data_7daysago.appraise_default_count,0) appraise_last_7d_default_count,
	nvl(dwt_data.login_last_30d_count,0 ) + nvl(dws_data.login_count,0) - nvl(dws_data_30daysago.login_count,0) login_last_30d_count,
nvl(dwt_data.order_last_30d_count,0 ) + nvl(dws_data.order_count,0) - nvl(dws_data_30daysago.order_count,0) order_last_30d_count,
nvl(dwt_data.order_activity_last_30d_count,0 ) + nvl(dws_data.order_activity_count,0) - nvl(dws_data_30daysago.order_activity_count,0) order_activity_last_30d_count,
nvl(dwt_data.order_activity_reduce_last_30d_amount,0 ) + nvl(dws_data.order_activity_reduce_amount,0) - nvl(dws_data_30daysago.order_activity_reduce_amount,0) order_activity_reduce_last_30d_amount,
nvl(dwt_data.order_coupon_last_30d_count,0 ) + nvl(dws_data.order_coupon_count,0) - nvl(dws_data_30daysago.order_coupon_count,0) order_coupon_last_30d_count,
nvl(dwt_data.order_coupon_reduce_last_30d_amount,0 ) + nvl(dws_data.order_coupon_reduce_amount,0) - nvl(dws_data_30daysago.order_coupon_reduce_amount,0) order_coupon_reduce_last_30d_amount,
nvl(dwt_data.order_last_30d_original_amount,0 ) + nvl(dws_data.order_original_amount,0) - nvl(dws_data_30daysago.order_original_amount,0) order_last_30d_original_amount,
nvl(dwt_data.order_last_30d_final_amount,0 ) + nvl(dws_data.order_final_amount,0) - nvl(dws_data_30daysago.order_final_amount,0) order_last_30d_final_amount,
nvl(dwt_data.payment_last_30d_count,0 ) + nvl(dws_data.payment_count,0) - nvl(dws_data_30daysago.payment_count,0) payment_last_30d_count,
nvl(dwt_data.payment_last_30d_amount,0 ) + nvl(dws_data.payment_amount,0) - nvl(dws_data_30daysago.payment_amount,0) payment_last_30d_amount,
nvl(dwt_data.refund_order_last_30d_count,0 ) + nvl(dws_data.refund_order_count,0) - nvl(dws_data_30daysago.refund_order_count,0) refund_order_last_30d_count,
nvl(dwt_data.refund_order_last_30d_num,0 ) + nvl(dws_data.refund_order_num,0) - nvl(dws_data_30daysago.refund_order_num,0) refund_order_last_30d_num,
nvl(dwt_data.refund_order_last_30d_amount,0 ) + nvl(dws_data.refund_order_amount,0) - nvl(dws_data_30daysago.refund_order_amount,0) refund_order_last_30d_amount,
nvl(dwt_data.refund_payment_last_30d_count,0 ) + nvl(dws_data.refund_payment_count,0) - nvl(dws_data_30daysago.refund_payment_count,0) refund_payment_last_30d_count,
nvl(dwt_data.refund_payment_last_30d_num,0 ) + nvl(dws_data.refund_payment_num,0) - nvl(dws_data_30daysago.refund_payment_num,0) refund_payment_last_30d_num,
nvl(dwt_data.refund_payment_last_30d_amount,0 ) + nvl(dws_data.refund_payment_amount,0) - nvl(dws_data_30daysago.refund_payment_amount,0) refund_payment_last_30d_amount,
nvl(dwt_data.cart_last_30d_count,0 ) + nvl(dws_data.cart_count,0) - nvl(dws_data_30daysago.cart_count,0) cart_last_30d_count,
nvl(dwt_data.favor_last_30d_count,0 ) + nvl(dws_data.favor_count,0) - nvl(dws_data_30daysago.favor_count,0) favor_last_30d_count,
nvl(dwt_data.coupon_last_30d_get_count,0 ) + nvl(dws_data.coupon_get_count,0) - nvl(dws_data_30daysago.coupon_get_count,0) coupon_last_30d_get_count,
nvl(dwt_data.coupon_last_30d_using_count,0 ) + nvl(dws_data.coupon_using_count,0) - nvl(dws_data_30daysago.coupon_using_count,0) coupon_last_30d_using_count,
nvl(dwt_data.coupon_last_30d_used_count,0 ) + nvl(dws_data.coupon_used_count,0) - nvl(dws_data_30daysago.coupon_used_count,0) coupon_last_30d_used_count,
nvl(dwt_data.appraise_last_30d_good_count,0 ) + nvl(dws_data.appraise_good_count,0) - nvl(dws_data_30daysago.appraise_good_count,0) appraise_last_30d_good_count,
nvl(dwt_data.appraise_last_30d_mid_count,0 ) + nvl(dws_data.appraise_mid_count,0) - nvl(dws_data_30daysago.appraise_mid_count,0) appraise_last_30d_mid_count,
nvl(dwt_data.appraise_last_30d_bad_count,0 ) + nvl(dws_data.appraise_bad_count,0) - nvl(dws_data_30daysago.appraise_bad_count,0) appraise_last_30d_bad_count,
nvl(dwt_data.appraise_last_30d_default_count,0 ) + nvl(dws_data.appraise_default_count,0) - nvl(dws_data_30daysago.appraise_default_count,0) appraise_last_30d_default_count
from 
(SELECT 
   *
from  dwt_user_topic 
where dt=date_sub('2021-05-08',1) ) dwt_data
full  join
-- 求dim层今日新注册，但是不登录的用户 和  dws层今天发生行为用户的所有数据 ，这些是应该汇总到dwt的数据
(SELECT 
	 nvl(dws_user_action.user_id, user_info.id) user_id,
		nvl(dws_user_action.login_count, 0) login_count,
		nvl(dws_user_action.cart_count, 0) cart_count,
		nvl(dws_user_action.favor_count, 0) favor_count,
		nvl(dws_user_action.order_count, 0) order_count,
		nvl(dws_user_action.order_activity_count, 0) order_activity_count,
		nvl(dws_user_action.order_activity_reduce_amount, 0) order_activity_reduce_amount,
		nvl(dws_user_action.order_coupon_count, 0) order_coupon_count,
		nvl(dws_user_action.order_coupon_reduce_amount, 0) order_coupon_reduce_amount,
		nvl(dws_user_action.order_original_amount, 0) order_original_amount,
		nvl(dws_user_action.order_final_amount, 0) order_final_amount,
		nvl(dws_user_action.payment_count, 0) payment_count,
		nvl(dws_user_action.payment_amount, 0) payment_amount,
		nvl(dws_user_action.refund_order_count, 0) refund_order_count,
		nvl(dws_user_action.refund_order_num, 0) refund_order_num,
		nvl(dws_user_action.refund_order_amount, 0) refund_order_amount,
		nvl(dws_user_action.refund_payment_count, 0) refund_payment_count,
		nvl(dws_user_action.refund_payment_num, 0) refund_payment_num,
		nvl(dws_user_action.refund_payment_amount, 0) refund_payment_amount,
		nvl(dws_user_action.coupon_get_count, 0) coupon_get_count,
		nvl(dws_user_action.coupon_using_count, 0) coupon_using_count,
		nvl(dws_user_action.coupon_used_count, 0) coupon_used_count,
		nvl(dws_user_action.appraise_good_count, 0) appraise_good_count,
		nvl(dws_user_action.appraise_mid_count, 0) appraise_mid_count,
		nvl(dws_user_action.appraise_bad_count, 0) appraise_bad_count,
		nvl(dws_user_action.appraise_default_count, 0) appraise_default_count
from
(SELECT 
	id
from dim_user_info 
-- 所有用户的最新信息
where dt='9999-99-99'  
and date_format(start_date,'yyyy-MM-dd') = '2021-05-08'  ) user_info
full join
(select
   *
from dws_user_action_daycount
--取今日所有产生行为的用户
where dt='2021-05-08' ) dws_user_action
on user_info.id=dws_user_action.user_id ) dws_data
on dwt_data.user_id = dws_data.user_id
left join
-- 关联  dws_data7天之前的统计的数据
(select
   *
from dws_user_action_daycount
--取今日所有产生行为的用户
where dt=date_sub('2021-05-08',7) ) dws_data_7daysago
on dwt_data.user_id = dws_data_7daysago.user_id
left join
-- 关联  dws_data30天之前的统计的数据
(select
   *
from dws_user_action_daycount
--取今日所有产生行为的用户
where dt=date_sub('2021-05-08',30) ) dws_data_30daysago
on dwt_data.user_id = dws_data_30daysago.user_id ) tmp;
```









## 4.dwt_sku_topic

和dwt_user_topic 导入思路相同。

  dws_sku_action_daycount:  统计的是每天产生行为的商品信息。



dwt_sku_topic:  截至到现在，累积的所有的商品信息。

​	首日导入：      将dws所有产生行为的商品进行累积统计  +   没有产生行为的商品

### 4.1 建表

```sql
CREATE EXTERNAL TABLE dwt_sku_topic
(
    `sku_id` STRING COMMENT 'sku_id',
    `order_last_1d_count` BIGINT COMMENT '最近1日被下单次数',
    `order_last_1d_num` BIGINT COMMENT '最近1日被下单件数',
    `order_activity_last_1d_count` BIGINT COMMENT '最近1日参与活动被下单次数',
    `order_coupon_last_1d_count` BIGINT COMMENT '最近1日使用优惠券被下单次数',
    `order_activity_reduce_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日优惠金额(活动)',
    `order_coupon_reduce_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日优惠金额(优惠券)',
    `order_last_1d_original_amount` DECIMAL(16,2) COMMENT '最近1日被下单原始金额',
    `order_last_1d_final_amount` DECIMAL(16,2) COMMENT '最近1日被下单最终金额',
    `order_last_7d_count` BIGINT COMMENT '最近7日被下单次数',
    `order_last_7d_num` BIGINT COMMENT '最近7日被下单件数',
    `order_activity_last_7d_count` BIGINT COMMENT '最近7日参与活动被下单次数',
    `order_coupon_last_7d_count` BIGINT COMMENT '最近7日使用优惠券被下单次数',
    `order_activity_reduce_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日优惠金额(活动)',
    `order_coupon_reduce_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日优惠金额(优惠券)',
    `order_last_7d_original_amount` DECIMAL(16,2) COMMENT '最近7日被下单原始金额',
    `order_last_7d_final_amount` DECIMAL(16,2) COMMENT '最近7日被下单最终金额',
    `order_last_30d_count` BIGINT COMMENT '最近30日被下单次数',
    `order_last_30d_num` BIGINT COMMENT '最近30日被下单件数',
    `order_activity_last_30d_count` BIGINT COMMENT '最近30日参与活动被下单次数',
    `order_coupon_last_30d_count` BIGINT COMMENT '最近30日使用优惠券被下单次数',
    `order_activity_reduce_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日优惠金额(活动)',
    `order_coupon_reduce_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日优惠金额(优惠券)',
    `order_last_30d_original_amount` DECIMAL(16,2) COMMENT '最近30日被下单原始金额',
    `order_last_30d_final_amount` DECIMAL(16,2) COMMENT '最近30日被下单最终金额',
    `order_count` BIGINT COMMENT '累积被下单次数',
    `order_num` BIGINT COMMENT '累积被下单件数',
    `order_activity_count` BIGINT COMMENT '累积参与活动被下单次数',
    `order_coupon_count` BIGINT COMMENT '累积使用优惠券被下单次数',
    `order_activity_reduce_amount` DECIMAL(16,2) COMMENT '累积优惠金额(活动)',
    `order_coupon_reduce_amount` DECIMAL(16,2) COMMENT '累积优惠金额(优惠券)',
    `order_original_amount` DECIMAL(16,2) COMMENT '累积被下单原始金额',
    `order_final_amount` DECIMAL(16,2) COMMENT '累积被下单最终金额',
    `payment_last_1d_count` BIGINT COMMENT '最近1日被支付次数',
    `payment_last_1d_num` BIGINT COMMENT '最近1日被支付件数',
    `payment_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日被支付金额',
    `payment_last_7d_count` BIGINT COMMENT '最近7日被支付次数',
    `payment_last_7d_num` BIGINT COMMENT '最近7日被支付件数',
    `payment_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日被支付金额',
    `payment_last_30d_count` BIGINT COMMENT '最近30日被支付次数',
    `payment_last_30d_num` BIGINT COMMENT '最近30日被支付件数',
    `payment_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日被支付金额',
    `payment_count` BIGINT COMMENT '累积被支付次数',
    `payment_num` BIGINT COMMENT '累积被支付件数',
    `payment_amount` DECIMAL(16,2) COMMENT '累积被支付金额',
    `refund_order_last_1d_count` BIGINT COMMENT '最近1日退单次数',
    `refund_order_last_1d_num` BIGINT COMMENT '最近1日退单件数',
    `refund_order_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日退单金额',
    `refund_order_last_7d_count` BIGINT COMMENT '最近7日退单次数',
    `refund_order_last_7d_num` BIGINT COMMENT '最近7日退单件数',
    `refund_order_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日退单金额',
    `refund_order_last_30d_count` BIGINT COMMENT '最近30日退单次数',
    `refund_order_last_30d_num` BIGINT COMMENT '最近30日退单件数',
    `refund_order_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日退单金额',
    `refund_order_count` BIGINT COMMENT '累积退单次数',
    `refund_order_num` BIGINT COMMENT '累积退单件数',
    `refund_order_amount` DECIMAL(16,2) COMMENT '累积退单金额',
    `refund_payment_last_1d_count` BIGINT COMMENT '最近1日退款次数',
    `refund_payment_last_1d_num` BIGINT COMMENT '最近1日退款件数',
    `refund_payment_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日退款金额',
    `refund_payment_last_7d_count` BIGINT COMMENT '最近7日退款次数',
    `refund_payment_last_7d_num` BIGINT COMMENT '最近7日退款件数',
    `refund_payment_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日退款金额',
    `refund_payment_last_30d_count` BIGINT COMMENT '最近30日退款次数',
    `refund_payment_last_30d_num` BIGINT COMMENT '最近30日退款件数',
    `refund_payment_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日退款金额',
    `refund_payment_count` BIGINT COMMENT '累积退款次数',
    `refund_payment_num` BIGINT COMMENT '累积退款件数',
    `refund_payment_amount` DECIMAL(16,2) COMMENT '累积退款金额',
    `cart_last_1d_count` BIGINT COMMENT '最近1日被加入购物车次数',
    `cart_last_7d_count` BIGINT COMMENT '最近7日被加入购物车次数',
    `cart_last_30d_count` BIGINT COMMENT '最近30日被加入购物车次数',
    `cart_count` BIGINT COMMENT '累积被加入购物车次数',
    `favor_last_1d_count` BIGINT COMMENT '最近1日被收藏次数',
    `favor_last_7d_count` BIGINT COMMENT '最近7日被收藏次数',
    `favor_last_30d_count` BIGINT COMMENT '最近30日被收藏次数',
    `favor_count` BIGINT COMMENT '累积被收藏次数',
    `appraise_last_1d_good_count` BIGINT COMMENT '最近1日好评数',
    `appraise_last_1d_mid_count` BIGINT COMMENT '最近1日中评数',
    `appraise_last_1d_bad_count` BIGINT COMMENT '最近1日差评数',
    `appraise_last_1d_default_count` BIGINT COMMENT '最近1日默认评价数',
    `appraise_last_7d_good_count` BIGINT COMMENT '最近7日好评数',
    `appraise_last_7d_mid_count` BIGINT COMMENT '最近7日中评数',
    `appraise_last_7d_bad_count` BIGINT COMMENT '最近7日差评数',
    `appraise_last_7d_default_count` BIGINT COMMENT '最近7日默认评价数',
    `appraise_last_30d_good_count` BIGINT COMMENT '最近30日好评数',
    `appraise_last_30d_mid_count` BIGINT COMMENT '最近30日中评数',
    `appraise_last_30d_bad_count` BIGINT COMMENT '最近30日差评数',
    `appraise_last_30d_default_count` BIGINT COMMENT '最近30日默认评价数',
    `appraise_good_count` BIGINT COMMENT '累积好评数',
    `appraise_mid_count` BIGINT COMMENT '累积中评数',
    `appraise_bad_count` BIGINT COMMENT '累积差评数',
    `appraise_default_count` BIGINT COMMENT '累积默认评价数'
 )COMMENT '商品主题宽表'
```



### 4.2 导入数据

#### 4.2.1 首日导入

```sql
INSERT overwrite table dwt_sku_topic partition(dt='2021-05-07')
SELECT 
		sku_info.id sku_id,
		nvl(order_last_1d_count,0 )  order_last_1d_count,
	nvl(order_last_1d_num,0 )  order_last_1d_num,
	nvl(order_activity_last_1d_count,0 )  order_activity_last_1d_count,
	nvl(order_coupon_last_1d_count,0 )  order_coupon_last_1d_count,
	nvl(order_activity_reduce_last_1d_amount,0.0 )  order_activity_reduce_last_1d_amount,
	nvl(order_coupon_reduce_last_1d_amount,0.0 )  order_coupon_reduce_last_1d_amount,
	nvl(order_last_1d_original_amount,0.0 )  order_last_1d_original_amount,
	nvl(order_last_1d_final_amount,0.0 )  order_last_1d_final_amount,
	nvl(order_last_7d_count,0 )  order_last_7d_count,
	nvl(order_last_7d_num,0 )  order_last_7d_num,
	nvl(order_activity_last_7d_count,0 )  order_activity_last_7d_count,
	nvl(order_coupon_last_7d_count,0 )  order_coupon_last_7d_count,
	nvl(order_activity_reduce_last_7d_amount,0.0 )  order_activity_reduce_last_7d_amount,
	nvl(order_coupon_reduce_last_7d_amount,0.0 )  order_coupon_reduce_last_7d_amount,
	nvl(order_last_7d_original_amount,0.0 )  order_last_7d_original_amount,
	nvl(order_last_7d_final_amount,0.0 )  order_last_7d_final_amount,
	nvl(order_last_30d_count,0 )  order_last_30d_count,
	nvl(order_last_30d_num,0 )  order_last_30d_num,
	nvl(order_activity_last_30d_count,0 )  order_activity_last_30d_count,
	nvl(order_coupon_last_30d_count,0 )  order_coupon_last_30d_count,
	nvl(order_activity_reduce_last_30d_amount,0.0 )  order_activity_reduce_last_30d_amount,
	nvl(order_coupon_reduce_last_30d_amount,0.0 )  order_coupon_reduce_last_30d_amount,
	nvl(order_last_30d_original_amount,0.0 )  order_last_30d_original_amount,
	nvl(order_last_30d_final_amount,0.0 )  order_last_30d_final_amount,
	nvl(order_count,0 )  order_count,
	nvl(order_num,0 )  order_num,
	nvl(order_activity_count,0 )  order_activity_count,
	nvl(order_coupon_count,0 )  order_coupon_count,
	nvl(order_activity_reduce_amount,0.0 )  order_activity_reduce_amount,
	nvl(order_coupon_reduce_amount,0.0 )  order_coupon_reduce_amount,
	nvl(order_original_amount,0.0 )  order_original_amount,
	nvl(order_final_amount,0.0 )  order_final_amount,
	nvl(payment_last_1d_count,0 )  payment_last_1d_count,
	nvl(payment_last_1d_num,0 )  payment_last_1d_num,
	nvl(payment_last_1d_amount,0.0 )  payment_last_1d_amount,
	nvl(payment_last_7d_count,0 )  payment_last_7d_count,
	nvl(payment_last_7d_num,0 )  payment_last_7d_num,
	nvl(payment_last_7d_amount,0.0 )  payment_last_7d_amount,
	nvl(payment_last_30d_count,0 )  payment_last_30d_count,
	nvl(payment_last_30d_num,0 )  payment_last_30d_num,
	nvl(payment_last_30d_amount,0.0 )  payment_last_30d_amount,
	nvl(payment_count,0 )  payment_count,
	nvl(payment_num,0 )  payment_num,
	nvl(payment_amount,0.0 )  payment_amount,
	nvl(refund_order_last_1d_count,0 )  refund_order_last_1d_count,
	nvl(refund_order_last_1d_num,0 )  refund_order_last_1d_num,
	nvl(refund_order_last_1d_amount,0.0 )  refund_order_last_1d_amount,
	nvl(refund_order_last_7d_count,0 )  refund_order_last_7d_count,
	nvl(refund_order_last_7d_num,0 )  refund_order_last_7d_num,
	nvl(refund_order_last_7d_amount,0.0 )  refund_order_last_7d_amount,
	nvl(refund_order_last_30d_count,0 )  refund_order_last_30d_count,
	nvl(refund_order_last_30d_num,0 )  refund_order_last_30d_num,
	nvl(refund_order_last_30d_amount,0.0 )  refund_order_last_30d_amount,
	nvl(refund_order_count,0 )  refund_order_count,
	nvl(refund_order_num,0 )  refund_order_num,
	nvl(refund_order_amount,0.0 )  refund_order_amount,
	nvl(refund_payment_last_1d_count,0 )  refund_payment_last_1d_count,
	nvl(refund_payment_last_1d_num,0 )  refund_payment_last_1d_num,
	nvl(refund_payment_last_1d_amount,0.0 )  refund_payment_last_1d_amount,
	nvl(refund_payment_last_7d_count,0 )  refund_payment_last_7d_count,
	nvl(refund_payment_last_7d_num,0 )  refund_payment_last_7d_num,
	nvl(refund_payment_last_7d_amount,0.0 )  refund_payment_last_7d_amount,
	nvl(refund_payment_last_30d_count,0 )  refund_payment_last_30d_count,
	nvl(refund_payment_last_30d_num,0 )  refund_payment_last_30d_num,
	nvl(refund_payment_last_30d_amount,0.0 )  refund_payment_last_30d_amount,
	nvl(refund_payment_count,0 )  refund_payment_count,
	nvl(refund_payment_num,0 )  refund_payment_num,
	nvl(refund_payment_amount,0.0 )  refund_payment_amount,
	nvl(cart_last_1d_count,0 )  cart_last_1d_count,
	nvl(cart_last_7d_count,0 )  cart_last_7d_count,
	nvl(cart_last_30d_count,0 )  cart_last_30d_count,
	nvl(cart_count,0 )  cart_count,
	nvl(favor_last_1d_count,0 )  favor_last_1d_count,
	nvl(favor_last_7d_count,0 )  favor_last_7d_count,
	nvl(favor_last_30d_count,0 )  favor_last_30d_count,
	nvl(favor_count,0 )  favor_count,
	nvl(appraise_last_1d_good_count,0 )  appraise_last_1d_good_count,
	nvl(appraise_last_1d_mid_count,0 )  appraise_last_1d_mid_count,
	nvl(appraise_last_1d_bad_count,0 )  appraise_last_1d_bad_count,
	nvl(appraise_last_1d_default_count,0 )  appraise_last_1d_default_count,
	nvl(appraise_last_7d_good_count,0 )  appraise_last_7d_good_count,
	nvl(appraise_last_7d_mid_count,0 )  appraise_last_7d_mid_count,
	nvl(appraise_last_7d_bad_count,0 )  appraise_last_7d_bad_count,
	nvl(appraise_last_7d_default_count,0 )  appraise_last_7d_default_count,
	nvl(appraise_last_30d_good_count,0 )  appraise_last_30d_good_count,
	nvl(appraise_last_30d_mid_count,0 )  appraise_last_30d_mid_count,
	nvl(appraise_last_30d_bad_count,0 )  appraise_last_30d_bad_count,
	nvl(appraise_last_30d_default_count,0 )  appraise_last_30d_default_count,
	nvl(appraise_good_count,0 )  appraise_good_count,
	nvl(appraise_mid_count,0 )  appraise_mid_count,
	nvl(appraise_bad_count,0 )  appraise_bad_count,
	nvl(appraise_default_count,0 )  appraise_default_count
from
--还有商品，可能比较冷门，不会产生行为
(SELECT 
	id 
--取截至到5-7日所有的商品
from  dim_sku_info 
where dt='2021-05-07' ) sku_info
left join
(SELECT 
		sku_id,
		--累积   sum()
		sum(order_num) order_num,
	sum(payment_num) payment_num,
	sum(refund_order_num) refund_order_num,
	sum(refund_payment_num) refund_payment_num,
	sum(order_count) order_count,
	sum(order_activity_count) order_activity_count,
	sum(order_coupon_count) order_coupon_count,
	sum(order_activity_reduce_amount) order_activity_reduce_amount,
	sum(order_coupon_reduce_amount) order_coupon_reduce_amount,
	sum(order_original_amount) order_original_amount,
	sum(order_final_amount) order_final_amount,
	sum(payment_count) payment_count,
	sum(payment_amount) payment_amount,
	sum(refund_order_count) refund_order_count,
	sum(refund_order_amount) refund_order_amount,
	sum(refund_payment_count) refund_payment_count,
	sum(refund_payment_amount) refund_payment_amount,
	sum(cart_count) cart_count,
	sum(favor_count) favor_count,
	sum(appraise_good_count) appraise_good_count,
	sum(appraise_mid_count) appraise_mid_count,
	sum(appraise_bad_count) appraise_bad_count,
	sum(appraise_default_count) appraise_default_count,
		--最近1日的 ，取 dt='2021-05-07' 当日dws表中的数据，之后进行sum
		sum(if(dt='2021-05-07',order_num , 0 )) order_last_1d_num,
	sum(if(dt='2021-05-07',payment_num , 0 )) payment_last_1d_num,
	sum(if(dt='2021-05-07',refund_order_num , 0 )) refund_order_last_1d_num,
	sum(if(dt='2021-05-07',refund_payment_num , 0 )) refund_payment_last_1d_num,
	sum(if(dt='2021-05-07',order_count , 0 )) order_last_1d_count,
	sum(if(dt='2021-05-07',order_activity_count , 0 )) order_activity_last_1d_count,
	sum(if(dt='2021-05-07',order_coupon_count , 0 )) order_coupon_last_1d_count,
	sum(if(dt='2021-05-07',order_activity_reduce_amount , 0 )) order_activity_reduce_last_1d_amount,
	sum(if(dt='2021-05-07',order_coupon_reduce_amount , 0 )) order_coupon_reduce_last_1d_amount,
	sum(if(dt='2021-05-07',order_original_amount , 0 )) order_last_1d_original_amount,
	sum(if(dt='2021-05-07',order_final_amount , 0 )) order_last_1d_final_amount,
	sum(if(dt='2021-05-07',payment_count , 0 )) payment_last_1d_count,
	sum(if(dt='2021-05-07',payment_amount , 0 )) payment_last_1d_amount,
	sum(if(dt='2021-05-07',refund_order_count , 0 )) refund_order_last_1d_count,
	sum(if(dt='2021-05-07',refund_order_amount , 0 )) refund_order_last_1d_amount,
	sum(if(dt='2021-05-07',refund_payment_count , 0 )) refund_payment_last_1d_count,
	sum(if(dt='2021-05-07',refund_payment_amount , 0 )) refund_payment_last_1d_amount,
	sum(if(dt='2021-05-07',cart_count , 0 )) cart_last_1d_count,
	sum(if(dt='2021-05-07',favor_count , 0 )) favor_last_1d_count,
	sum(if(dt='2021-05-07',appraise_good_count , 0 )) appraise_last_1d_good_count,
	sum(if(dt='2021-05-07',appraise_mid_count , 0 )) appraise_last_1d_mid_count,
	sum(if(dt='2021-05-07',appraise_bad_count , 0 )) appraise_last_1d_bad_count,
	sum(if(dt='2021-05-07',appraise_default_count , 0 )) appraise_last_1d_default_count,
			--最近7日的 ，取 dt>date_sub('2021-05-07',7) ，将符合要求的dws表中的数据，进行sum
	sum(if(dt>date_sub('2021-05-07',7),order_num , 0 )) order_last_7d_num,
	sum(if(dt>date_sub('2021-05-07',7),payment_num , 0 )) payment_last_7d_num,
	sum(if(dt>date_sub('2021-05-07',7),refund_order_num , 0 )) refund_order_last_7d_num,
	sum(if(dt>date_sub('2021-05-07',7),refund_payment_num , 0 )) refund_payment_last_7d_num,
	sum(if(dt>date_sub('2021-05-07',7),order_count , 0 )) order_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),order_activity_count , 0 )) order_activity_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),order_coupon_count , 0 )) order_coupon_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),order_activity_reduce_amount , 0 )) order_activity_reduce_last_7d_amount,
	sum(if(dt>date_sub('2021-05-07',7),order_coupon_reduce_amount , 0 )) order_coupon_reduce_last_7d_amount,
	sum(if(dt>date_sub('2021-05-07',7),order_original_amount , 0 )) order_last_7d_original_amount,
	sum(if(dt>date_sub('2021-05-07',7),order_final_amount , 0 )) order_last_7d_final_amount,
	sum(if(dt>date_sub('2021-05-07',7),payment_count , 0 )) payment_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),payment_amount , 0 )) payment_last_7d_amount,
	sum(if(dt>date_sub('2021-05-07',7),refund_order_count , 0 )) refund_order_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),refund_order_amount , 0 )) refund_order_last_7d_amount,
	sum(if(dt>date_sub('2021-05-07',7),refund_payment_count , 0 )) refund_payment_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),refund_payment_amount , 0 )) refund_payment_last_7d_amount,
	sum(if(dt>date_sub('2021-05-07',7),cart_count , 0 )) cart_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),favor_count , 0 )) favor_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),appraise_good_count , 0 )) appraise_last_7d_good_count,
	sum(if(dt>date_sub('2021-05-07',7),appraise_mid_count , 0 )) appraise_last_7d_mid_count,
	sum(if(dt>date_sub('2021-05-07',7),appraise_bad_count , 0 )) appraise_last_7d_bad_count,
	sum(if(dt>date_sub('2021-05-07',7),appraise_default_count , 0 )) appraise_last_7d_default_count,
	--最近30日的 ，取 dt>date_sub('2021-05-07',30) ，将符合要求的dws表中的数据，进行sum
	sum(if(dt>date_sub('2021-05-07',30),order_num , 0 )) order_last_30d_num,
	sum(if(dt>date_sub('2021-05-07',30),payment_num , 0 )) payment_last_30d_num,
	sum(if(dt>date_sub('2021-05-07',30),refund_order_num , 0 )) refund_order_last_30d_num,
	sum(if(dt>date_sub('2021-05-07',30),refund_payment_num , 0 )) refund_payment_last_30d_num,
	sum(if(dt>date_sub('2021-05-07',30),order_count , 0 )) order_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),order_activity_count , 0 )) order_activity_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),order_coupon_count , 0 )) order_coupon_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),order_activity_reduce_amount , 0 )) order_activity_reduce_last_30d_amount,
	sum(if(dt>date_sub('2021-05-07',30),order_coupon_reduce_amount , 0 )) order_coupon_reduce_last_30d_amount,
	sum(if(dt>date_sub('2021-05-07',30),order_original_amount , 0 )) order_last_30d_original_amount,
	sum(if(dt>date_sub('2021-05-07',30),order_final_amount , 0 )) order_last_30d_final_amount,
	sum(if(dt>date_sub('2021-05-07',30),payment_count , 0 )) payment_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),payment_amount , 0 )) payment_last_30d_amount,
	sum(if(dt>date_sub('2021-05-07',30),refund_order_count , 0 )) refund_order_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),refund_order_amount , 0 )) refund_order_last_30d_amount,
	sum(if(dt>date_sub('2021-05-07',30),refund_payment_count , 0 )) refund_payment_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),refund_payment_amount , 0 )) refund_payment_last_30d_amount,
	sum(if(dt>date_sub('2021-05-07',30),cart_count , 0 )) cart_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),favor_count , 0 )) favor_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),appraise_good_count , 0 )) appraise_last_30d_good_count,
	sum(if(dt>date_sub('2021-05-07',30),appraise_mid_count , 0 )) appraise_last_30d_mid_count,
	sum(if(dt>date_sub('2021-05-07',30),appraise_bad_count , 0 )) appraise_last_30d_bad_count,
	sum(if(dt>date_sub('2021-05-07',30),appraise_default_count , 0 )) appraise_last_30d_default_count
		
-- 取出截至到 5-7日每天所有元产生行为的商品的统计信息
from dws_sku_action_daycount 
group by sku_id  ) dws_action_data
on sku_info.id=dws_action_data.sku_id
```



#### 4.2.2 每日导入

```sql
INSERT overwrite table dwt_sku_topic partition(dt='2021-05-08')
SELECT 
    sku_id, order_last_1d_count, order_last_1d_num, order_activity_last_1d_count, 
		order_coupon_last_1d_count, order_activity_reduce_last_1d_amount, order_coupon_reduce_last_1d_amount,
		order_last_1d_original_amount, order_last_1d_final_amount, order_last_7d_count, order_last_7d_num,
		order_activity_last_7d_count, order_coupon_last_7d_count, order_activity_reduce_last_7d_amount,
		order_coupon_reduce_last_7d_amount, order_last_7d_original_amount, order_last_7d_final_amount,
		order_last_30d_count, order_last_30d_num, order_activity_last_30d_count, order_coupon_last_30d_count, 
		order_activity_reduce_last_30d_amount, order_coupon_reduce_last_30d_amount, order_last_30d_original_amount,
		order_last_30d_final_amount, order_count, order_num, order_activity_count, order_coupon_count, 
		order_activity_reduce_amount, order_coupon_reduce_amount, order_original_amount, order_final_amount,
		payment_last_1d_count, payment_last_1d_num, payment_last_1d_amount, payment_last_7d_count,
		payment_last_7d_num, payment_last_7d_amount, payment_last_30d_count, payment_last_30d_num,
		payment_last_30d_amount, payment_count, payment_num, payment_amount, refund_order_last_1d_count, 
		refund_order_last_1d_num, refund_order_last_1d_amount, refund_order_last_7d_count, 
		refund_order_last_7d_num, refund_order_last_7d_amount, refund_order_last_30d_count, 
		refund_order_last_30d_num, refund_order_last_30d_amount, refund_order_count, refund_order_num,
		refund_order_amount, refund_payment_last_1d_count, refund_payment_last_1d_num, 
		refund_payment_last_1d_amount, refund_payment_last_7d_count, refund_payment_last_7d_num,
		refund_payment_last_7d_amount, refund_payment_last_30d_count, refund_payment_last_30d_num,
		refund_payment_last_30d_amount, refund_payment_count, refund_payment_num, refund_payment_amount,
		cart_last_1d_count, cart_last_7d_count, cart_last_30d_count, cart_count, favor_last_1d_count,
		favor_last_7d_count, favor_last_30d_count, favor_count, appraise_last_1d_good_count, 
		appraise_last_1d_mid_count, appraise_last_1d_bad_count, appraise_last_1d_default_count, 
		appraise_last_7d_good_count, appraise_last_7d_mid_count, appraise_last_7d_bad_count,
		appraise_last_7d_default_count, appraise_last_30d_good_count, appraise_last_30d_mid_count,
		appraise_last_30d_bad_count, appraise_last_30d_default_count, appraise_good_count, 
		appraise_mid_count, appraise_bad_count, appraise_default_count
from
(SELECT 
		  nvl(dws_data.sku_id,dwt_data.sku_id)		sku_id ,
		  --累积      nvl(dwt_data.a,0) +  nvl(dws_data.a,0)
		  -- 最近1天  nvl(dws_data.a,0)
		  --最近7天  采取滑动运算   nvl(dwt_data.最近7天,0) +  nvl(dws_data.当天数据,0) -  nvl(dws_data_7daysago.当天数据,0)
		  --最近30天  采取滑动运算   nvl(dwt_data.最近30天,0) +  nvl(dws_data.当天数据,0) -  nvl(dws_data_30daysago.当天数据,0)
		  -- 累积型的采取   dwt_data.x + dws_data.x
		nvl(dwt_data.order_num,0 ) + nvl(dws_data.order_num ,0 ) order_num,
		nvl(dwt_data.payment_num,0 ) + nvl(dws_data.payment_num ,0 ) payment_num,
		nvl(dwt_data.refund_order_num,0 ) + nvl(dws_data.refund_order_num ,0 ) refund_order_num,
		nvl(dwt_data.refund_payment_num,0 ) + nvl(dws_data.refund_payment_num ,0 ) refund_payment_num,
		nvl(dwt_data.order_count,0 ) + nvl(dws_data.order_count ,0 ) order_count,
		nvl(dwt_data.order_activity_count,0 ) + nvl(dws_data.order_activity_count ,0 ) order_activity_count,
		nvl(dwt_data.order_coupon_count,0 ) + nvl(dws_data.order_coupon_count ,0 ) order_coupon_count,
		nvl(dwt_data.order_activity_reduce_amount,0 ) + nvl(dws_data.order_activity_reduce_amount ,0 ) order_activity_reduce_amount,
		nvl(dwt_data.order_coupon_reduce_amount,0 ) + nvl(dws_data.order_coupon_reduce_amount ,0 ) order_coupon_reduce_amount,
		nvl(dwt_data.order_original_amount,0 ) + nvl(dws_data.order_original_amount ,0 ) order_original_amount,
		nvl(dwt_data.order_final_amount,0 ) + nvl(dws_data.order_final_amount ,0 ) order_final_amount,
		nvl(dwt_data.payment_count,0 ) + nvl(dws_data.payment_count ,0 ) payment_count,
		nvl(dwt_data.payment_amount,0 ) + nvl(dws_data.payment_amount ,0 ) payment_amount,
		nvl(dwt_data.refund_order_count,0 ) + nvl(dws_data.refund_order_count ,0 ) refund_order_count,
		nvl(dwt_data.refund_order_amount,0 ) + nvl(dws_data.refund_order_amount ,0 ) refund_order_amount,
		nvl(dwt_data.refund_payment_count,0 ) + nvl(dws_data.refund_payment_count ,0 ) refund_payment_count,
		nvl(dwt_data.refund_payment_amount,0 ) + nvl(dws_data.refund_payment_amount ,0 ) refund_payment_amount,
		nvl(dwt_data.cart_count,0 ) + nvl(dws_data.cart_count ,0 ) cart_count,
		nvl(dwt_data.favor_count,0 ) + nvl(dws_data.favor_count ,0 ) favor_count,
		nvl(dwt_data.appraise_good_count,0 ) + nvl(dws_data.appraise_good_count ,0 ) appraise_good_count,
		nvl(dwt_data.appraise_mid_count,0 ) + nvl(dws_data.appraise_mid_count ,0 ) appraise_mid_count,
		nvl(dwt_data.appraise_bad_count,0 ) + nvl(dws_data.appraise_bad_count ,0 ) appraise_bad_count,
		nvl(dwt_data.appraise_default_count,0 ) + nvl(dws_data.appraise_default_count ,0 ) appraise_default_count,
		--最近1d 的，根据dws_data.x 在当日的值进行判断
		nvl(dws_data.order_num , 0 ) order_last_1d_num,
		nvl(dws_data.payment_num , 0 ) payment_last_1d_num,
		nvl(dws_data.refund_order_num , 0 ) refund_order_last_1d_num,
		nvl(dws_data.refund_payment_num , 0 ) refund_payment_last_1d_num,
		nvl(dws_data.order_count , 0 ) order_last_1d_count,
		nvl(dws_data.order_activity_count , 0 ) order_activity_last_1d_count,
		nvl(dws_data.order_coupon_count , 0 ) order_coupon_last_1d_count,
		nvl(dws_data.order_activity_reduce_amount , 0 ) order_activity_reduce_last_1d_amount,
		nvl(dws_data.order_coupon_reduce_amount , 0 ) order_coupon_reduce_last_1d_amount,
		nvl(dws_data.order_original_amount , 0 ) order_last_1d_original_amount,
		nvl(dws_data.order_final_amount , 0 ) order_last_1d_final_amount,
		nvl(dws_data.payment_count , 0 ) payment_last_1d_count,
		nvl(dws_data.payment_amount , 0 ) payment_last_1d_amount,
		nvl(dws_data.refund_order_count , 0 ) refund_order_last_1d_count,
		nvl(dws_data.refund_order_amount , 0 ) refund_order_last_1d_amount,
		nvl(dws_data.refund_payment_count , 0 ) refund_payment_last_1d_count,
		nvl(dws_data.refund_payment_amount , 0 ) refund_payment_last_1d_amount,
		nvl(dws_data.cart_count , 0 ) cart_last_1d_count,
		nvl(dws_data.favor_count , 0 ) favor_last_1d_count,
		nvl(dws_data.appraise_good_count , 0 ) appraise_last_1d_good_count,
		nvl(dws_data.appraise_mid_count , 0 ) appraise_last_1d_mid_count,
		nvl(dws_data.appraise_bad_count , 0 ) appraise_last_1d_bad_count,
		nvl(dws_data.appraise_default_count , 0 ) appraise_last_1d_default_count,
		--最近7d ，采取滑动方式处理
		nvl(dwt_data.order_last_7d_num,0) + nvl(dws_data.order_num,0) -nvl(dws_data_7daysago.order_num,0) order_last_7d_num,
nvl(dwt_data.payment_last_7d_num,0) + nvl(dws_data.payment_num,0) -nvl(dws_data_7daysago.payment_num,0) payment_last_7d_num,
nvl(dwt_data.refund_order_last_7d_num,0) + nvl(dws_data.refund_order_num,0) -nvl(dws_data_7daysago.refund_order_num,0) refund_order_last_7d_num,
nvl(dwt_data.refund_payment_last_7d_num,0) + nvl(dws_data.refund_payment_num,0) -nvl(dws_data_7daysago.refund_payment_num,0) refund_payment_last_7d_num,
nvl(dwt_data.order_last_7d_count,0) + nvl(dws_data.order_count,0) -nvl(dws_data_7daysago.order_count,0) order_last_7d_count,
nvl(dwt_data.order_activity_last_7d_count,0) + nvl(dws_data.order_activity_count,0) -nvl(dws_data_7daysago.order_activity_count,0) order_activity_last_7d_count,
nvl(dwt_data.order_coupon_last_7d_count,0) + nvl(dws_data.order_coupon_count,0) -nvl(dws_data_7daysago.order_coupon_count,0) order_coupon_last_7d_count,
nvl(dwt_data.order_activity_reduce_last_7d_amount,0) + nvl(dws_data.order_activity_reduce_amount,0) -nvl(dws_data_7daysago.order_activity_reduce_amount,0) order_activity_reduce_last_7d_amount,
nvl(dwt_data.order_coupon_reduce_last_7d_amount,0) + nvl(dws_data.order_coupon_reduce_amount,0) -nvl(dws_data_7daysago.order_coupon_reduce_amount,0) order_coupon_reduce_last_7d_amount,
nvl(dwt_data.order_last_7d_original_amount,0) + nvl(dws_data.order_original_amount,0) -nvl(dws_data_7daysago.order_original_amount,0) order_last_7d_original_amount,
nvl(dwt_data.order_last_7d_final_amount,0) + nvl(dws_data.order_final_amount,0) -nvl(dws_data_7daysago.order_final_amount,0) order_last_7d_final_amount,
nvl(dwt_data.payment_last_7d_count,0) + nvl(dws_data.payment_count,0) -nvl(dws_data_7daysago.payment_count,0) payment_last_7d_count,
nvl(dwt_data.payment_last_7d_amount,0) + nvl(dws_data.payment_amount,0) -nvl(dws_data_7daysago.payment_amount,0) payment_last_7d_amount,
nvl(dwt_data.refund_order_last_7d_count,0) + nvl(dws_data.refund_order_count,0) -nvl(dws_data_7daysago.refund_order_count,0) refund_order_last_7d_count,
nvl(dwt_data.refund_order_last_7d_amount,0) + nvl(dws_data.refund_order_amount,0) -nvl(dws_data_7daysago.refund_order_amount,0) refund_order_last_7d_amount,
nvl(dwt_data.refund_payment_last_7d_count,0) + nvl(dws_data.refund_payment_count,0) -nvl(dws_data_7daysago.refund_payment_count,0) refund_payment_last_7d_count,
nvl(dwt_data.refund_payment_last_7d_amount,0) + nvl(dws_data.refund_payment_amount,0) -nvl(dws_data_7daysago.refund_payment_amount,0) refund_payment_last_7d_amount,
nvl(dwt_data.cart_last_7d_count,0) + nvl(dws_data.cart_count,0) -nvl(dws_data_7daysago.cart_count,0) cart_last_7d_count,
nvl(dwt_data.favor_last_7d_count,0) + nvl(dws_data.favor_count,0) -nvl(dws_data_7daysago.favor_count,0) favor_last_7d_count,
nvl(dwt_data.appraise_last_7d_good_count,0) + nvl(dws_data.appraise_good_count,0) -nvl(dws_data_7daysago.appraise_good_count,0) appraise_last_7d_good_count,
nvl(dwt_data.appraise_last_7d_mid_count,0) + nvl(dws_data.appraise_mid_count,0) -nvl(dws_data_7daysago.appraise_mid_count,0) appraise_last_7d_mid_count,
nvl(dwt_data.appraise_last_7d_bad_count,0) + nvl(dws_data.appraise_bad_count,0) -nvl(dws_data_7daysago.appraise_bad_count,0) appraise_last_7d_bad_count,
nvl(dwt_data.appraise_last_7d_default_count,0) + nvl(dws_data.appraise_default_count,0) -nvl(dws_data_7daysago.appraise_default_count,0) appraise_last_7d_default_count,
nvl(dwt_data.order_last_30d_num,0) + nvl(dws_data.order_num,0) -nvl(dws_data_30daysago.order_num,0) order_last_30d_num,
nvl(dwt_data.payment_last_30d_num,0) + nvl(dws_data.payment_num,0) -nvl(dws_data_30daysago.payment_num,0) payment_last_30d_num,
nvl(dwt_data.refund_order_last_30d_num,0) + nvl(dws_data.refund_order_num,0) -nvl(dws_data_30daysago.refund_order_num,0) refund_order_last_30d_num,
nvl(dwt_data.refund_payment_last_30d_num,0) + nvl(dws_data.refund_payment_num,0) -nvl(dws_data_30daysago.refund_payment_num,0) refund_payment_last_30d_num,
nvl(dwt_data.order_last_30d_count,0) + nvl(dws_data.order_count,0) -nvl(dws_data_30daysago.order_count,0) order_last_30d_count,
nvl(dwt_data.order_activity_last_30d_count,0) + nvl(dws_data.order_activity_count,0) -nvl(dws_data_30daysago.order_activity_count,0) order_activity_last_30d_count,
nvl(dwt_data.order_coupon_last_30d_count,0) + nvl(dws_data.order_coupon_count,0) -nvl(dws_data_30daysago.order_coupon_count,0) order_coupon_last_30d_count,
nvl(dwt_data.order_activity_reduce_last_30d_amount,0) + nvl(dws_data.order_activity_reduce_amount,0) -nvl(dws_data_30daysago.order_activity_reduce_amount,0) order_activity_reduce_last_30d_amount,
nvl(dwt_data.order_coupon_reduce_last_30d_amount,0) + nvl(dws_data.order_coupon_reduce_amount,0) -nvl(dws_data_30daysago.order_coupon_reduce_amount,0) order_coupon_reduce_last_30d_amount,
nvl(dwt_data.order_last_30d_original_amount,0) + nvl(dws_data.order_original_amount,0) -nvl(dws_data_30daysago.order_original_amount,0) order_last_30d_original_amount,
nvl(dwt_data.order_last_30d_final_amount,0) + nvl(dws_data.order_final_amount,0) -nvl(dws_data_30daysago.order_final_amount,0) order_last_30d_final_amount,
nvl(dwt_data.payment_last_30d_count,0) + nvl(dws_data.payment_count,0) -nvl(dws_data_30daysago.payment_count,0) payment_last_30d_count,
nvl(dwt_data.payment_last_30d_amount,0) + nvl(dws_data.payment_amount,0) -nvl(dws_data_30daysago.payment_amount,0) payment_last_30d_amount,
nvl(dwt_data.refund_order_last_30d_count,0) + nvl(dws_data.refund_order_count,0) -nvl(dws_data_30daysago.refund_order_count,0) refund_order_last_30d_count,
nvl(dwt_data.refund_order_last_30d_amount,0) + nvl(dws_data.refund_order_amount,0) -nvl(dws_data_30daysago.refund_order_amount,0) refund_order_last_30d_amount,
nvl(dwt_data.refund_payment_last_30d_count,0) + nvl(dws_data.refund_payment_count,0) -nvl(dws_data_30daysago.refund_payment_count,0) refund_payment_last_30d_count,
nvl(dwt_data.refund_payment_last_30d_amount,0) + nvl(dws_data.refund_payment_amount,0) -nvl(dws_data_30daysago.refund_payment_amount,0) refund_payment_last_30d_amount,
nvl(dwt_data.cart_last_30d_count,0) + nvl(dws_data.cart_count,0) -nvl(dws_data_30daysago.cart_count,0) cart_last_30d_count,
nvl(dwt_data.favor_last_30d_count,0) + nvl(dws_data.favor_count,0) -nvl(dws_data_30daysago.favor_count,0) favor_last_30d_count,
nvl(dwt_data.appraise_last_30d_good_count,0) + nvl(dws_data.appraise_good_count,0) -nvl(dws_data_30daysago.appraise_good_count,0) appraise_last_30d_good_count,
nvl(dwt_data.appraise_last_30d_mid_count,0) + nvl(dws_data.appraise_mid_count,0) -nvl(dws_data_30daysago.appraise_mid_count,0) appraise_last_30d_mid_count,
nvl(dwt_data.appraise_last_30d_bad_count,0) + nvl(dws_data.appraise_bad_count,0) -nvl(dws_data_30daysago.appraise_bad_count,0) appraise_last_30d_bad_count,
nvl(dwt_data.appraise_last_30d_default_count,0) + nvl(dws_data.appraise_default_count,0) -nvl(dws_data_30daysago.appraise_default_count,0) appraise_last_30d_default_count
		  
from
(SELECT 
  *
from dwt_sku_topic 
where dt=date_sub('2021-05-08',1) ) dwt_data
full join
--从dws当日的累积数据中取
(SELECT 
		nvl(dws_action_data.sku_id,sku_info.id) sku_id,
		  nvl(order_num,0) order_num,
         nvl(payment_num,0) payment_num,
         nvl(refund_order_num,0) refund_order_num,
         nvl(refund_payment_num,0) refund_payment_num,
         nvl(order_count,0) order_count,
         nvl(order_activity_count,0) order_activity_count,
         nvl(order_coupon_count,0) order_coupon_count,
         nvl(order_activity_reduce_amount,0) order_activity_reduce_amount,
         nvl(order_coupon_reduce_amount,0) order_coupon_reduce_amount,
         nvl(order_original_amount,0) order_original_amount,
         nvl(order_final_amount,0) order_final_amount,
         nvl(payment_count,0) payment_count,
         nvl(payment_amount,0) payment_amount,
         nvl(refund_order_count,0) refund_order_count,
         nvl(refund_order_amount,0) refund_order_amount,
         nvl(refund_payment_count,0) refund_payment_count,
         nvl(refund_payment_amount,0) refund_payment_amount,
         nvl(cart_count,0) cart_count,
         nvl(favor_count,0) favor_count,
         nvl(appraise_good_count,0) appraise_good_count,
         nvl(appraise_mid_count,0) appraise_mid_count,
         nvl(appraise_bad_count,0) appraise_bad_count,
         nvl(appraise_default_count,0) appraise_default_count
from
(
--取当日的新商品信息
SELECT 
   id
from dim_sku_info 
where dt='2021-05-08' and 
date_format(create_time,'yyyy-MM-dd')= '2021-05-08') sku_info
full join
(
--当日所有产生行为的商品的信息
SELECT 
  *
from dws_sku_action_daycount 
where dt='2021-05-08' )  dws_action_data
on sku_info.id=dws_action_data.sku_id ) dws_data
on dwt_data.sku_id=dws_data.sku_id
left join
--取dws在7天前的统计信息
(
--当日所有产生行为的商品的信息
SELECT 
  *
from dws_sku_action_daycount 
where dt=date_sub('2021-05-08',7) )  dws_data_7daysago
on dwt_data.sku_id=dws_data_7daysago.sku_id
left join
--取dws在30天前的统计信息
(SELECT 
  *
from dws_sku_action_daycount 
where dt=date_sub('2021-05-08',30) )  dws_data_30daysago
on dwt_data.sku_id=dws_data_30daysago.sku_id ) tmp
```





## 5.dwt_coupon_topic

dws_coupon_action_daycount :   统计的是当日有效的优惠券的所有行为



dwt_coupon_topic： 

首日导入：  截至到首日，商城所有的优惠券的统计行为

### 5.1 建表

```sql
CREATE EXTERNAL TABLE dwt_coupon_topic(
    `coupon_id` STRING COMMENT '优惠券ID',
    `get_last_1d_count` BIGINT COMMENT '最近1日领取次数',
    `get_last_7d_count` BIGINT COMMENT '最近7日领取次数',
    `get_last_30d_count` BIGINT COMMENT '最近30日领取次数',
    `get_count` BIGINT COMMENT '累积领取次数',
    `order_last_1d_count` BIGINT COMMENT '最近1日使用某券下单次数',
    `order_last_1d_reduce_amount` DECIMAL(16,2) COMMENT '最近1日使用某券下单优惠金额',
    `order_last_1d_original_amount` DECIMAL(16,2) COMMENT '最近1日使用某券下单原始金额',
    `order_last_1d_final_amount` DECIMAL(16,2) COMMENT '最近1日使用某券下单最终金额',
    `order_last_7d_count` BIGINT COMMENT '最近7日使用某券下单次数',
    `order_last_7d_reduce_amount` DECIMAL(16,2) COMMENT '最近7日使用某券下单优惠金额',
    `order_last_7d_original_amount` DECIMAL(16,2) COMMENT '最近7日使用某券下单原始金额',
    `order_last_7d_final_amount` DECIMAL(16,2) COMMENT '最近7日使用某券下单最终金额',
    `order_last_30d_count` BIGINT COMMENT '最近30日使用某券下单次数',
    `order_last_30d_reduce_amount` DECIMAL(16,2) COMMENT '最近30日使用某券下单优惠金额',
    `order_last_30d_original_amount` DECIMAL(16,2) COMMENT '最近30日使用某券下单原始金额',
    `order_last_30d_final_amount` DECIMAL(16,2) COMMENT '最近30日使用某券下单最终金额',
    `order_count` BIGINT COMMENT '累积使用(下单)次数',
    `order_reduce_amount` DECIMAL(16,2) COMMENT '使用某券累积下单优惠金额',
    `order_original_amount` DECIMAL(16,2) COMMENT '使用某券累积下单原始金额',
    `order_final_amount` DECIMAL(16,2) COMMENT '使用某券累积下单最终金额',
    `payment_last_1d_count` BIGINT COMMENT '最近1日使用某券支付次数',
    `payment_last_1d_reduce_amount` DECIMAL(16,2) COMMENT '最近1日使用某券优惠金额',
    `payment_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日使用某券支付金额',
    `payment_last_7d_count` BIGINT COMMENT '最近7日使用某券支付次数',
    `payment_last_7d_reduce_amount` DECIMAL(16,2) COMMENT '最近7日使用某券优惠金额',
    `payment_last_7d_amount` DECIMAL(16,2) COMMENT '最近7日使用某券支付金额',
    `payment_last_30d_count` BIGINT COMMENT '最近30日使用某券支付次数',
    `payment_last_30d_reduce_amount` DECIMAL(16,2) COMMENT '最近30日使用某券优惠金额',
    `payment_last_30d_amount` DECIMAL(16,2) COMMENT '最近30日使用某券支付金额',
    `payment_count` BIGINT COMMENT '累积使用(支付)次数',
    `payment_reduce_amount` DECIMAL(16,2) COMMENT '使用某券累积优惠金额',
    `payment_amount` DECIMAL(16,2) COMMENT '使用某券累积支付金额',
    `expire_last_1d_count` BIGINT COMMENT '最近1日过期次数',
    `expire_last_7d_count` BIGINT COMMENT '最近7日过期次数',
    `expire_last_30d_count` BIGINT COMMENT '最近30日过期次数',
    `expire_count` BIGINT COMMENT '累积过期次数'
)comment '优惠券主题表'
```



### 5.2 导入数据

#### 5.2.1 首日导入

```sql
INSERT overwrite table dwt_coupon_topic partition(dt='2021-05-07')
SELECT 
 coupon_id, get_last_1d_count, get_last_7d_count, get_last_30d_count, get_count, 
	order_last_1d_count, order_last_1d_reduce_amount, order_last_1d_original_amount, order_last_1d_final_amount,
	order_last_7d_count, order_last_7d_reduce_amount, order_last_7d_original_amount, order_last_7d_final_amount,
	order_last_30d_count, order_last_30d_reduce_amount, order_last_30d_original_amount, order_last_30d_final_amount,
	order_count, order_reduce_amount, order_original_amount, order_final_amount, payment_last_1d_count,
	payment_last_1d_reduce_amount, payment_last_1d_amount, payment_last_7d_count, payment_last_7d_reduce_amount,
	payment_last_7d_amount, payment_last_30d_count, payment_last_30d_reduce_amount, payment_last_30d_amount,
	payment_count, payment_reduce_amount, payment_amount, expire_last_1d_count, expire_last_7d_count,
	expire_last_30d_count, expire_count
from
(-- 商城截至到2021-05-07所有的优惠券
SELECT 
		coupon_id,
		sum(get_count) get_count,
	sum(order_count) order_count,
	sum(order_reduce_amount) order_reduce_amount,
	sum(order_original_amount) order_original_amount,
	sum(order_final_amount) order_final_amount,
	sum(payment_count) payment_count,
	sum(payment_reduce_amount) payment_reduce_amount,
	sum(payment_amount) payment_amount,
	sum(expire_count) expire_count,
	sum(if(dt='2021-05-07',get_count,0 )) get_last_1d_count,
	sum(if(dt='2021-05-07',order_count,0 )) order_last_1d_count,
	sum(if(dt='2021-05-07',order_reduce_amount,0 )) order_last_1d_reduce_amount,
	sum(if(dt='2021-05-07',order_original_amount,0 )) order_last_1d_original_amount,
	sum(if(dt='2021-05-07',order_final_amount,0 )) order_last_1d_final_amount,
	sum(if(dt='2021-05-07',payment_count,0 )) payment_last_1d_count,
	sum(if(dt='2021-05-07',payment_reduce_amount,0 )) payment_last_1d_reduce_amount,
	sum(if(dt='2021-05-07',payment_amount,0 )) payment_last_1d_amount,
	sum(if(dt='2021-05-07',expire_count,0 )) expire_last_1d_count,
	sum(if(dt>date_sub('2021-05-07',7),get_count,0 )) get_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),order_count,0 )) order_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),order_reduce_amount,0 )) order_last_7d_reduce_amount,
	sum(if(dt>date_sub('2021-05-07',7),order_original_amount,0 )) order_last_7d_original_amount,
	sum(if(dt>date_sub('2021-05-07',7),order_final_amount,0 )) order_last_7d_final_amount,
	sum(if(dt>date_sub('2021-05-07',7),payment_count,0 )) payment_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',7),payment_reduce_amount,0 )) payment_last_7d_reduce_amount,
	sum(if(dt>date_sub('2021-05-07',7),payment_amount,0 )) payment_last_7d_amount,
	sum(if(dt>date_sub('2021-05-07',7),expire_count,0 )) expire_last_7d_count,
	sum(if(dt>date_sub('2021-05-07',30),get_count,0 )) get_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),order_count,0 )) order_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),order_reduce_amount,0 )) order_last_30d_reduce_amount,
	sum(if(dt>date_sub('2021-05-07',30),order_original_amount,0 )) order_last_30d_original_amount,
	sum(if(dt>date_sub('2021-05-07',30),order_final_amount,0 )) order_last_30d_final_amount,
	sum(if(dt>date_sub('2021-05-07',30),payment_count,0 )) payment_last_30d_count,
	sum(if(dt>date_sub('2021-05-07',30),payment_reduce_amount,0 )) payment_last_30d_reduce_amount,
	sum(if(dt>date_sub('2021-05-07',30),payment_amount,0 )) payment_last_30d_amount,
	sum(if(dt>date_sub('2021-05-07',30),expire_count,0 )) expire_last_30d_count
from dws_coupon_info_daycount 
group by coupon_id  ) tmp
```



#### 5.2.2 每日导入

```sql
INSERT overwrite table dwt_coupon_topic partition(dt='2021-05-08')
SELECT 
		coupon_id, get_last_1d_count, get_last_7d_count, get_last_30d_count, get_count, 
	order_last_1d_count, order_last_1d_reduce_amount, order_last_1d_original_amount, order_last_1d_final_amount,
	order_last_7d_count, order_last_7d_reduce_amount, order_last_7d_original_amount, order_last_7d_final_amount,
	order_last_30d_count, order_last_30d_reduce_amount, order_last_30d_original_amount, order_last_30d_final_amount,
	order_count, order_reduce_amount, order_original_amount, order_final_amount, payment_last_1d_count,
	payment_last_1d_reduce_amount, payment_last_1d_amount, payment_last_7d_count, payment_last_7d_reduce_amount,
	payment_last_7d_amount, payment_last_30d_count, payment_last_30d_reduce_amount, payment_last_30d_amount,
	payment_count, payment_reduce_amount, payment_amount, expire_last_1d_count, expire_last_7d_count,
	expire_last_30d_count, expire_count
from
(SELECT 
			nvl(dws_data.coupon_id,dwt_data.coupon_id) coupon_id,
			nvl(dwt_data.get_count , 0 ) + nvl(dws_data.get_count , 0 ) get_count,
		nvl(dwt_data.order_count , 0 ) + nvl(dws_data.order_count , 0 ) order_count,
		nvl(dwt_data.order_reduce_amount , 0 ) + nvl(dws_data.order_reduce_amount , 0 ) order_reduce_amount,
		nvl(dwt_data.order_original_amount , 0 ) + nvl(dws_data.order_original_amount , 0 ) order_original_amount,
		nvl(dwt_data.order_final_amount , 0 ) + nvl(dws_data.order_final_amount , 0 ) order_final_amount,
		nvl(dwt_data.payment_count , 0 ) + nvl(dws_data.payment_count , 0 ) payment_count,
		nvl(dwt_data.payment_reduce_amount , 0 ) + nvl(dws_data.payment_reduce_amount , 0 ) payment_reduce_amount,
		nvl(dwt_data.payment_amount , 0 ) + nvl(dws_data.payment_amount , 0 ) payment_amount,
		nvl(dwt_data.expire_count , 0 ) + nvl(dws_data.expire_count , 0 ) expire_count,
		nvl(dws_data.get_count,0) get_last_1d_count,
		nvl(dws_data.order_count,0) order_last_1d_count,
		nvl(dws_data.order_reduce_amount,0) order_last_1d_reduce_amount,
		nvl(dws_data.order_original_amount,0) order_last_1d_original_amount,
		nvl(dws_data.order_final_amount,0) order_last_1d_final_amount,
		nvl(dws_data.payment_count,0) payment_last_1d_count,
		nvl(dws_data.payment_reduce_amount,0) payment_last_1d_reduce_amount,
		nvl(dws_data.payment_amount,0) payment_last_1d_amount,
		nvl(dws_data.expire_count,0) expire_last_1d_count,
		nvl(dwt_data.get_last_7d_count , 0 ) + nvl(dws_data.get_count,0) - nvl(dws_data_7daysago.get_count,0) get_last_7d_count,
nvl(dwt_data.order_last_7d_count , 0 ) + nvl(dws_data.order_count,0) - nvl(dws_data_7daysago.order_count,0) order_last_7d_count,
nvl(dwt_data.order_last_7d_reduce_amount , 0 ) + nvl(dws_data.order_reduce_amount,0) - nvl(dws_data_7daysago.order_reduce_amount,0) order_last_7d_reduce_amount,
nvl(dwt_data.order_last_7d_original_amount , 0 ) + nvl(dws_data.order_original_amount,0) - nvl(dws_data_7daysago.order_original_amount,0) order_last_7d_original_amount,
nvl(dwt_data.order_last_7d_final_amount , 0 ) + nvl(dws_data.order_final_amount,0) - nvl(dws_data_7daysago.order_final_amount,0) order_last_7d_final_amount,
nvl(dwt_data.payment_last_7d_count , 0 ) + nvl(dws_data.payment_count,0) - nvl(dws_data_7daysago.payment_count,0) payment_last_7d_count,
nvl(dwt_data.payment_last_7d_reduce_amount , 0 ) + nvl(dws_data.payment_reduce_amount,0) - nvl(dws_data_7daysago.payment_reduce_amount,0) payment_last_7d_reduce_amount,
nvl(dwt_data.payment_last_7d_amount , 0 ) + nvl(dws_data.payment_amount,0) - nvl(dws_data_7daysago.payment_amount,0) payment_last_7d_amount,
nvl(dwt_data.expire_last_7d_count , 0 ) + nvl(dws_data.expire_count,0) - nvl(dws_data_7daysago.expire_count,0) expire_last_7d_count,
nvl(dwt_data.get_last_30d_count , 0 ) + nvl(dws_data.get_count,0) - nvl(dws_data_30daysago.get_count,0) get_last_30d_count,
nvl(dwt_data.order_last_30d_count , 0 ) + nvl(dws_data.order_count,0) - nvl(dws_data_30daysago.order_count,0) order_last_30d_count,
nvl(dwt_data.order_last_30d_reduce_amount , 0 ) + nvl(dws_data.order_reduce_amount,0) - nvl(dws_data_30daysago.order_reduce_amount,0) order_last_30d_reduce_amount,
nvl(dwt_data.order_last_30d_original_amount , 0 ) + nvl(dws_data.order_original_amount,0) - nvl(dws_data_30daysago.order_original_amount,0) order_last_30d_original_amount,
nvl(dwt_data.order_last_30d_final_amount , 0 ) + nvl(dws_data.order_final_amount,0) - nvl(dws_data_30daysago.order_final_amount,0) order_last_30d_final_amount,
nvl(dwt_data.payment_last_30d_count , 0 ) + nvl(dws_data.payment_count,0) - nvl(dws_data_30daysago.payment_count,0) payment_last_30d_count,
nvl(dwt_data.payment_last_30d_reduce_amount , 0 ) + nvl(dws_data.payment_reduce_amount,0) - nvl(dws_data_30daysago.payment_reduce_amount,0) payment_last_30d_reduce_amount,
nvl(dwt_data.payment_last_30d_amount , 0 ) + nvl(dws_data.payment_amount,0) - nvl(dws_data_30daysago.payment_amount,0) payment_last_30d_amount,
nvl(dwt_data.expire_last_30d_count , 0 ) + nvl(dws_data.expire_count,0) - nvl(dws_data_30daysago.expire_count,0) expire_last_30d_count
from
(SELECT 
   *
from dwt_coupon_topic 
where dt=date_sub('2021-05-08',1)) dwt_data
full join
(select 
   * 
 from dws_coupon_info_daycount 
 where dt='2021-05-08' ) dws_data
 on dwt_data.coupon_id=dws_data.coupon_id
 left join
 (select 
   * 
 from dws_coupon_info_daycount 
 where dt=date_sub('2021-05-08',7) ) dws_data_7daysago
  on dwt_data.coupon_id=dws_data_7daysago.coupon_id
   left join
  (select 
   * 
 from dws_coupon_info_daycount 
 where dt=date_sub('2021-05-08',30) ) dws_data_30daysago
   on dwt_data.coupon_id=dws_data_30daysago.coupon_id ) tmp
```



## 6.dwt_activity_topic

### 6.1 建表

```sql
CREATE EXTERNAL TABLE dwt_activity_topic(
    `activity_rule_id` STRING COMMENT '活动规则ID',
    `activity_id` STRING  COMMENT '活动ID',
    `order_last_1d_count` BIGINT COMMENT '最近1日参与某活动某规则下单次数',
    `order_last_1d_reduce_amount` DECIMAL(16,2) COMMENT '最近1日参与某活动某规则下单优惠金额',
    `order_last_1d_original_amount` DECIMAL(16,2) COMMENT '最近1日参与某活动某规则下单原始金额',
    `order_last_1d_final_amount` DECIMAL(16,2) COMMENT '最近1日参与某活动某规则下单最终金额',
    `order_count` BIGINT COMMENT '参与某活动某规则累积下单次数',
    `order_reduce_amount` DECIMAL(16,2) COMMENT '参与某活动某规则累积下单优惠金额',
    `order_original_amount` DECIMAL(16,2) COMMENT '参与某活动某规则累积下单原始金额',
    `order_final_amount` DECIMAL(16,2) COMMENT '参与某活动某规则累积下单最终金额',
    `payment_last_1d_count` BIGINT COMMENT '最近1日参与某活动某规则支付次数',
    `payment_last_1d_reduce_amount` DECIMAL(16,2) COMMENT '最近1日参与某活动某规则支付优惠金额',
    `payment_last_1d_amount` DECIMAL(16,2) COMMENT '最近1日参与某活动某规则支付金额',
    `payment_count` BIGINT COMMENT '参与某活动某规则累积支付次数',
    `payment_reduce_amount` DECIMAL(16,2) COMMENT '参与某活动某规则累积支付优惠金额',
    `payment_amount` DECIMAL(16,2) COMMENT '参与某活动某规则累积支付金额'
) COMMENT '活动主题宽表'
```



### 6.2 导入数据

#### 6.2.1 首日导入

```sql
INSERT overwrite table dwt_activity_topic partition(dt='2021-05-07')
SELECT 
	activity_rule_id, activity_id, order_last_1d_count, order_last_1d_reduce_amount, order_last_1d_original_amount,
	order_last_1d_final_amount, order_count, order_reduce_amount, order_original_amount, 
	order_final_amount, payment_last_1d_count, payment_last_1d_reduce_amount, payment_last_1d_amount, 
	payment_count, payment_reduce_amount, payment_amount

from
(SELECT 
	activity_id ,activity_rule_id ,
	sum(order_count) order_count,
	sum(order_reduce_amount) order_reduce_amount,
	sum(order_original_amount) order_original_amount,
	sum(order_final_amount) order_final_amount,
	sum(payment_count) payment_count,
	sum(payment_reduce_amount) payment_reduce_amount,
	sum(payment_amount) payment_amount,
	sum(if(dt='2021-05-07',order_count,0)) order_last_1d_count,
	sum(if(dt='2021-05-07',order_reduce_amount,0)) order_last_1d_reduce_amount,
	sum(if(dt='2021-05-07',order_original_amount,0)) order_last_1d_original_amount,
	sum(if(dt='2021-05-07',order_final_amount,0)) order_last_1d_final_amount,
	sum(if(dt='2021-05-07',payment_count,0)) payment_last_1d_count,
	sum(if(dt='2021-05-07',payment_reduce_amount,0)) payment_last_1d_reduce_amount,
	sum(if(dt='2021-05-07',payment_amount,0)) payment_last_1d_amount
from dws_activity_info_daycount 
group by activity_id ,activity_rule_id ) tmp
```



#### 6.2.2 每日导入

```sql
INSERT overwrite table dwt_activity_topic partition(dt='2021-05-08')
SELECT 
   activity_rule_id, activity_id, order_last_1d_count, order_last_1d_reduce_amount,
order_last_1d_original_amount, order_last_1d_final_amount, order_count, order_reduce_amount,
order_original_amount, order_final_amount, payment_last_1d_count, payment_last_1d_reduce_amount,
payment_last_1d_amount, payment_count, payment_reduce_amount, payment_amount
from
(SELECT 
		nvl(dws_data.activity_rule_id,dwt_data.activity_rule_id) activity_rule_id,
		nvl(dws_data.activity_id,dwt_data.activity_id) activity_id,
		nvl(dwt_data.order_count,0) + nvl(dws_data.order_count,0) order_count,
nvl(dwt_data.order_reduce_amount,0) + nvl(dws_data.order_reduce_amount,0) order_reduce_amount,
nvl(dwt_data.order_original_amount,0) + nvl(dws_data.order_original_amount,0) order_original_amount,
nvl(dwt_data.order_final_amount,0) + nvl(dws_data.order_final_amount,0) order_final_amount,
nvl(dwt_data.payment_count,0) + nvl(dws_data.payment_count,0) payment_count,
nvl(dwt_data.payment_reduce_amount,0) + nvl(dws_data.payment_reduce_amount,0) payment_reduce_amount,
nvl(dwt_data.payment_amount,0) + nvl(dws_data.payment_amount,0) payment_amount,
nvl(dws_data.order_count,0) order_last_1d_count,
nvl(dws_data.order_reduce_amount,0) order_last_1d_reduce_amount,
nvl(dws_data.order_original_amount,0) order_last_1d_original_amount,
nvl(dws_data.order_final_amount,0) order_last_1d_final_amount,
nvl(dws_data.payment_count,0) payment_last_1d_count,
nvl(dws_data.payment_reduce_amount,0) payment_last_1d_reduce_amount,
nvl(dws_data.payment_amount,0) payment_last_1d_amount
from
(
	SELECT 
		*
	from dwt_activity_topic 
	where dt=date_sub('2021-05-08',1)
) dwt_data
full join
(SELECT 
  *
from dws_activity_info_daycount 
where dt='2021-05-08' ) dws_data
on dwt_data.activity_rule_id=dws_data.activity_rule_id
	and dwt_data.activity_id=dws_data.activity_id ) tmp
```





## 7.dwt_area_topic

dws: 每日统计的 是所有的省份

### 7.1建表

```sql
CREATE EXTERNAL TABLE dwt_area_topic(
    `province_id` STRING COMMENT '编号',
    `visit_last_1d_count` BIGINT COMMENT '最近1日访客访问次数',
    `login_last_1d_count` BIGINT COMMENT '最近1日用户访问次数',
    `visit_last_7d_count` BIGINT COMMENT '最近7访客访问次数',
    `login_last_7d_count` BIGINT COMMENT '最近7日用户访问次数',
    `visit_last_30d_count` BIGINT COMMENT '最近30日访客访问次数',
    `login_last_30d_count` BIGINT COMMENT '最近30日用户访问次数',
    `visit_count` BIGINT COMMENT '累积访客访问次数',
    `login_count` BIGINT COMMENT '累积用户访问次数',
    `order_last_1d_count` BIGINT COMMENT '最近1天下单次数',
    `order_last_1d_original_amount` DECIMAL(16,2) COMMENT '最近1天下单原始金额',
    `order_last_1d_final_amount` DECIMAL(16,2) COMMENT '最近1天下单最终金额',
    `order_last_7d_count` BIGINT COMMENT '最近7天下单次数',
    `order_last_7d_original_amount` DECIMAL(16,2) COMMENT '最近7天下单原始金额',
    `order_last_7d_final_amount` DECIMAL(16,2) COMMENT '最近7天下单最终金额',
    `order_last_30d_count` BIGINT COMMENT '最近30天下单次数',
    `order_last_30d_original_amount` DECIMAL(16,2) COMMENT '最近30天下单原始金额',
    `order_last_30d_final_amount` DECIMAL(16,2) COMMENT '最近30天下单最终金额',
    `order_count` BIGINT COMMENT '累积下单次数',
    `order_original_amount` DECIMAL(16,2) COMMENT '累积下单原始金额',
    `order_final_amount` DECIMAL(16,2) COMMENT '累积下单最终金额',
    `payment_last_1d_count` BIGINT COMMENT '最近1天支付次数',
    `payment_last_1d_amount` DECIMAL(16,2) COMMENT '最近1天支付金额',
    `payment_last_7d_count` BIGINT COMMENT '最近7天支付次数',
    `payment_last_7d_amount` DECIMAL(16,2) COMMENT '最近7天支付金额',
    `payment_last_30d_count` BIGINT COMMENT '最近30天支付次数',
    `payment_last_30d_amount` DECIMAL(16,2) COMMENT '最近30天支付金额',
    `payment_count` BIGINT COMMENT '累积支付次数',
    `payment_amount` DECIMAL(16,2) COMMENT '累积支付金额',
    `refund_order_last_1d_count` BIGINT COMMENT '最近1天退单次数',
    `refund_order_last_1d_amount` DECIMAL(16,2) COMMENT '最近1天退单金额',
    `refund_order_last_7d_count` BIGINT COMMENT '最近7天退单次数',
    `refund_order_last_7d_amount` DECIMAL(16,2) COMMENT '最近7天退单金额',
    `refund_order_last_30d_count` BIGINT COMMENT '最近30天退单次数',
    `refund_order_last_30d_amount` DECIMAL(16,2) COMMENT '最近30天退单金额',
    `refund_order_count` BIGINT COMMENT '累积退单次数',
    `refund_order_amount` DECIMAL(16,2) COMMENT '累积退单金额',
    `refund_payment_last_1d_count` BIGINT COMMENT '最近1天退款次数',
    `refund_payment_last_1d_amount` DECIMAL(16,2) COMMENT '最近1天退款金额',
    `refund_payment_last_7d_count` BIGINT COMMENT '最近7天退款次数',
    `refund_payment_last_7d_amount` DECIMAL(16,2) COMMENT '最近7天退款金额',
    `refund_payment_last_30d_count` BIGINT COMMENT '最近30天退款次数',
    `refund_payment_last_30d_amount` DECIMAL(16,2) COMMENT '最近30天退款金额',
    `refund_payment_count` BIGINT COMMENT '累积退款次数',
    `refund_payment_amount` DECIMAL(16,2) COMMENT '累积退款金额'
) COMMENT '地区主题宽表'
```



### 7.2 导入数据

#### 7.2.1 首日导入

```sql
INSERT overwrite table dwt_area_topic partition(dt='2021-05-07')
SELECT 
	province_id, visit_last_1d_count, login_last_1d_count, visit_last_7d_count, login_last_7d_count,
	visit_last_30d_count, login_last_30d_count, visit_count, login_count, order_last_1d_count, 
	order_last_1d_original_amount, order_last_1d_final_amount, order_last_7d_count, order_last_7d_original_amount,
	order_last_7d_final_amount, order_last_30d_count, order_last_30d_original_amount, order_last_30d_final_amount, 
	order_count, order_original_amount, order_final_amount, payment_last_1d_count, payment_last_1d_amount, 
	payment_last_7d_count, payment_last_7d_amount, payment_last_30d_count, payment_last_30d_amount,
	payment_count, payment_amount, refund_order_last_1d_count, refund_order_last_1d_amount, 
	refund_order_last_7d_count, refund_order_last_7d_amount, refund_order_last_30d_count,
	refund_order_last_30d_amount, refund_order_count, refund_order_amount, refund_payment_last_1d_count,
	refund_payment_last_1d_amount, refund_payment_last_7d_count, refund_payment_last_7d_amount,
	refund_payment_last_30d_count, refund_payment_last_30d_amount, refund_payment_count,
	refund_payment_amount
from
(SELECT 
	province_id,
	 sum(visit_count) visit_count,
sum(login_count) login_count,
sum(order_count) order_count,
sum(order_original_amount) order_original_amount,
sum(order_final_amount) order_final_amount,
sum(payment_count) payment_count,
sum(payment_amount) payment_amount,
sum(refund_order_count) refund_order_count,
sum(refund_order_amount) refund_order_amount,
sum(refund_payment_count) refund_payment_count,
sum(refund_payment_amount) refund_payment_amount,
sum(if(dt='2021-05-07',visit_count,0)) visit_last_1d_count,
sum(if(dt='2021-05-07',login_count,0)) login_last_1d_count,
sum(if(dt='2021-05-07',order_count,0)) order_last_1d_count,
sum(if(dt='2021-05-07',order_original_amount,0)) order_last_1d_original_amount,
sum(if(dt='2021-05-07',order_final_amount,0)) order_last_1d_final_amount,
sum(if(dt='2021-05-07',payment_count,0)) payment_last_1d_count,
sum(if(dt='2021-05-07',payment_amount,0)) payment_last_1d_amount,
sum(if(dt='2021-05-07',refund_order_count,0)) refund_order_last_1d_count,
sum(if(dt='2021-05-07',refund_order_amount,0)) refund_order_last_1d_amount,
sum(if(dt='2021-05-07',refund_payment_count,0)) refund_payment_last_1d_count,
sum(if(dt='2021-05-07',refund_payment_amount,0)) refund_payment_last_1d_amount,
sum(if(dt>date_sub('2021-05-07',7),visit_count,0)) visit_last_7d_count,
sum(if(dt>date_sub('2021-05-07',7),login_count,0)) login_last_7d_count,
sum(if(dt>date_sub('2021-05-07',7),order_count,0)) order_last_7d_count,
sum(if(dt>date_sub('2021-05-07',7),order_original_amount,0)) order_last_7d_original_amount,
sum(if(dt>date_sub('2021-05-07',7),order_final_amount,0)) order_last_7d_final_amount,
sum(if(dt>date_sub('2021-05-07',7),payment_count,0)) payment_last_7d_count,
sum(if(dt>date_sub('2021-05-07',7),payment_amount,0)) payment_last_7d_amount,
sum(if(dt>date_sub('2021-05-07',7),refund_order_count,0)) refund_order_last_7d_count,
sum(if(dt>date_sub('2021-05-07',7),refund_order_amount,0)) refund_order_last_7d_amount,
sum(if(dt>date_sub('2021-05-07',7),refund_payment_count,0)) refund_payment_last_7d_count,
sum(if(dt>date_sub('2021-05-07',7),refund_payment_amount,0)) refund_payment_last_7d_amount,
sum(if(dt>date_sub('2021-05-07',30),visit_count,0)) visit_last_30d_count,
sum(if(dt>date_sub('2021-05-07',30),login_count,0)) login_last_30d_count,
sum(if(dt>date_sub('2021-05-07',30),order_count,0)) order_last_30d_count,
sum(if(dt>date_sub('2021-05-07',30),order_original_amount,0)) order_last_30d_original_amount,
sum(if(dt>date_sub('2021-05-07',30),order_final_amount,0)) order_last_30d_final_amount,
sum(if(dt>date_sub('2021-05-07',30),payment_count,0)) payment_last_30d_count,
sum(if(dt>date_sub('2021-05-07',30),payment_amount,0)) payment_last_30d_amount,
sum(if(dt>date_sub('2021-05-07',30),refund_order_count,0)) refund_order_last_30d_count,
sum(if(dt>date_sub('2021-05-07',30),refund_order_amount,0)) refund_order_last_30d_amount,
sum(if(dt>date_sub('2021-05-07',30),refund_payment_count,0)) refund_payment_last_30d_count,
sum(if(dt>date_sub('2021-05-07',30),refund_payment_amount,0)) refund_payment_last_30d_amount

from dws_area_stats_daycount 
group by province_id  ) tmp
```



#### 7.2.2 每日导入

```sql
INSERT overwrite table dwt_area_topic partition(dt='2021-05-08')
SELECT 
	province_id, visit_last_1d_count, login_last_1d_count, visit_last_7d_count, login_last_7d_count,
	visit_last_30d_count, login_last_30d_count, visit_count, login_count, order_last_1d_count, 
	order_last_1d_original_amount, order_last_1d_final_amount, order_last_7d_count, order_last_7d_original_amount,
	order_last_7d_final_amount, order_last_30d_count, order_last_30d_original_amount, order_last_30d_final_amount, 
	order_count, order_original_amount, order_final_amount, payment_last_1d_count, payment_last_1d_amount, 
	payment_last_7d_count, payment_last_7d_amount, payment_last_30d_count, payment_last_30d_amount,
	payment_count, payment_amount, refund_order_last_1d_count, refund_order_last_1d_amount, 
	refund_order_last_7d_count, refund_order_last_7d_amount, refund_order_last_30d_count,
	refund_order_last_30d_amount, refund_order_count, refund_order_amount, refund_payment_last_1d_count,
	refund_payment_last_1d_amount, refund_payment_last_7d_count, refund_payment_last_7d_amount,
	refund_payment_last_30d_count, refund_payment_last_30d_amount, refund_payment_count,
	refund_payment_amount
	from
(SELECT 
		dwt_data.province_id,
		--最近1天
		    dws_data.visit_count visit_last_1d_count,
		dws_data.login_count login_last_1d_count,
		dws_data.order_count order_last_1d_count,
		dws_data.order_original_amount order_last_1d_original_amount,
		dws_data.order_final_amount order_last_1d_final_amount,
		dws_data.payment_count payment_last_1d_count,
		dws_data.payment_amount payment_last_1d_amount,
		dws_data.refund_order_count refund_order_last_1d_count,
		dws_data.refund_order_amount refund_order_last_1d_amount,
		dws_data.refund_payment_count refund_payment_last_1d_count,
		dws_data.refund_payment_amount refund_payment_last_1d_amount,
		dwt_data.visit_count+ dws_data.visit_count visit_count,
		dwt_data.login_count+ dws_data.login_count login_count,
		dwt_data.order_count+ dws_data.order_count order_count,
		dwt_data.order_original_amount+ dws_data.order_original_amount order_original_amount,
		dwt_data.order_final_amount+ dws_data.order_final_amount order_final_amount,
		dwt_data.payment_count+ dws_data.payment_count payment_count,
		dwt_data.payment_amount+ dws_data.payment_amount payment_amount,
		dwt_data.refund_order_count+ dws_data.refund_order_count refund_order_count,
		dwt_data.refund_order_amount+ dws_data.refund_order_amount refund_order_amount,
		dwt_data.refund_payment_count+ dws_data.refund_payment_count refund_payment_count,
		dwt_data.refund_payment_amount+ dws_data.refund_payment_amount refund_payment_amount,
dwt_data.visit_last_7d_count+ dws_data.visit_count - dws_data_7daysago.visit_count visit_last_7d_count,
dwt_data.login_last_7d_count+ dws_data.login_count - dws_data_7daysago.login_count login_last_7d_count,
dwt_data.order_last_7d_count+ dws_data.order_count - dws_data_7daysago.order_count order_last_7d_count,
dwt_data.order_last_7d_original_amount+ dws_data.order_original_amount - dws_data_7daysago.order_original_amount order_last_7d_original_amount,
dwt_data.order_last_7d_final_amount+ dws_data.order_final_amount - dws_data_7daysago.order_final_amount order_last_7d_final_amount,
dwt_data.payment_last_7d_count+ dws_data.payment_count - dws_data_7daysago.payment_count payment_last_7d_count,
dwt_data.payment_last_7d_amount+ dws_data.payment_amount - dws_data_7daysago.payment_amount payment_last_7d_amount,
dwt_data.refund_order_last_7d_count+ dws_data.refund_order_count - dws_data_7daysago.refund_order_count refund_order_last_7d_count,
dwt_data.refund_order_last_7d_amount+ dws_data.refund_order_amount - dws_data_7daysago.refund_order_amount refund_order_last_7d_amount,
dwt_data.refund_payment_last_7d_count+ dws_data.refund_payment_count - dws_data_7daysago.refund_payment_count refund_payment_last_7d_count,
dwt_data.refund_payment_last_7d_amount+ dws_data.refund_payment_amount - dws_data_7daysago.refund_payment_amount refund_payment_last_7d_amount,
dwt_data.visit_last_30d_count+ dws_data.visit_count - dws_data_30daysago.visit_count visit_last_30d_count,
dwt_data.login_last_30d_count+ dws_data.login_count - dws_data_30daysago.login_count login_last_30d_count,
dwt_data.order_last_30d_count+ dws_data.order_count - dws_data_30daysago.order_count order_last_30d_count,
dwt_data.order_last_30d_original_amount+ dws_data.order_original_amount - dws_data_30daysago.order_original_amount order_last_30d_original_amount,
dwt_data.order_last_30d_final_amount+ dws_data.order_final_amount - dws_data_30daysago.order_final_amount order_last_30d_final_amount,
dwt_data.payment_last_30d_count+ dws_data.payment_count - dws_data_30daysago.payment_count payment_last_30d_count,
dwt_data.payment_last_30d_amount+ dws_data.payment_amount - dws_data_30daysago.payment_amount payment_last_30d_amount,
dwt_data.refund_order_last_30d_count+ dws_data.refund_order_count - dws_data_30daysago.refund_order_count refund_order_last_30d_count,
dwt_data.refund_order_last_30d_amount+ dws_data.refund_order_amount - dws_data_30daysago.refund_order_amount refund_order_last_30d_amount,
dwt_data.refund_payment_last_30d_count+ dws_data.refund_payment_count - dws_data_30daysago.refund_payment_count refund_payment_last_30d_count,
dwt_data.refund_payment_last_30d_amount+ dws_data.refund_payment_amount - dws_data_30daysago.refund_payment_amount refund_payment_last_30d_amount
FROM 
(select 
   * 
 from dwt_area_topic 
 where dt=date_sub('2021-05-08',1) ) dwt_data
 left join
 (select 
   * 
 from dws_area_stats_daycount 
 where dt='2021-05-08' ) dws_data
 on dwt_data.province_id=dws_data.province_id
  left join
 (select 
   * 
 from dws_area_stats_daycount 
 where dt=date_sub('2021-05-08',7) ) dws_data_7daysago
 on dwt_data.province_id=dws_data_7daysago.province_id
   left join
 (select 
   * 
 from dws_area_stats_daycount 
 where dt=date_sub('2021-05-08',30) ) dws_data_30daysago
 on dwt_data.province_id=dws_data_30daysago.province_id ) tmp
```



# 六、ADS层

## 1.整体思路

### 1.1 思路分析

ads层为应用程序提供最终统计结果。

从dwt /  dws层查询，如果建模完美的话，直接从dwt/dws查到需要的数据，如果建模有瑕疵，只能从dwd层查询。



ads层每天统计后，数据只有若干行，数据量小，不需要做成分区表；

ads层直接使用textfile存储，指定使用\t作为字段的分隔符，这样设计的好处时，ads统计的结果就是一个TSV文件，可以直接将文件从hdfs下载下来，直接导入到BI工具中。

ads层在建表时，一般是一个需求一张表，也可以将多个同类性质的需求合并到一张表中。

ads层在导入数据时，需要紧密贴合业务。

​				ods： load，不做任何处理

​                dim:   降维，将多张维度表合并到1张维度表

​				dwd：  展开明细，将ods_log line，拆分为 10几列

​							将事实按照类型，事务型，累积型快照，周期型快照，进行导入

​				dws|dwt : 聚合

​				ads： 明确业务需求，根据业务需求进行sql的编写。

ads层一般需要使用一些复杂(窗口)的函数来进行计算。跨行计算，只能使用窗口函数！

如果要取当天的数据，可以从dws | dwd 考虑，优先选择数据量小的，如果取累积的数据，优先从dwt层取，如果取某个历史范围的数据，可以从dws层取



CSV(使用逗号分割字段的文件) | TSV（使用tab分割字段的文件）	



### 1.2 窗口函数

https://cwiki.apache.org/confluence/display/Hive/LanguageManual+WindowingAndAnalytics



窗口(函数计算的范围) + 函数：   特定的函数，可以窗口自动调节计算的范围。



语法：   函数()  over(partition by  分组 order by 排序   window子句(定义函数运行的范围)  )

​				window子句语法： 

```
(ROWS | RANGE) BETWEEN (UNBOUNDED | [num]) PRECEDING AND ([num] PRECEDING | CURRENT ROW | (UNBOUNDED | [num]) FOLLOWING)
```



窗口函数：

​		①标准的统计聚合类的函数： MAX,MIN,SUM,AVG,COUNT

​        ②特定的函数： 

​						LEAD： 取窗口中指定列的后N列的值

​						LAG：   取窗口中指定列的前N列的值

​						FIRST_VALUE：  传入两个参数，第一个是想取某列的第一个值的列名，第二个参数默认为false，如果为true，代表自动跳过NULL值

​						LAST_VALUE：  传入两个参数，第一个是想取某列的最后一个值的列名，第二个参数默认为false，如果为true，代表自动跳过NULL值

​		  ③排名类函数： RANK, ROW_NUMBER之类的



注意事项：①Ranking functions: Rank, NTile, DenseRank, CumeDist, PercentRank.

Lead and Lag functions.,支持写over()，不支持over()中套window子句

​					②over()中写了order by ，但是没声明window子句，默认window的范围是RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW.

​					③over()中既没写 order by，也没写window子句，默认window的范围是ROW BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING.



窗口函数和group by 区别：

​				假设结果集合有N行，group by后有M个组。

​				使用窗口函数计算，计算的结果集还是N行，

​				如果使用group by 计算，计算的结果集是M行

## 2.ads_visit_stats

和访客相关：  dwd_xxx_log

​						dws_visitor_action_daycount

​						dwt_visitor_topic





dwd_page_log 

### 2.1 建表

```sql
CREATE EXTERNAL TABLE ads_visit_stats (
    -- 统计的数据的日期
  `dt` STRING COMMENT '统计日期',
  `is_new` STRING COMMENT '新老标识,1:新,0:老',
  `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
  `channel` STRING COMMENT '渠道',
  `uv_count` BIGINT COMMENT '日活(访问人数)',
  `duration_sec` BIGINT COMMENT '页面停留总时长',
  `avg_duration_sec` BIGINT COMMENT '一次会话，页面停留平均时长,单位为描述',
  `page_count` BIGINT COMMENT '页面总浏览数',
  `avg_page_count` BIGINT COMMENT '一次会话，页面平均浏览数',
  `sv_count` BIGINT COMMENT '会话次数',
  `bounce_count` BIGINT COMMENT '跳出数',
  `bounce_rate` DECIMAL(16,2) COMMENT '跳出率'
) COMMENT '访客统计'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
LOCATION '/warehouse/gmall/ads/ads_visit_stats/';
```

会话(session)：   客户端和电商App服务端建立一次会话后，可以发送N次请求，获取到电商App服务端处理请求的响应。

​								mid_1 , 在 2021-05-10 10:0:0 建立了一次会话，建议之后，产生了如下行为：

​										a) 访问了首页

​										b) 从首页进入了 某个商品的详情页

​										c) 执行了加入购物车

​										d)  下单，支付....



跳出数:  指仅有一次访问行为的会话的数量

跳出率：  跳出数 /  会话总数  * 100 



目的： 在某天的统计数据中统计，不同的渠道，新老用户，在1天，7天，30天内，的各项指标

| 渠道   | 新老用户 | recent_days | 跳出数 | 跳出率 |
| ------ | -------- | ----------- | ------ | ------ |
| MI商店 | 0        | 1           | 10     | 50     |
| MI商店 | 1        | 1           | 5      | 30     |
| OPPO   | 0        | 1           | 10     | 50     |
| MI商店 | 0        | 7           | 20     | 100    |
| MI商店 | 0        | 30          | 30     | 100    |



核心是从数据中，获取sessionid，通过sessionid来进行判断。



| mid_id | ts   | last_page_id | page_id     | start_session_ts | session_id |
| ------ | ---- | ------------ | ----------- | ---------------- | ---------- |
| mid_1  | 101  | null         | home        | 101              | mid_1-101  |
| mid_1  | 102  | home         | good_detail | null             | mid_1-101  |
| mid_1  | 103  | good_detail  | cart        | null             | mid_1-101  |
| mid_1  | 110  | null         | home        | 110              | mid_1-110  |
| mid_1  | 111  | home         | good_list   | null             | mid_1-110  |
|        |      |              |             |                  |            |



### 2.2 导入数据

方式一：

```sql
SELECT 
		'2021-05-07',
		 is_new,
		1 recent_days,
		channel,
		count(DISTINCT split(session_id,'-')[0]) uv_count,
		sum(during_time_per_session) / 1000 duration_sec,
		avg(during_time_per_session) / 1000 avg_duration_sec,
		sum(page_count_per_session) page_count,
		avg(page_count_per_session)   avg_page_count,
		count(*) sv_count,
		sum(if(page_count_per_session=1,1,0)) bounce_count,
		cast(sum(if(page_count_per_session=1,1,0)) / count(*)  * 100 as DECIMAL(16,2)) bounce_rate
		
from
(SELECT 
	session_id,channel ,is_new ,
		--求出每个渠道，每个new 或 old中，每个sessionid访问的 总流量时长，和 页面数量
		sum(during_time) during_time_per_session,
		count(*) page_count_per_session
from
(SELECT 
	 mid_id , channel ,is_new ,during_time ,
	 concat(mid_id ,'-',last_value(session_start_ts,true) over(PARTITION by mid_id order by ts))  session_id
from
(-- sessionid: 用来标识唯一的一次会话的id      mid_id-ts
SELECT 
   mid_id , ts ,channel ,is_new ,during_time ,
   --区分哪些页面的访问是一次会话的开始, 记录会话开始的ts
   if(last_page_id is null, ts , null) session_start_ts
   
from dwd_page_log 
where dt='2021-05-07' ) t1  
   )t2
   GROUP  by session_id,channel ,is_new ) t3
   GROUP  by channel ,is_new
   union all
   SELECT 
		'2021-05-07',
		 is_new,
		7 recent_days,
		channel,
		count(DISTINCT split(session_id,'-')[0]) uv_count,
		sum(during_time_per_session) / 1000 duration_sec,
		avg(during_time_per_session) / 1000 avg_duration_sec,
		sum(page_count_per_session) page_count,
		avg(page_count_per_session)   avg_page_count,
		count(*) sv_count,
		sum(if(page_count_per_session=1,1,0)) bounce_count,
		cast(sum(if(page_count_per_session=1,1,0)) / count(*)  * 100 as DECIMAL(16,2)) bounce_rate
		
from
(SELECT 
	session_id,channel ,is_new ,
		--求出每个渠道，每个new 或 old中，每个sessionid访问的 总流量时长，和 页面数量
		sum(during_time) during_time_per_session,
		count(*) page_count_per_session
from
(SELECT 
	 mid_id , channel ,is_new ,during_time ,
	 concat(mid_id ,'-',last_value(session_start_ts,true) over(PARTITION by mid_id order by ts))  session_id
from
(-- sessionid: 用来标识唯一的一次会话的id      mid_id-ts
SELECT 
   mid_id , ts ,channel ,is_new ,during_time ,
   --区分哪些页面的访问是一次会话的开始, 记录会话开始的ts
   if(last_page_id is null, ts , null) session_start_ts
   
from dwd_page_log 
where dt > date_sub('2021-05-07',7) ) t1  
   )t2
   GROUP  by session_id,channel ,is_new ) t3
   GROUP  by channel ,is_new
   union all
   SELECT 
		'2021-05-07',
		 is_new,
		30 recent_days,
		channel,
		count(DISTINCT split(session_id,'-')[0]) uv_count,
		sum(during_time_per_session) / 1000 duration_sec,
		avg(during_time_per_session) / 1000 avg_duration_sec,
		sum(page_count_per_session) page_count,
		avg(page_count_per_session)   avg_page_count,
		count(*) sv_count,
		sum(if(page_count_per_session=1,1,0)) bounce_count,
		cast(sum(if(page_count_per_session=1,1,0)) / count(*)  * 100 as DECIMAL(16,2)) bounce_rate
		
from
(SELECT 
	session_id,channel ,is_new ,
		--求出每个渠道，每个new 或 old中，每个sessionid访问的 总流量时长，和 页面数量
		sum(during_time) during_time_per_session,
		count(*) page_count_per_session
from
(SELECT 
	 mid_id , channel ,is_new ,during_time ,
	 concat(mid_id ,'-',last_value(session_start_ts,true) over(PARTITION by mid_id order by ts))  session_id
from
(-- sessionid: 用来标识唯一的一次会话的id      mid_id-ts
SELECT 
   mid_id , ts ,channel ,is_new ,during_time ,
   --区分哪些页面的访问是一次会话的开始, 记录会话开始的ts
   if(last_page_id is null, ts , null) session_start_ts
   
from dwd_page_log 
where dt > date_sub('2021-05-07',30) ) t1  
   )t2
   GROUP  by session_id,channel ,is_new ) t3
   GROUP  by channel ,is_new
```



方式二：

```sql
insert overwrite table ads_visit_stats
--查询当前表中已经有的数据
select * from ads_visit_stats 
union all
select 
        '2021-05-07',
		 is_new,
		 recent_days,
		channel,
		count(DISTINCT split(session_id,'-')[0]) uv_count,
		sum(during_time_per_session) / 1000 duration_sec,
		avg(during_time_per_session) / 1000 avg_duration_sec,
		sum(page_count_per_session) page_count,
		avg(page_count_per_session)   avg_page_count,
		count(*) sv_count,
		sum(if(page_count_per_session=1,1,0)) bounce_count,
		cast(sum(if(page_count_per_session=1,1,0)) / count(*)  * 100 as DECIMAL(16,2)) bounce_rate
from
(select 
		session_id,channel ,is_new ,recent_days,
		--求出每个渠道，每个new 或 old中，每个sessionid访问的 总流量时长，和 页面数量
		sum(during_time) during_time_per_session,
		count(*) page_count_per_session

from
(select
	mid_id , channel ,is_new ,during_time ,recent_days,
	 concat(mid_id ,'-',last_value(session_start_ts,true) over(PARTITION by mid_id,recent_days order by ts))  session_id
from
(SELECT 
   mid_id ,ts,channel ,is_new ,during_time ,recent_days,dt,
   if(last_page_id is null, ts , null) session_start_ts
from dwd_page_log 
lateral view explode(array(1,7,30)) t2 as recent_days
where dt > date_sub('2021-05-07',30) 
	and dt > date_sub('2021-05-07',recent_days)  ) t3 
	)  t4
	GROUP  by channel ,is_new ,recent_days,session_id  ) t5
	GROUP  by channel ,is_new ,recent_days

```



## 3.ads_page_path

### 3.1 建表

````sql
CREATE EXTERNAL TABLE ads_page_path
(
    `dt` STRING COMMENT '统计日期',
    `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    `source` STRING COMMENT '跳转起始页面ID',
    `target` STRING COMMENT '跳转终到页面ID',
    `path_count` BIGINT COMMENT '跳转次数'
)  COMMENT '页面浏览路径'
````

路径分析，为了制作桑基(sanki)图

示例：

https://www.sensorsdata.cn/blog/20180511/



桑基图理论：

①由起点 source ，终点target组成

②source不能为null，target可以为null

③符合DAG(有向无环图)



数据源： ①dwd_page_log（简单）

​                ②dws_visitor_action_daycount   page_status



| mid_id | ts   | last_page_id | page_id     | source      | sp   | target      | tp   | recent_days | session_id |
| ------ | ---- | ------------ | ----------- | ----------- | ---- | ----------- | ---- | ----------- | ---------- |
| mid_1  | 101  | null         | home        | home        | 1    | good_detail | 2    | 1           | mid_1-101  |
| mid_1  | 102  | home         | good_detail | good_detail | 2    | cart        | 3    | 1           | mid_1-101  |
| mid_1  | 103  | good_detail  | cart        | cart        | 3    | null        | 4    | 1           | mid_1-101  |
| mid_1  | 110  | null         | home        | home        | 1    | good_list   | 2    | 1           | mid_1-110  |
| mid_1  | 111  | home         | good_list   | good_list   | 2    | null        | 3    | 1           | mid_1-110  |
|        |      |              |             |             |      |             |      |             |            |

source:  page_id

target: 取同一个session中，page_id这列当前行下一列的值

​				借助 lead

​					lead(page_id,1,null)

### 3.2 导入数据

```sql
insert overwrite table ads_page_path
--查询当前表中已经有的数据
select * from ads_page_path
union all
--今天计算的统计结果
SELECT 
	'2021-05-07',
   recent_days,source,target,
   count(*)
from
(SELECT 
   recent_days,
   concat('step-',rn,':',source) source,
   concat('step-',rn+1,':',target) target
from
(SELECT 
	  mid_id ,recent_days,
	  page_id source ,
	  lead(page_id,1,null) over(PARTITION by session_id,recent_days order by ts ) target,
	  ROW_NUMBER() over(PARTITION by session_id,recent_days order by ts )  rn,
	 session_id
from
(SELECT 
   mid_id ,last_page_id, page_id,recent_days, ts,
   --求session_id，目的是为了绘制一次会话中的页面访问路径
	 concat(mid_id ,'-',last_value(session_start_ts,true) over(PARTITION by mid_id,recent_days order by ts))  session_id
from
(SELECT 
   mid_id ,ts,last_page_id, page_id , recent_days,
   if(last_page_id is null, ts , null) session_start_ts
from dwd_page_log 
lateral view explode(array(1,7,30)) tmp as recent_days
where dt > date_sub('2021-05-07',30) 
	and dt > date_sub('2021-05-07',recent_days)  ) t1  ) t2  ) t3 ) t4
	GROUP  by recent_days,source,target
```



## 4.ads_user_total

### 4.1 建表

```sql
CREATE EXTERNAL TABLE `ads_user_total` (
  `dt` STRING COMMENT '统计日期',
  `recent_days` BIGINT COMMENT '最近天数,0:累积值,1:最近1天,7:最近7天,30:最近30天',
  `new_user_count` BIGINT COMMENT '新注册并登录用户数',
  `new_order_user_count` BIGINT COMMENT '新增下单用户数',
  `order_final_amount` DECIMAL(16,2) COMMENT '下单总金额',
  `order_user_count` BIGINT COMMENT '下单用户数',
  `no_order_user_count` BIGINT COMMENT '未下单用户数(具体指活跃用户中未下单用户)'
) COMMENT '用户统计'
```



从dwt_user_topic取数据



new_user_count：

最近0天(累积) new_user_count：    sum(if(login_date_first  >  date_sub('2021-05-07', x ) 1, 0))

​			如果 recent_days=0， x= 60000 ,否则 x=recent_days

最近1天：    sum(if(login_date_first >date_sub( '2021-05-07',1)  1, 0))

最近7天：    sum(if(login_date_first > date_sub( '2021-05-07',7) 1, 0))

最近30天：    sum(if(login_date_first > date_sub( '2021-05-07',30) 1, 0))

​			公式：  sum(if(login_date_first > date_sub( '2021-05-07',x) 1, 0))



new_order_user_count：

   最近0天(累积) ：   sum(if(order_date_first>date_sub( '2021-05-07',x)  1, 0))

​		如果 recent_days=0， x= 60000 ,否则 x=recent_days

最近1天：  sum(if(order_date_first>date_sub( '2021-05-07',1)  1, 0))

最近7天：  sum(if(order_date_first>date_sub( '2021-05-07',7)  1, 0))

最近30天：  sum(if(order_date_first>date_sub( '2021-05-07',30)  1, 0))



order_final_amount：

 最近0天(累积) ：  sum(order_final_amount)

最近1天：  sum(order_last_1d_final_amount)

最近7天：  sum(order_last_7d_final_amount)

最近30天：  sum(order_last_30d_final_amount)



order_user_count 参考order_final_amount判断



no_order_user_count：(只活跃不下单)

最近0天(累积) :     login_date_last  > date_sub('2021-05-07',x)  and  order_final_amoun=0

最近1天：   login_date_last >date_sub( '2021-05-07',1)  and   order_last_1d_final_amount=0

最近7天：   login_date_last >date_sub( '2021-05-07',7)  and  order_last_7d_final_amount=0

最近1\30天：   login_date_last >date_sub( '2021-05-07',30)  and  order_last_30d_final_amount=0





### 4.2 导入数据

```
INSERT overwrite table ads_user_total 
select * from ads_user_total 
union all
SELECT 
		'2021-05-07' ,
		recent_days ,
		 sum(if(login_date_first > date_sub( '2021-05-07',x) ,1, 0)) new_user_count,
		 sum(if(order_date_first > date_sub( '2021-05-07',x) ,1, 0)) new_order_user_count,
		 sum(order_final_amount) order_final_amount,
		 sum(if(order_final_amount > 0 ,1,0)) order_user_count,
		 sum(if( login_date_last  > date_sub('2021-05-07',x) and order_final_amount=0 ,1,0)) no_order_user_count
from
(SELECT 
      recent_days,
      user_id ,
      login_date_first  ,
      order_date_first,
      case recent_days
      	when  0 then order_final_amount
      	when  1 then order_last_1d_final_amount
      	when  7 then order_last_7d_final_amount
      	when  30 then order_last_30d_final_amount
      	end order_final_amount,
      	login_date_last ,
      	if(recent_days = 0 , 6000 , recent_days) x
from dwt_user_topic 
lateral view explode(array(0,1,7,30)) tmp as recent_days
where dt='2021-05-07' )  t1
GROUP by recent_days
```



## 5.ads_user_change

### 5.1 建表

```sql
DROP TABLE IF EXISTS ads_user_change;
CREATE EXTERNAL TABLE `ads_user_change` (
  `dt` STRING COMMENT '统计日期',
  `user_churn_count` BIGINT COMMENT '流失用户数',
  `user_back_count` BIGINT COMMENT '回流用户数'
) COMMENT '用户变动统计'
ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
LOCATION '/warehouse/gmall/ads/ads_user_change/';
```

数据源： dwt_user_topic

流失用户数:   最近7天未活跃的用户

​						 最后一次后跃的时间，距离现在已经7天。

​						login_date_last <= date_sub('2021-05-07',)

回流用户数： 上周未活跃，本周活跃的用户，且不是本周新增用户

​							换句话讲： 取上周未活跃，本周活跃的老用户



​						①求本周活跃的老用户

​								本周后跃的用户： 	login_date_last  >= 本周一

​									老用户：   and   login_date_first <  本周一

​						②上周未活跃

​									 使用本周活跃的老用户  A   left  join  上周活跃的老用户   B

​										on A.user_id = B.user_id

​									where   B.user_id is null

​						

### 5.2 导入数据

```
INSERT overwrite table ads_user_change 
select * from ads_user_change 
union all
SELECT
	'2021-05-07',
	user_churn_count,
	user_back_count
from
(SELECT 
   count(*) user_churn_count
from dwt_user_topic 
where dt='2021-05-07'
and login_date_last <= date_sub('2021-05-07',7)) t3
join
(select
	count(*) user_back_count
from
(SELECT 
   user_id 
from dwt_user_topic 
where dt='2021-05-07'
and login_date_last >= date_sub(next_day('2021-05-07','MO'),7)
and login_date_first  < date_sub(next_day('2021-05-07','MO'),7) ) t1
left join
-- 上周活跃的老用户
(
	select
		user_id
	from dws_user_action_daycount 
	where dt BETWEEN  date_sub(next_day('2021-05-07','MO'),14)
	and date_sub(next_day('2021-05-07','MO'),8)
	GROUP by user_id 

) t2
on t1.user_id = t2.user_id
where t2.user_id is null  ) t4
```



## 6.ads_user_action

### 6.1 建表

dwt_user_topic

```sql
DROP TABLE IF EXISTS ads_user_action;
CREATE EXTERNAL TABLE `ads_user_action` (
  `dt` STRING COMMENT '统计日期',
  `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    --dwd_page_log    侧写后，需要过滤
  `home_count` BIGINT COMMENT '浏览首页人数',
  `good_detail_count` BIGINT COMMENT '浏览商品详情页人数',
    --dwt_user_topic   侧写后，无需过滤
  `cart_count` BIGINT COMMENT '加入购物车人数',
  `order_count` BIGINT COMMENT '下单人数',
  `payment_count` BIGINT COMMENT '支付人数'
) COMMENT '漏斗分析'
ROW FORMAT DELIMITED  FIELDS TERMINATED BY '\t'
LOCATION '/warehouse/gmall/ads/ads_user_action/';
```



### 6.2 导入数据

```sql
INSERT overwrite table ads_user_action 
select * from ads_user_action 
union 
SELECT 
  		'2021-05-07',
  		t3.recent_days,
  		home_count,
  		good_detail_count,
  		cart_count,
  		order_count,
  		payment_count
  		
  from
  (SELECT 
  	recent_days,
  	sum(if(cart_count > 0 ,1,0)) cart_count,
  	sum(if(order_count > 0, 1,0)) order_count,
  	sum(if(payment_count > 0,1,0)) payment_count
  from
  (SELECT 
     	recent_days,
     	case recent_days
     		when 1 then cart_last_1d_count
     		when 7 then cart_last_7d_count
     		when 30 then cart_last_30d_count
     	end cart_count,
     	case recent_days
     		when 1 then order_last_1d_count
     		when 7 then order_last_7d_count
     		when 30 then order_last_30d_count
     	end order_count,
     	case recent_days
     		when 1 then payment_last_1d_count
     		when 7 then payment_last_7d_count
     		when 30 then payment_last_30d_count
     	end payment_count
  from dwt_user_topic 
  lateral view explode(array(1,7,30)) tmp as recent_days
  where dt='2021-05-07'  ) t2
  GROUP by recent_days  ) t3
  join
  (SELECT 
      recent_days,
      sum(if(page_id ='home',1,0))  home_count,
      sum(if(page_id ='good_detail',1,0))  good_detail_count
  from
  (SELECT 
       --分组是为去重求人数
  		recent_days,
  		user_id , 
  		page_id 
  -- 一个用户的一次浏览页面的行为是一条
  from dwd_page_log 
  lateral view explode(array(1,7,30)) tmp as recent_days
  --至少要取最近30天的页面浏览记录
  where dt > date_sub('2021-05-07',30)
  and dt > date_sub('2021-05-07',recent_days)
  --只过滤浏览首页和商品详情页的记录
  and page_id in ('home','good_detail')
  and user_id is not null
  GROUP by user_id , page_id ,recent_days ) t1
  GROUP by recent_days  ) t4
  on t3.recent_days=t4.recent_days
```



## 7.ads_user_retention

### 7.1 建表

```sql
DROP TABLE IF EXISTS ads_user_retention;
-- 求1-7日留存
CREATE EXTERNAL TABLE ads_user_retention (
  `dt` STRING COMMENT '统计日期',
  `create_date` STRING COMMENT '用户新增日期',
  `retention_day` BIGINT COMMENT '截至当前日期留存天数',
  `retention_count` BIGINT COMMENT '留存用户数量',
  `new_user_count` BIGINT COMMENT '新增用户数量',
  `retention_rate` DECIMAL(16,2) COMMENT '留存率'
) COMMENT '用户留存率'
ROW FORMAT DELIMITED  FIELDS TERMINATED BY '\t'
LOCATION '/warehouse/gmall/ads/ads_user_retention/';
```



create_date= date_sub(dt,retention_day)

| retention_day | create_date | 已有的数据的日器 dt |
| ------------- | ----------- | ------------------- |
| 1             | 2021-05-06  | 2021-05-07          |
| 2             | 2021-05-05  | 2021-05-07          |
| 3             | 2021-05-04  | 2021-05-07          |
| 4             | 2021-05-03  | 2021-05-07          |
| 5             | 2021-05-02  | 2021-05-07          |
| 6             | 2021-05-01  | 2021-05-07          |
| 7             | 2021-04-30  | 2021-05-07          |



用户留存：    指某天新增的这批新用户 ， 在距离新新增日期 N天后，依然活跃的用户，称为 N天的留存用户。

​			举例： 2021-05-03新增了100个用户，这些人，在举例 3天后，也就是5-6日，活跃了70人，这70人称为 留存了3天的留存用户。



数量关系：  如果想求 2021-05-10 这一天 留存了3日的用户留存率，

​					此时，需要有 2021-05-10当天用户活跃的记录，以及

​									（2021-05-10 -  3 ） 天用户新增的人数



留存率：    N日留存的人数

​						 2021-05-10当天活跃的且是（2021-05-10 -  3 ） 天新来的用户数  /  （2021-05-10 -  3 ） 天用户新增的人数

### 7.2 导入数据



如何求 某天新增的1日留存

```
  SELECT 
  		'2021-05-07' dt,
  		date_sub('2021-05-07',1) create_date,
  		1 retention_day,
  		sum(if(login_date_first = date_sub('2021-05-07',1) and 
  		login_date_last= '2021-05-07',1,0)) retention_count,
  		sum(if(login_date_first = date_sub('2021-05-07',1) ,1,0 )) new_user_count,
  		cast(sum(if(login_date_first = date_sub('2021-05-07',1) and 
  		login_date_last= '2021-05-07',1,0)) / sum(if(login_date_first = date_sub('2021-05-07',1) ,1,0 )) * 100 as DECIMAL(16,2)) retention_rate
  
  from dwt_user_topic 
  where dt='2021-05-07'
```





最终结果：

```sql
--求 1-7日的留存率，需要什么样的数据    需要dwt层截至到当前全部的活跃数据，再将今日的活跃数据，按照用户的新增日期进行分组
  -- 统计每个新增日期下，今日活跃的用户有多少人
  
  insert overwrite table ads_user_retention 
  select * from ads_user_retention
  union all
  SELECT 
  		'2021-05-07' dt,
  		login_date_first,
  		datediff('2021-05-07',login_date_first) retention_day,
  		sum(if(login_date_last= '2021-05-07',1,0)) retention_count,
  		count(*) new_user_count,
  		cast(sum(if(login_date_last= '2021-05-07',1,0)) / count(*) * 100 as DECIMAL(16,2)) retention_rate
   from dwt_user_topic 
    where dt='2021-05-07'
    --只求最近7日留存，如果有了2021-05-07日的活跃数据，统计的目标只是 date_sub('2021-05-07',7)日及之后新增的用户
    and login_date_first  >=  date_sub('2021-05-07',7)
    and login_date_first < '2021-05-07'
    GROUP by login_date_first
```



## 8.ads_order_spu_stats

### 8.1 建表

```sql
CREATE EXTERNAL TABLE `ads_order_spu_stats` (
    --dwt_sku_topic
    `dt` STRING COMMENT '统计日期',
    `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    -- dim_sku_info
    `spu_id` STRING COMMENT '商品ID',
    `spu_name` STRING COMMENT '商品名称',
    `tm_id` STRING COMMENT '品牌ID',
    `tm_name` STRING COMMENT '品牌名称',
    `category3_id` STRING COMMENT '三级品类ID',
    `category3_name` STRING COMMENT '三级品类名称',
    `category2_id` STRING COMMENT '二级品类ID',
    `category2_name` STRING COMMENT '二级品类名称',
    `category1_id` STRING COMMENT '一级品类ID',
    `category1_name` STRING COMMENT '一级品类名称',
    `order_count` BIGINT COMMENT '订单数',
    `order_amount` DECIMAL(16,2) COMMENT '订单金额'
) COMMENT '商品销售统计'
```



### 8.2 导入数据

```sql
INSERT overwrite table ads_order_spu_stats 
select * from ads_order_spu_stats 
union all
SELECT 
	'2021-05-07' ,
	recent_days,spu_id,spu_name,tm_id,tm_name,category3_id,category3_name,category2_id,
    category2_name,category1_id,category1_name,
    sum(order_count) order_count,
    sum(order_amount) order_amount
FROM 
(SELECT 
	sku_id ,recent_days,
	case recent_days
	when 1 then order_last_1d_count
	when 7 then order_last_7d_count
	when 30 then order_last_30d_count
	end
	order_count,
	
	case recent_days
	when 1 then order_last_1d_final_amount
	when 7 then order_last_7d_final_amount
	when 30 then order_last_30d_final_amount
	end
	order_amount

from dwt_sku_topic 
lateral view explode(array(1,7,30)) tmp as recent_days
where dt='2021-05-07'  ) t1
left join
(
select
	id,  spu_id,
    spu_name,
    tm_id,
    tm_name,
    category3_id,
    category3_name,
    category2_id,
    category2_name,
    category1_id,
    category1_name
from dim_sku_info 
where dt='2021-05-07'
) t2
on t1.sku_id = t2.id
group by recent_days,spu_id,spu_name,tm_id,tm_name,category3_id,category3_name,category2_id,
    category2_name,category1_id,category1_name
```



## 9.ads_repeat_purchase

### 9.1 建表

```sql
DROP TABLE IF EXISTS ads_repeat_purchase;
CREATE EXTERNAL TABLE `ads_repeat_purchase` (
  `dt` STRING COMMENT '统计日期',
  `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
    -- dwd_order_detail  left join dim_sku_info
  `tm_id` STRING COMMENT '品牌ID',
  `tm_name` STRING COMMENT '品牌名称',
  `order_repeat_rate` DECIMAL(16,2) COMMENT '复购率'
) COMMENT '品牌复购率'
ROW FORMAT DELIMITED  FIELDS TERMINATED BY '\t'
LOCATION '/warehouse/gmall/ads/ads_repeat_purchase/';
```

复购： 重复购买

复购率：  购买多次的人数  /  购买过的人数 * 100



举例： A商品，最近30天，一共有1000人买过，有600人买过一次以上，复购率为60%

### 9.2 导入数据

```
INSERT overwrite table ads_repeat_purchase 
select * from ads_repeat_purchase 
union all
select 
	'2021-05-07',
     recent_days,tm_id,tm_name,
     -- count(*) 购买过的人数
     cast(sum(if(buy_times >1 , 1,0)) / count(*)  * 100 as DECIMAL(16,2)) order_repeat_rate
from
(--求最近1天，7天，30天用户购买品牌的各多少次
select
		recent_days,tm_name,tm_id,user_id,
		count(DISTINCT order_id)  buy_times
from
(SELECT 
	sku_id,user_id ,recent_days,order_id 
from dwd_order_detail 
lateral view explode(array(1,7,30)) tmp as recent_days
where dt > date_sub('2021-05-07',30)
and dt > date_sub('2021-05-07',recent_days)
) t1
left JOIN 
(
	select
		id,tm_name,tm_id
	from dim_sku_info 
	where dt='2021-05-07'
) t2
on t1.sku_id=t2.id
GROUP by recent_days,tm_id,tm_name,user_id ) t3
GROUP by  recent_days,tm_id,tm_name

```



## 10.ads_order_total

### 10.1 建表

如果从dwd层取数据，侧写后需要过滤；

取所有人在1，7，30天的统计，从dwt层取数据，侧写后无需过滤

```sql
DROP TABLE IF EXISTS ads_order_total;
CREATE EXTERNAL TABLE `ads_order_total` (
  `dt` STRING COMMENT '统计日期',
  `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
  `order_count` BIGINT COMMENT '订单数',
  `order_amount` DECIMAL(16,2) COMMENT '订单金额',
  `order_user_count` BIGINT COMMENT '下单人数'
) COMMENT '订单统计'
ROW FORMAT DELIMITED  FIELDS TERMINATED BY '\t'
LOCATION '/warehouse/gmall/ads/ads_order_total/';
```

数据源： dwt_user_topic

order_count: 

求最近1天(当日的)的 订单数： sum( order_last_1d_count)

求最近7天的 订单数： sum( order_last_7d_count)

求最近30天的 订单数： sum( order_last_30d_count)



order_amount:

求最近1天(当日的)的 订单金额： sum( order_last_1d_final_amount)

求最近7天的 订单金额： sum( order_last_7d_final_amount)

求最近30天的 订单金额： sum( order_last_30d_final_amount)



order_user_count：

求最近1天(当日的)的 人数： sum(if( order_last_1d_final_amount > 0,1,0))

求最近7天的 订单人数： sum(if( order_last_7d_final_amount > 0,1,0))

求最近30天的 订单人数： sum(if( order_last_7d_final_amount > 0,1,0))

### 10.2 导入数据

```sql
INSERT overwrite table ads_order_total 
select * from ads_order_total 
union all
SELECT 
	'2021-05-07',
	recent_days,
	sum(order_count) order_count,
	sum(order_amount) order_amount,
	sum(if(order_amount > 0 ,1,0)) order_user_count
from
(SELECT 
		user_id ,
		recent_days,
		case recent_days
			when 1 then  order_last_1d_count
			when 7 then  order_last_7d_count
			when 30 then  order_last_30d_count
		end order_count,
		case recent_days
			when 1 then  order_last_1d_final_amount
			when 7 then  order_last_7d_final_amount
			when 30 then  order_last_30d_final_amount
		end order_amount
from dwt_user_topic 
lateral view explode(array(1,7,30)) tmp as recent_days
where dt='2021-05-07' ) t1
GROUP  by recent_days
```



## 11.ads_order_by_province

### 11.1 建表

```sql
CREATE EXTERNAL TABLE `ads_order_by_province` (
  `dt` STRING COMMENT '统计日期',
  `recent_days` BIGINT COMMENT '最近天数,1:最近1天,7:最近7天,30:最近30天',
  `province_id` STRING COMMENT '省份id',
  `province_name` STRING COMMENT '省份名称',
  `area_code` STRING COMMENT '地区编码',
  `iso_code` STRING COMMENT '国际标准地区编码',
  `iso_code_3166_2` STRING COMMENT '国际标准地区编码',
  `order_count` BIGINT COMMENT '订单数',
  `order_amount` DECIMAL(16,2) COMMENT '订单金额'
) COMMENT '用户留存率'
```



数据源： dwt_area_topic

### 11.2 导入数据

```
INSERT overwrite table ads_order_by_province 
select * from ads_order_by_province 
union all
select
	'2021-05-07',
	recent_days,
	t2.province_id,
	province_name,
	area_code,
	iso_code,
	iso_3166_2 iso_code_3166_2,
	order_count,
	order_amount
from
(SELECT 
    province_id,
	recent_days,
	sum(order_count) order_count,
	sum(order_amount) order_amount
from
(SELECT 
		 province_id,
		recent_days,
		case recent_days
			when 1 then  order_last_1d_count
			when 7 then  order_last_7d_count
			when 30 then  order_last_30d_count
		end order_count,
		case recent_days
			when 1 then  order_last_1d_final_amount
			when 7 then  order_last_7d_final_amount
			when 30 then  order_last_30d_final_amount
		end order_amount
from dwt_area_topic 
lateral view explode(array(1,7,30)) tmp as recent_days
where dt='2021-05-07' ) t1
GROUP  by recent_days,province_id ) t2
join
(
select
   id,province_name,area_code,iso_code,iso_3166_2

from dim_base_province 

) t3
on t2.province_id=t3.id




```



## 12. ads_coupon_stats

### 12.1 建表

统计最新30天，所有有效的优惠券的各种指标

```sql
CREATE EXTERNAL TABLE ads_coupon_stats (
  `dt` STRING COMMENT '统计日期',
    --dim_coupon_info 取维度信息
  `coupon_id` STRING COMMENT '优惠券ID',
  `coupon_name` STRING COMMENT '优惠券名称',
  `start_date` STRING COMMENT '发布日期',
  `rule_name` STRING COMMENT '优惠规则',
    
    --dwt_coupon_topic
  `get_count`  BIGINT COMMENT '领取次数',
  `order_count` BIGINT COMMENT '使用(下单)次数',
  `expire_count`  BIGINT COMMENT '过期次数',
  `order_original_amount` DECIMAL(16,2) COMMENT '使用优惠券订单原始金额',
  `order_final_amount` DECIMAL(16,2) COMMENT '使用优惠券订单最终金额',
  `reduce_amount` DECIMAL(16,2) COMMENT '优惠金额',
  `reduce_rate` DECIMAL(16,2) COMMENT '补贴率',
    
    -- dwd_order_detail  left join  dim_sku_info 取 spu_name和tm_name
  `spu_comment` STRING COMMENT '商品占比，按订单数统计，要求结果形式如下:iPhone X:30%,xiaomi 10:20%,iPhone 12:30%,其他:20%',
  `tm_comment` STRING COMMENT '品牌占比，按订单数统计，要求结果形式如下:Apple:30%,Xiaomi:20%,Huawei:30%,其他:20%'
) COMMENT '商品销售统计'
```



### 12.2 导入数据

```sql
INSERT overwrite table ads_coupon_stats 
select * from ads_coupon_stats 
union all
SELECT '2021-05-07' dt, 
coupon_info.id coupon_id, coupon_name, start_date, rule_name, get_count, order_count, 
expire_count, order_original_amount, order_final_amount, reduce_amount, reduce_rate, 
spu_comment, tm_comment
from
  (SELECT 
  		id,
  		coupon_name,
  		date_format(start_time,'yyyy-MM-dd') start_date,
  		case coupon_type 
  		   when '3201' then concat('满',condition_amount,'减',benefit_amount)
  		   when '3202' then concat('满',condition_num,'打',benefit_discount ,'折')
  		   when '3203' then concat('打',benefit_discount ,'折')
  		 end rule_name
  from dim_coupon_info 
  --只统计最近30天 优惠券在有效期的优惠券
  where dt='2021-05-07'
  and date_format(nvl(end_time,'9999-99-99') ,'yyyy-MM-dd') > date_sub('2021-05-07',30) ) coupon_info
  left join
(
  
  SELECT 
  		coupon_id ,
  		get_last_30d_count get_count,
  		order_last_30d_count order_count,
  		expire_last_30d_count expire_count,
  		 order_last_30d_original_amount order_original_amount,
  		 order_last_30d_final_amount order_final_amount,
  		 payment_last_30d_reduce_amount reduce_amount,
  		 cast(payment_last_30d_reduce_amount / order_last_30d_original_amount * 100 as DECIMAL(16,2)) reduce_rate
  		
  from dwt_coupon_topic 
  where dt='2021-05-07' ) coupon_stats
  on coupon_info.id = coupon_stats.coupon_id 
  left join
  (--求最近30天所有使用优惠券下单的商品详情
SELECT 
	coupon_id,
	getpercentstr(tm_name) tm_comment,
	getpercentstr(spu_name) spu_comment
from
(SELECT 
	sku_id,coupon_id

from dwd_order_detail 
where dt > date_sub('2021-05-07',30)
and coupon_id is not null ) t1
left JOIN 
(
	select
		id,tm_name,spu_name
	from dim_sku_info 
	where dt='2021-05-07'
) t2
on t1.sku_id=t2.id
group by coupon_id  ) t3
  on coupon_info.id = t3.coupon_id 

```





使用sql聚合：

```
  SELECT 
    		coupon_id,concat_ws(',',collect_set(str))
    from
	(SELECT 
				coupon_id ,tm_name,tm_count,rn,per,top3_per,
				if(rn <=3 , concat(tm_name ,':', per) , concat('其他:',round(100 - top3_per,2))) str
	from 
	(SELECT 
		--求每种券，排名前3的tm_name的用券占比总和
			coupon_id ,tm_name,tm_count,rn,per,
			sum(if(rn <=3,per,0)) over(PARTITION by coupon_id) top3_per
	
	FROM 
		(SELECT 
			--每个品牌，在每种优惠券中使用次数排名，和比例
			coupon_id ,tm_name,tm_count,
			ROW_NUMBER() over(PARTITION by coupon_id order by tm_count desc)  rn,
			round(tm_count / sum(tm_count) over(PARTITION by coupon_id) * 100 ,2) per
			
		from

			(SELECT 
				--统计每种优惠券，每个品牌用券次数
			   coupon_id ,tm_name ,count(*) tm_count
			from mytest 
			group by coupon_id ,tm_name  ) t1  ) t2  ) t3  ) t4
			group by coupon_id
```







## 13.ads_activity_stats

### 13.1 建表

最近30天有效的活动

````sql
DROP TABLE IF EXISTS ads_activity_stats;
CREATE EXTERNAL TABLE `ads_activity_stats` (
    -- dim_acitivity_info
  `dt` STRING COMMENT '统计日期',
  `activity_id` STRING COMMENT '活动ID',
  `activity_name` STRING COMMENT '活动名称',
  `start_date` STRING COMMENT '活动开始日期',
    -- dwt_activity_topic
  `order_count` BIGINT COMMENT '参与活动订单数',
  `order_original_amount` DECIMAL(16,2) COMMENT '参与活动订单原始金额',
  `order_final_amount` DECIMAL(16,2) COMMENT '参与活动订单最终金额',
  `reduce_amount` DECIMAL(16,2) COMMENT '优惠金额',
  `reduce_rate` DECIMAL(16,2) COMMENT '补贴率',
    -- dwd_order_detail left join  dim_sku_info
  `rule_comment` STRING COMMENT '订单规则占比，按订单数统计，要求结果形式如下：满100减10：19.5%，满200减30：80.5%',
    -- dwd_order_detail left join  dim_sku_info
  `spu_comment` STRING COMMENT '商品占比，按订单数统计，要求结果形式如下:iPhone X:30%,xiaomi 10:20%,iPhone 12:30%,其他:20%',
  `tm_comment` STRING COMMENT '品牌占比，按订单数统计，要求结果形式如下:Apple:30%,Xiaomi:20%,Huawei:30%,其他:20%'
) COMMENT '商品销售统计'
ROW FORMAT DELIMITED  FIELDS TERMINATED BY '\t'
LOCATION '/warehouse/gmall/ads/ads_activity_stats/';
````



### 13.2 导入数据

```sql
INSERT overwrite table ads_activity_stats 
select * from ads_activity_stats 
union all
SELECT 
	'2021-05-07' dt, t4.activity_id, activity_name, start_date, order_count,
	order_original_amount, order_final_amount, reduce_amount, 
	reduce_rate, rule_comment, spu_comment, tm_comment
   

from
(
  
  SELECT 
  		activity_id ,
  		count(DISTINCT order_id) order_count,
  		sum(original_amount) order_original_amount,
  		sum(split_final_amount) order_final_amount,
  		 sum(split_activity_amount) reduce_amount,
  		 cast( sum(split_activity_amount)  / sum(original_amount) * 100 as DECIMAL(16,2)) reduce_rate
  from dwd_order_detail 
  where dt >date_sub('2021-05-07',30) and activity_id is not null
  group  by activity_id) t4
  left join
  (--求最近30天所有使用优惠券下单的商品详情
SELECT 
	t1.activity_id ,activity_name,start_date,
	getpercentstr(tm_name) tm_comment,
	getpercentstr(spu_name) spu_comment,
	getpercentstr(rule_name) rule_comment
from
(SELECT 
	sku_id,activity_id ,activity_rule_id 
from dwd_order_detail 
where dt > date_sub('2021-05-07',30)
and activity_id is not null ) t1
left JOIN 
(
	select
		id,tm_name,spu_name
	from dim_sku_info 
	where dt='2021-05-07'
) t2
on t1.sku_id=t2.id
left join
(SELECT 
  		activity_rule_id,activity_id,
  		activity_name,
  		date_format(start_time,'yyyy-MM-dd') start_date,
  		case activity_type 
  		   when '3101' then concat('满',condition_amount,'减',benefit_amount)
  		   when '3102' then concat('满',condition_num,'打',benefit_discount ,'折')
  		   when '3103' then concat('打',benefit_discount ,'折')
  		 end rule_name
  from dim_activity_rule_info 
  --只统计最近30天 优惠券在有效期的优惠券
  where dt='2021-05-07'
 --and date_format(nvl(end_time,'9999-99-99') ,'yyyy-MM-dd') > date_sub('2021-05-07',30) 
  ) activity_info
on activity_info.activity_rule_id = t1.activity_rule_id and t1.activity_id=activity_info.activity_id
group by t1.activity_id ,activity_name,start_date

) t3
on t4.activity_id = t3.activity_id 

```



# 七、脚本

## 1.脚本的调用

| 层        | 首日                  | 每日               | 参数                                     | 示例                               |
| --------- | --------------------- | ------------------ | ---------------------------------------- | ---------------------------------- |
| ods层 log | hdfs_to_ods_log.sh    |                    | 第一个参数为日期                         | hdfs_to_ods_log.sh 2021-05-07      |
|           |                       | hdfs_to_ods_log.sh | 第一个参数为日期                         | hdfs_to_ods_log.sh 2021-05-08      |
| ods层db   | hdfs_to_ods_db.sh     |                    |                                          | hdfs_to_ods_db.sh 2021-05-07       |
|           |                       | hdfs_to_ods_db.sh  | 第一个参数为日期                         | hdfs_to_ods_db.sh 2021-05-08       |
| dim层     | ods_to_dim.sh         |                    | 第一个参数为日期，第二个参数为每日或首日 | ods_to_dim.sh 2021-05-07 first_day |
|           |                       | ods_to_dim.sh      | 第一个参数为日期，第二个参数为每日或首日 | ods_to_dim.sh 2021-05-08 other     |
| dwd层log  | ods_to_dwd_log.sh     | ods_to_dwd_log.sh  | 第一个参数为日期                         | ods_to_dwd_log.sh 2021-05-07       |
| dwd层db   | ods_to_dwd_db_init.sh |                    | 第一个参数为日期                         | ods_to_dwd_db_init.sh 2021-05-07   |
|           |                       | ods_to_dwd_db.sh   | 第一个参数为日期                         | ods_to_dwd_db.sh 2021-05-08        |
| dws层     | dwd_to_dws_init.sh    |                    | 第一个参数为日期                         | dwd_to_dws_init.sh 2021-05-07      |
|           |                       | dwd_to_dws.sh      | 第一个参数为日期                         | dwd_to_dws.sh 2021-05-08           |
| dwt层     | dws_to_dwt_init.sh    |                    | 第一个参数为日期                         | dws_to_dwt_init.sh 2021-05-07      |
|           |                       | dws_to_dwt.sh      | 第一个参数为日期                         | dws_to_dwt.sh 2021-05-08           |
| ads层     | dwt_to_ads.sh         |                    | 第一个参数为日期                         | dwt_to_ads.sh 2021-05-07           |
| 导出      | hdfs_to_mysql_new.sh  |                    | 第一个参数是表名                         | hdfs_to_mysql_new.sh all           |



## 2.dwt层脚本修改

在每日脚本中，在导入数据完成后，需要产生2天前过期分区的元数据和数据。





## 3.dwd层累积型快照事实表脚本的每日处理

假设当前dwd_payment_info 有以下数据

/dwd_payment_info/dt=2021-05-03       1001,callback_time=2021-05-03 01:00:00



/dwd_payment_info/dt=9999-99-99       1002,callback_time=null

full  join

/ods_payment_info/ dt=2021-05-08     1002,callback_time=2021-05-08 01:00:00

/ods_payment_info/ dt=2021-05-08     1003,callback_time=2021-05-08 01:00:00





full join之后的结果：

insert overwrite table dwd_payment_info partition(dt)

/dwd_payment_info/dt=2021-05-08      1002,callback_time=2021-05-08 01:00:00

/dwd_payment_info/dt=2021-05-08       1003,callback_time=2021-05-08 01:00:00



现象：如果dt=9999-99-99分区的数据，全部在今日完成，那么这些数据都需要覆写如到今日的分区，此时

dt=9999-99-99不会产生覆写，此时同一条数据，有可能会出现两条，既在当日完成的分区，又在dt=9999-99-99分区



解决：  通过dt=9999-99-99分区的修改时间，是否在今天发生修改，如果没有发生修改，手动删除！



## 4.azakaban调度之前

日期和地区特殊维度，需要手动处理：

```
load data inpath '/date_info.txt' overwrite into table tmp_dim_date_info;

insert overwrite table dim_date_info select * from tmp_dim_date_info ;


load data inpath '/origin_data/gmall/db/base_province/2021-05-07' OVERWRITE into table ods_base_province;
load data inpath '/origin_data/gmall/db/base_region/2021-05-07' OVERWRITE into table ods_base_region;


```



# 八、Hive定义UDAF

# 1.必要的步骤

①编写[ resolver](https://cwiki.apache.org/confluence/display/Hive/GenericUDAFCaseStudy#GenericUDAFCaseStudy-Writingtheresolver)

②编写[Writing the evaluator](https://cwiki.apache.org/confluence/display/Hive/GenericUDAFCaseStudy#GenericUDAFCaseStudy-Writingtheevaluator)